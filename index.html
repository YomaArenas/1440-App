<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1440 - Cada minuto cuenta</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #050b1f;
            --bg2: #0a1532;
            --bg3: #0f1f45;
            --cyan: #00ffff;
            --blue: #0066ff;
            --success: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;
            --sleep: #6366f1;
            --text: #ffffff;
            --text2: #99b3d9;
            --text3: #5580b3;
            --border: #1a3366;
            --header-h: 64px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(0,255,255,.06) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0,102,255,.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* ‚îÄ‚îÄ‚îÄ FIXED HEADER ‚îÄ‚îÄ‚îÄ */
        .app-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-h);
            background: rgba(5,11,31,.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 500;
        }

        /* Logo SVG ‚Äî no background */
        .logo-svg {
            display: flex;
            align-items: center;
            gap: .75rem;
        }

        .logo-text {
            font-family: 'Space Mono', monospace;
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--cyan), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: .05em;
            line-height: 1;
        }

        /* The dot-toggle "0" in 1440 */
        .logo-mark {
            position: relative;
            display: inline-block;
        }
        .logo-mark::after {
            content: '';
            position: absolute;
            width: 6px; height: 6px;
            background: var(--cyan);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--cyan);
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Compact active timer in header */
        .header-timer {
            display: none;
            align-items: center;
            gap: .75rem;
            background: rgba(0,255,255,.08);
            border: 1px solid rgba(0,255,255,.3);
            border-radius: 10px;
            padding: .4rem 1rem;
        }

        .header-timer.visible { display: flex; }

        .header-timer-dot {
            width: 8px; height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--success);
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%,100% { opacity:1; } 50% { opacity:.3; }
        }

        .header-timer-name {
            font-size: .85rem;
            font-weight: 600;
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-timer-time {
            font-family: 'Space Mono', monospace;
            font-size: .9rem;
            color: var(--cyan);
        }

        .header-actions { display: flex; gap: .6rem; align-items: center; }

        /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: calc(var(--header-h) + 1.5rem) 2rem 4rem;
            position: relative;
            z-index: 1;
        }

        /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
        .btn {
            background: linear-gradient(135deg, var(--cyan), var(--blue));
            color: var(--bg);
            border: none; border-radius: 10px;
            padding: .75rem 1.4rem;
            font-family: inherit; font-size: .9rem; font-weight: 700;
            cursor: pointer; transition: all .25s ease;
            display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
            text-transform: uppercase; letter-spacing: .03em;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); }
        .btn-sm { padding: .5rem .9rem; font-size: .8rem; }
        .btn-full { width: 100%; }
        .btn-success { background: linear-gradient(135deg, var(--success), #00cc70); color: #000; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #cc0044); color: #fff; }
        .btn-ghost { background: transparent; color: var(--cyan); border: 2px solid var(--border); }
        .btn-ghost:hover { border-color: var(--cyan); }

        /* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
        .card {
            background: var(--bg2);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
        }

        /* ‚îÄ‚îÄ‚îÄ PROGRESS BAR 1440 ‚îÄ‚îÄ‚îÄ */
        .progress-1440 {
            margin-bottom: 1.25rem;
        }

        .progress-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: .6rem;
            font-size: .9rem;
        }

        .progress-top strong {
            color: var(--cyan);
            font-family: 'Space Mono', monospace;
        }

        .progress-track {
            height: 14px;
            background: var(--bg3);
            border-radius: 7px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--blue));
            border-radius: 7px;
            transition: width .5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
            animation: shim 2s linear infinite;
        }

        @keyframes shim { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

        /* ‚îÄ‚îÄ‚îÄ QUICK TRACK ‚îÄ‚îÄ‚îÄ */
        .quick-track { margin-bottom: 1.25rem; }

        .section-title {
            font-size: .8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .1em;
            color: var(--text3);
            margin-bottom: 1rem;
        }

        .qt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: .75rem;
        }

        .qt-item {
            background: var(--bg3);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: .9rem 1rem;
            cursor: pointer;
            transition: all .25s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .qt-item:hover { border-color: var(--cyan); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,255,255,.15); }
        .qt-item.running { border-color: var(--success); background: rgba(0,255,136,.08); }

        .qt-label { font-weight: 600; font-size: .95rem; }
        .qt-sub { font-size: .8rem; color: var(--text2); font-family: 'Space Mono', monospace; }
        .qt-play {
            width: 34px; height: 34px;
            background: linear-gradient(135deg, var(--cyan), var(--blue));
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: var(--bg); font-weight: 700;
            flex-shrink: 0;
        }

        .qt-empty {
            grid-column: 1/-1;
            padding: 2rem;
            text-align: center;
            color: var(--text3);
            font-size: .9rem;
        }

        /* ‚îÄ‚îÄ‚îÄ ACTIVE TIMER BANNER ‚îÄ‚îÄ‚îÄ */
        .timer-banner {
            background: linear-gradient(135deg, rgba(0,255,255,.08), rgba(0,102,255,.08));
            border: 2px solid var(--cyan);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.25rem;
            display: none;
        }
        .timer-banner.visible { display: block; }

        .tb-top { display: flex; align-items: center; gap: .75rem; margin-bottom: .75rem; }
        .tb-dot { width: 12px; height: 12px; background: var(--success); border-radius: 50%; box-shadow: 0 0 12px var(--success); animation: blink 1.5s ease-in-out infinite; }
        .tb-label { font-size: .8rem; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; color: var(--success); }
        .tb-name { font-size: 1.3rem; font-weight: 700; }
        .tb-meta { font-size: .85rem; color: var(--text2); margin-top: .1rem; }
        .tb-time { font-family: 'Space Mono', monospace; font-size: 2.8rem; font-weight: 700; text-align: center; background: linear-gradient(135deg, var(--cyan), var(--success)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: .5rem 0; }
        .tb-actions { display: flex; gap: .75rem; }
        .tb-actions .btn { flex: 1; }

        /* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
        .tabs { display: flex; gap: .5rem; margin-bottom: 1.5rem; overflow-x: auto; padding-bottom: .25rem; }

        .tab {
            background: transparent;
            color: var(--text2);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: .7rem 1.25rem;
            cursor: pointer;
            transition: all .25s ease;
            font-weight: 600; font-size: .9rem;
            white-space: nowrap;
            font-family: inherit;
        }

        .tab:hover { color: var(--cyan); background: var(--bg2); }
        .tab.active { color: var(--cyan); border-color: var(--cyan); background: rgba(0,255,255,.08); }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ‚îÄ */
        .timeline-wrap { overflow-y: auto; max-height: 70vh; }

        .tl-row {
            display: grid;
            grid-template-columns: 52px 1fr;
            min-height: 80px;
            border-bottom: 1px solid rgba(26,51,102,.5);
            position: relative;
        }

        .tl-label {
            padding: .5rem .5rem 0 0;
            font-size: .75rem;
            color: var(--text3);
            font-family: 'Space Mono', monospace;
            text-align: right;
            position: sticky;
        }

        .tl-col { position: relative; padding: 2px 4px; }

        .tl-entry {
            border-radius: 6px;
            padding: .4rem .6rem;
            font-size: .82rem;
            font-weight: 600;
            margin-bottom: 3px;
            cursor: pointer;
            transition: filter .2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tl-entry:hover { filter: brightness(1.2); }
        .tl-entry.tracked { background: rgba(0,255,255,.15); border-left: 3px solid var(--cyan); color: var(--cyan); }
        .tl-entry.sleep { background: rgba(99,102,241,.2); border-left: 3px solid var(--sleep); color: #a5b4fc; }
        .tl-entry.gap { background: rgba(55,65,81,.3); border-left: 3px dashed #4b5563; color: var(--text3); font-weight: 400; cursor: default; }

        .tl-add {
            position: absolute;
            right: 6px; top: 4px;
            background: transparent;
            border: 1px dashed var(--border);
            color: var(--text3);
            border-radius: 6px;
            padding: .2rem .5rem;
            font-size: .75rem;
            cursor: pointer;
            transition: all .2s;
            font-family: inherit;
        }

        .tl-add:hover { border-color: var(--cyan); color: var(--cyan); }

        /* ‚îÄ‚îÄ‚îÄ AREAS & PROJECTS ‚îÄ‚îÄ‚îÄ */
        .section-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: .75rem; }

        .area-block { margin-bottom: 1.75rem; }

        .area-head {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg2); border: 2px solid var(--border);
            border-radius: 12px; padding: .9rem 1.25rem;
            margin-bottom: .75rem;
        }

        .area-head-left { display: flex; align-items: center; gap: .75rem; font-size: 1.1rem; font-weight: 700; }
        .area-time { font-family: 'Space Mono', monospace; color: var(--cyan); font-size: .9rem; }

        .proj-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; padding-left: 1.5rem; }

        .proj-card {
            background: var(--bg2); border: 2px solid var(--border);
            border-radius: 14px; padding: 1.25rem;
            transition: all .25s ease;
        }

        .proj-card:hover { border-color: var(--cyan); transform: translateY(-2px); }

        .proj-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: .75rem; }
        .proj-dot { width: 12px; height: 12px; border-radius: 50%; }
        .proj-name { font-weight: 700; font-size: 1rem; }
        .proj-stat { display: flex; justify-content: space-between; font-size: .85rem; padding-top: .75rem; border-top: 1px solid var(--border); }
        .proj-stat span:last-child { font-family: 'Space Mono', monospace; color: var(--cyan); font-weight: 700; }

        .icon-btn {
            width: 32px; height: 32px;
            background: var(--bg3); border: 1px solid var(--border);
            border-radius: 7px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all .2s; font-size: .9rem;
            color: var(--text2);
        }
        .icon-btn:hover { border-color: var(--danger); color: var(--danger); }

        /* ‚îÄ‚îÄ‚îÄ ENTRIES LIST ‚îÄ‚îÄ‚îÄ */
        .entries-list { display: flex; flex-direction: column; gap: .75rem; }

        .entry-card {
            background: var(--bg2); border: 2px solid var(--border);
            border-radius: 14px; padding: 1.1rem 1.25rem;
            display: grid; grid-template-columns: 85px 1fr auto;
            gap: 1rem; align-items: center;
            transition: all .25s ease;
        }

        .entry-card:hover { border-color: var(--cyan); transform: translateY(-1px); }
        .entry-dur { font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; color: var(--cyan); }
        .entry-desc { font-weight: 600; margin-bottom: .25rem; }
        .entry-meta { font-size: .82rem; color: var(--text2); display: flex; gap: .75rem; flex-wrap: wrap; }
        .badge { padding: .2rem .6rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 5px; font-size: .78rem; }
        .badge.sleep-badge { border-color: var(--sleep); color: #a5b4fc; }
        .entry-actions { display: flex; gap: .4rem; }

        /* ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; margin-bottom: 1.5rem; }

        .dash-card { border-radius: 16px; padding: 1.5rem; background: var(--bg2); border: 2px solid var(--border); }
        .dash-card h3 { font-size: .8rem; text-transform: uppercase; letter-spacing: .08em; color: var(--text2); margin-bottom: 1rem; }
        .dash-val { font-family: 'Space Mono', monospace; font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, var(--cyan), var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .dash-sub { font-size: .85rem; color: var(--text3); margin-top: .25rem; }

        .pie-wrap { position: relative; width: 180px; height: 180px; margin: .75rem auto; }
        .pie-svg { width: 100%; height: 100%; }
        .pie-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; }
        .pie-center-val { font-family: 'Space Mono', monospace; font-size: 1.4rem; font-weight: 700; color: var(--cyan); }
        .pie-center-sub { font-size: .75rem; color: var(--text3); }

        .legend-item { display: flex; align-items: center; gap: .6rem; margin-bottom: .4rem; font-size: .85rem; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
        .legend-val { margin-left: auto; font-family: 'Space Mono', monospace; font-size: .8rem; color: var(--cyan); }

        /* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
        .overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(5,11,31,.92); backdrop-filter: blur(8px);
            z-index: 900; align-items: center; justify-content: center; padding: 1rem;
        }
        .overlay.open { display: flex; }

        .modal {
            background: var(--bg2); border: 2px solid var(--border);
            border-radius: 20px; padding: 2rem;
            max-width: 500px; width: 100%; max-height: 92vh; overflow-y: auto;
        }

        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-head h2 { font-size: 1.4rem; font-weight: 700; }
        .modal-close { width: 32px; height: 32px; background: var(--bg3); border: 1px solid var(--border); border-radius: 7px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text2); font-size: 1.2rem; transition: all .2s; }
        .modal-close:hover { border-color: var(--cyan); color: var(--cyan); }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-size: .85rem; font-weight: 600; color: var(--text2); margin-bottom: .5rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; background: var(--bg3); border: 2px solid var(--border);
            border-radius: 10px; padding: .8rem 1rem; color: var(--text);
            font-family: inherit; font-size: .95rem; transition: all .25s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--cyan); box-shadow: 0 0 0 3px rgba(0,255,255,.1); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        input[type="color"] { height: 44px; cursor: pointer; }
        input[type="time"] { font-family: 'Space Mono', monospace; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .modal-actions { display: flex; gap: .75rem; margin-top: 1.5rem; }
        .modal-actions .btn { flex: 1; }

        /* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
        .login-screen {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; z-index: 1000;
        }

        .login-box {
            background: var(--bg2); border: 2px solid var(--border);
            border-radius: 20px; padding: 2rem;
            max-width: 400px; width: 100%;
            box-shadow: 0 0 60px rgba(0,255,255,.08);
        }

        .login-logo { text-align: center; margin-bottom: 1.5rem; }

        .login-logo-title {
            font-family: 'Space Mono', monospace;
            font-size: 3rem; font-weight: 700;
            background: linear-gradient(135deg, var(--cyan), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
            position: relative;
            display: inline-block;
        }

        .login-logo-sub { color: var(--text2); font-size: .85rem; margin-top: .5rem; }

        .login-tabs { display: flex; gap: .4rem; background: var(--bg3); padding: .35rem; border-radius: 10px; margin-bottom: 1.5rem; }
        .login-tab { flex: 1; background: transparent; border: none; border-radius: 8px; padding: .65rem; cursor: pointer; font-family: inherit; font-weight: 600; font-size: .9rem; color: var(--text2); transition: all .25s; }
        .login-tab.active { background: linear-gradient(135deg, var(--cyan), var(--blue)); color: var(--bg); }

        .login-form { display: none; }
        .login-form.active { display: block; }

        .pin-row { display: flex; gap: .6rem; justify-content: center; margin: 1.25rem 0; }
        .pin-d {
            width: 52px; height: 60px;
            background: var(--bg3); border: 2px solid var(--border);
            border-radius: 10px; color: var(--cyan);
            font-size: 1.6rem; font-weight: 700; text-align: center;
            font-family: 'Space Mono', monospace; transition: all .25s;
        }
        .pin-d:focus { outline: none; border-color: var(--cyan); transform: scale(1.05); }

        .info-box { background: rgba(0,255,255,.04); border-left: 3px solid var(--cyan); padding: .9rem 1rem; border-radius: 8px; margin: 1rem 0; font-size: .85rem; color: var(--text2); }
        .info-box.warn { border-left-color: var(--warning); }
        .info-box strong { display: block; margin-bottom: .3rem; color: var(--cyan); }
        .info-box.warn strong { color: var(--warning); }

        .msg { padding: .8rem; border-radius: 8px; margin: .75rem 0; text-align: center; font-weight: 600; font-size: .88rem; }
        .msg.err { background: rgba(255,51,102,.1); border: 2px solid var(--danger); color: var(--danger); }
        .msg.ok { background: rgba(0,255,136,.1); border: 2px solid var(--success); color: var(--success); }
        .hidden { display: none !important; }

        .spin { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.3); border-top-color: currentColor; border-radius: 50%; animation: spinA .7s linear infinite; }
        @keyframes spinA { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ SLEEP SETUP ‚îÄ‚îÄ‚îÄ */
        .sleep-setup { display: none; position: fixed; inset: 0; background: rgba(5,11,31,.96); backdrop-filter: blur(8px); z-index: 1100; align-items: center; justify-content: center; padding: 1rem; }
        .sleep-setup.open { display: flex; }

        /* ‚îÄ‚îÄ‚îÄ SLEEP POPUP ‚îÄ‚îÄ‚îÄ */
        .sleep-popup { display: none; position: fixed; bottom: 2rem; right: 2rem; background: var(--bg2); border: 2px solid var(--sleep); border-radius: 16px; padding: 1.5rem; max-width: 340px; width: 100%; z-index: 600; box-shadow: 0 8px 32px rgba(99,102,241,.3); }
        .sleep-popup.open { display: block; animation: slideUp .4s ease; }
        @keyframes slideUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

        /* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
        .empty { text-align: center; padding: 3rem 1rem; color: var(--text3); }
        .empty-icon { font-size: 3rem; opacity: .3; margin-bottom: .75rem; }
        .empty h3 { font-size: 1.1rem; color: var(--text); margin-bottom: .4rem; }

        /* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--blue); border-radius: 3px; }

        @media (max-width: 768px) {
            .main { padding: calc(var(--header-h) + 1rem) 1rem 4rem; }
            .app-header { padding: 0 1rem; }
            .tb-time { font-size: 2rem; }
            .entry-card { grid-template-columns: 1fr; }
            .proj-grid { grid-template-columns: 1fr; }
            .dash-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <div class="login-logo">
            <div class="login-logo-title">1<span class="logo-mark">4</span>4<span class="logo-mark">0</span></div>
            <div class="login-logo-sub">Cada minuto cuenta</div>
        </div>

        <div class="login-tabs">
            <button class="login-tab active" onclick="switchTab_login('login')">Ingresar</button>
            <button class="login-tab" onclick="switchTab_login('register')">Crear Cuenta</button>
        </div>

        <div class="login-form active" id="lf-login">
            <div class="info-box"><strong>üîí Tu PIN de 4 d√≠gitos</strong>Solo t√∫ lo conoces</div>
            <div class="pin-row">
                <input type="password" maxlength="1" class="pin-d" id="lp1" oninput="pinFocus(this,'lp2')">
                <input type="password" maxlength="1" class="pin-d" id="lp2" oninput="pinFocus(this,'lp3')">
                <input type="password" maxlength="1" class="pin-d" id="lp3" oninput="pinFocus(this,'lp4')">
                <input type="password" maxlength="1" class="pin-d" id="lp4" oninput="autoLogin()">
            </div>
            <div id="loginErr" class="msg err hidden"></div>
            <button class="btn btn-full" onclick="doLogin()">
                <span id="lBtnTxt">Ingresar</span><span id="lBtnSpin" class="spin hidden"></span>
            </button>
        </div>

        <div class="login-form" id="lf-register">
            <div class="info-box"><strong>üöÄ Elige tu PIN</strong>4 d√≠gitos que no olvides</div>
            <div class="pin-row">
                <input type="password" maxlength="1" class="pin-d" id="rp1" oninput="pinFocus(this,'rp2')">
                <input type="password" maxlength="1" class="pin-d" id="rp2" oninput="pinFocus(this,'rp3')">
                <input type="password" maxlength="1" class="pin-d" id="rp3" oninput="pinFocus(this,'rp4')">
                <input type="password" maxlength="1" class="pin-d" id="rp4">
            </div>
            <div class="info-box warn"><strong>‚ö†Ô∏è Recuerda tu PIN</strong>No hay recuperaci√≥n ¬∑ Sync en la nube ¬∑ Multi-dispositivo</div>
            <div id="regErr" class="msg err hidden"></div>
            <div id="regOk" class="msg ok hidden"></div>
            <button class="btn btn-success btn-full" onclick="doRegister()">
                <span id="rBtnTxt">Crear Cuenta</span><span id="rBtnSpin" class="spin hidden"></span>
            </button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SLEEP SETUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sleep-setup" id="sleepSetup">
    <div class="modal" style="max-width:460px">
        <div style="text-align:center;margin-bottom:1.5rem">
            <div style="font-size:3rem;margin-bottom:.5rem">üò¥</div>
            <h2 style="font-size:1.5rem;background:linear-gradient(135deg,var(--cyan),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Configura tu Sue√±o</h2>
            <p style="color:var(--text2);margin-top:.5rem;font-size:.9rem">Configuralo una vez y 1440 lo registra autom√°ticamente cada d√≠a</p>
        </div>
        <div class="row-2">
            <div class="form-group"><label>üåô Me duermo a:</label><input type="time" id="setupSleepTime" value="22:30"></div>
            <div class="form-group"><label>‚òÄÔ∏è Me despierto a:</label><input type="time" id="setupWakeTime" value="07:00"></div>
        </div>
        <div class="info-box"><strong>üí° C√≥mo funciona</strong>Si sigues tu rutina = registro autom√°tico. Si cambias = te preguntamos.</div>
        <button class="btn btn-success btn-full" onclick="saveSleepSetup()">Guardar Rutina</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SLEEP POPUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="sleep-popup" id="sleepPopup">
    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1rem">
        <span style="font-size:1.5rem">üò¥</span>
        <div>
            <div style="font-weight:700">¬øC√≥mo dormiste anoche?</div>
            <div style="font-size:.82rem;color:var(--text2)">Detectamos un cambio en tu rutina</div>
        </div>
    </div>
    <div class="row-2" style="margin-bottom:1rem">
        <div class="form-group"><label>Dorm√≠ a:</label><input type="time" id="popupSleepTime"></div>
        <div class="form-group"><label>Despert√© a:</label><input type="time" id="popupWakeTime"></div>
    </div>
    <div style="display:flex;gap:.5rem">
        <button class="btn btn-success btn-full btn-sm" onclick="saveSleepPopup()">Guardar</button>
        <button class="btn btn-ghost btn-sm" onclick="closeSleepPopup()">Ignorar</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="app-header" id="appHeader" style="display:none">
    <div class="logo-svg">
        <div class="logo-text">1<span class="logo-mark">4</span>4<span class="logo-mark">0</span></div>
    </div>

    <div class="header-timer" id="headerTimer">
        <div class="header-timer-dot"></div>
        <div class="header-timer-name" id="headerTimerName">Tarea</div>
        <div class="header-timer-time" id="headerTimerTime">00:00:00</div>
        <button class="btn btn-danger btn-sm" onclick="stopTimer()" style="padding:.3rem .7rem;font-size:.75rem">‚èπ</button>
    </div>

    <div class="header-actions">
        <button class="btn btn-ghost btn-sm" onclick="openModal('manualModal')">‚ûï Manual</button>
        <button class="btn btn-ghost btn-sm" onclick="exportCSV()">üìä CSV</button>
        <button class="btn btn-ghost btn-sm" onclick="exportPDF()">üìÑ PDF</button>
        <button class="btn btn-danger btn-sm" onclick="doLogout()">üö™ Salir</button>
    </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main class="main" id="mainApp" style="display:none">

    <!-- Progress 1440 -->
    <div class="card progress-1440">
        <div class="progress-top">
            <span>Hoy: <strong id="progMin">0</strong> / 1440 min registrados</span>
            <span id="progPct" style="color:var(--text2)">0%</span>
        </div>
        <div class="progress-track"><div class="progress-fill" id="progBar" style="width:0%"></div></div>
    </div>

    <!-- Active Timer Banner (full, above fold) -->
    <div class="timer-banner" id="timerBanner">
        <div class="tb-top">
            <div class="tb-dot"></div>
            <div class="tb-label">Tracking ahora</div>
        </div>
        <div class="tb-name" id="tbName">‚Äî</div>
        <div class="tb-meta" id="tbMeta">‚Äî</div>
        <div class="tb-time" id="tbTime">00:00:00</div>
        <div class="tb-actions">
            <button class="btn btn-danger" onclick="stopTimer()">‚èπ Detener</button>
            <button class="btn btn-ghost" onclick="openManualQuickSwitch()">üîÑ Cambiar</button>
        </div>
    </div>

    <!-- Quick Track -->
    <div class="card quick-track">
        <div class="section-title">‚ö° Quick Track ‚Äî 1 click</div>
        <div class="qt-grid" id="qtGrid"></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="goTab('timeline',this)">üìÖ Timeline</button>
        <button class="tab" onclick="goTab('areas',this)">üìÅ √Åreas</button>
        <button class="tab" onclick="goTab('entries',this)">üìã Entradas</button>
        <button class="tab" onclick="goTab('dashboard',this)">üìä Dashboard</button>
    </div>

    <!-- TIMELINE TAB -->
    <div class="tab-pane active" id="tab-timeline">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
                <h3 id="timelineDate" style="font-size:1.1rem">Hoy</h3>
                <div style="display:flex;gap:.5rem">
                    <input type="date" id="tlDatePicker" onchange="renderTimeline()" style="background:var(--bg3);border:2px solid var(--border);border-radius:8px;padding:.4rem .7rem;color:var(--text);font-family:inherit;font-size:.85rem">
                </div>
            </div>
            <div class="timeline-wrap" id="timelineWrap"></div>
        </div>
    </div>

    <!-- AREAS TAB -->
    <div class="tab-pane" id="tab-areas">
        <div class="section-bar">
            <h2>√Åreas de Vida</h2>
            <div style="display:flex;gap:.5rem">
                <button class="btn btn-ghost btn-sm" onclick="openModal('areaModal')">‚ûï √Årea</button>
                <button class="btn btn-sm" onclick="openModal('projectModal')">‚ûï Proyecto</button>
            </div>
        </div>
        <div id="areasContainer"></div>
    </div>

    <!-- ENTRIES TAB -->
    <div class="tab-pane" id="tab-entries">
        <div class="section-bar">
            <h2>Registro de Tiempo</h2>
            <div style="display:flex;gap:.5rem;flex-wrap:wrap">
                <select id="filterArea" onchange="renderEntries()" style="background:var(--bg3);border:2px solid var(--border);border-radius:8px;padding:.4rem .7rem;color:var(--text);font-family:inherit;font-size:.85rem">
                    <option value="">Todas las √°reas</option>
                </select>
                <select id="filterPeriod" onchange="renderEntries()" style="background:var(--bg3);border:2px solid var(--border);border-radius:8px;padding:.4rem .7rem;color:var(--text);font-family:inherit;font-size:.85rem">
                    <option value="today">Hoy</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                    <option value="all">Todo</option>
                </select>
            </div>
        </div>
        <div class="entries-list" id="entriesList"></div>
    </div>

    <!-- DASHBOARD TAB -->
    <div class="tab-pane" id="tab-dashboard">
        <h2 style="margin-bottom:1.25rem">Dashboard</h2>
        <div class="dash-grid">
            <div class="dash-card" style="grid-row:span 2">
                <h3>Distribuci√≥n 1440</h3>
                <div class="pie-wrap">
                    <svg class="pie-svg" id="pieSvg" viewBox="0 0 100 100"></svg>
                    <div class="pie-center">
                        <div class="pie-center-val" id="pieCenterVal">0%</div>
                        <div class="pie-center-sub">registrado</div>
                    </div>
                </div>
                <div id="pieLegend"></div>
            </div>

            <div class="dash-card">
                <h3>üò¥ Sue√±o Promedio</h3>
                <div class="dash-val" id="dashSleep">0h</div>
                <div class="dash-sub">√öltimos 7 d√≠as</div>
            </div>

            <div class="dash-card">
                <h3>üï≥ Vac√≠o Hoy</h3>
                <div class="dash-val" id="dashEmpty">24h</div>
                <div class="dash-sub">Sin registrar</div>
            </div>

            <div class="dash-card">
                <h3>üìÖ Tiempo Trackeado</h3>
                <div class="dash-val" id="dashTracked">0h</div>
                <div class="dash-sub">Hoy (excluyendo sue√±o)</div>
            </div>

            <div class="dash-card">
                <h3>‚öñÔ∏è Balance</h3>
                <div class="dash-val" id="dashBalance">‚Äî</div>
                <div class="dash-sub">Trabajo vs Personal</div>
            </div>
        </div>
    </div>

</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Area Modal -->
<div class="overlay" id="areaModal">
    <div class="modal">
        <div class="modal-head">
            <h2>Nueva √Årea de Vida</h2>
            <button class="modal-close" onclick="closeModal('areaModal')">√ó</button>
        </div>
        <div class="form-group"><label>Nombre</label><input type="text" id="areaName" placeholder="Ej: Trabajo, Salud, Familia"></div>
        <div class="row-2">
            <div class="form-group"><label>Emoji</label><input type="text" id="areaIcon" placeholder="üíº" maxlength="2"></div>
            <div class="form-group"><label>Color</label><input type="color" id="areaColor" value="#00ffff"></div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="closeModal('areaModal')">Cancelar</button>
            <button class="btn" onclick="saveArea()">Guardar</button>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div class="overlay" id="projectModal">
    <div class="modal">
        <div class="modal-head">
            <h2>Nuevo Proyecto</h2>
            <button class="modal-close" onclick="closeModal('projectModal')">√ó</button>
        </div>
        <div class="form-group"><label>√Årea de Vida</label>
            <select id="projectArea"><option value="">Sin √°rea</option></select>
        </div>
        <div class="form-group"><label>Nombre</label><input type="text" id="projectName" placeholder="Ej: Cliente ABC"></div>
        <div class="form-group"><label>Color</label><input type="color" id="projectColor" value="#0066ff"></div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="closeModal('projectModal')">Cancelar</button>
            <button class="btn" onclick="saveProject()">Guardar</button>
        </div>
    </div>
</div>

<!-- Manual Entry Modal -->
<div class="overlay" id="manualModal">
    <div class="modal">
        <div class="modal-head">
            <h2>Entrada Manual</h2>
            <button class="modal-close" onclick="closeModal('manualModal')">√ó</button>
        </div>
        <div class="form-group"><label>¬øQu√© hiciste?</label><input type="text" id="manDesc" placeholder="Descripci√≥n..."></div>
        <div class="row-2">
            <div class="form-group"><label>√Årea</label>
                <select id="manArea" onchange="updateManProjects()"><option value="">Sin √°rea</option></select>
            </div>
            <div class="form-group"><label>Proyecto</label>
                <select id="manProject"><option value="">Sin proyecto</option></select>
            </div>
        </div>
        <div class="form-group"><label>Fecha</label><input type="date" id="manDate"></div>
        <div class="row-2">
            <div class="form-group"><label>Inicio</label><input type="time" id="manStart"></div>
            <div class="form-group"><label>Fin</label><input type="time" id="manEnd"></div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="closeModal('manualModal')">Cancelar</button>
            <button class="btn" onclick="saveManual()">Guardar</button>
        </div>
    </div>
</div>

<!-- Edit Sleep Routine Modal -->
<div class="overlay" id="sleepEditModal">
    <div class="modal">
        <div class="modal-head">
            <h2>üò¥ Editar Rutina de Sue√±o</h2>
            <button class="modal-close" onclick="closeModal('sleepEditModal')">√ó</button>
        </div>
        <div class="row-2">
            <div class="form-group"><label>üåô Me duermo a:</label><input type="time" id="editSleepTime"></div>
            <div class="form-group"><label>‚òÄÔ∏è Me despierto a:</label><input type="time" id="editWakeTime"></div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-ghost" onclick="closeModal('sleepEditModal')">Cancelar</button>
            <button class="btn btn-success" onclick="updateSleepRoutine()">Guardar</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚îÄ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ‚îÄ
const SB_URL = 'https://ilzxgnqylmycktwsrfcr.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsenhnbnF5bG15Y2t0d3NyZmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTg0OTAsImV4cCI6MjA4NjMzNDQ5MH0.MkXUo8CjpH2QTUuLpoqA0LRHwTzC9p4WiFn1lFmk0d4';
const { createClient } = supabase;
const sb = createClient(SB_URL, SB_KEY);

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let user = null;
let db = { areas: [], projects: [], entries: [] };
let timer = null; // { id, type, name, meta, start, elapsed }
let timerInterval = null;

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
function switchTab_login(t) {
    document.querySelectorAll('.login-tab').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.login-form').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('lf-' + t).classList.add('active');
    document.getElementById(t === 'login' ? 'lp1' : 'rp1').focus();
}

function pinFocus(el, nextId) {
    if (el.value.length === 1) document.getElementById(nextId)?.focus();
}

function getPin(prefix) {
    return ['1','2','3','4'].map(i => document.getElementById(prefix+i).value).join('');
}

function autoLogin() {
    setTimeout(() => { if (getPin('lp').length === 4) doLogin(); }, 80);
}

async function doRegister() {
    const pin = getPin('rp');
    if (pin.length !== 4) return showMsg('regErr','PIN incompleto');
    setBtnLoading('rBtnTxt','rBtnSpin',true);
    try {
        const { data: ex } = await sb.from('users').select('id').eq('pin',pin).maybeSingle();
        if (ex) return showMsg('regErr','PIN ya en uso');
        const { data: u, error } = await sb.from('users').insert([{pin}]).select().single();
        if (error) throw error;
        user = u;
        showMsg('regOk','¬°Cuenta creada! Configurando sue√±o...',true);
        setTimeout(() => {
            clearPins('rp');
            document.getElementById('sleepSetup').classList.add('open');
        }, 1200);
    } catch(e) {
        showMsg('regErr','Error: '+e.message);
    } finally { setBtnLoading('rBtnTxt','rBtnSpin',false); }
}

async function doLogin() {
    const pin = getPin('lp');
    if (pin.length !== 4) return showMsg('loginErr','PIN incompleto');
    setBtnLoading('lBtnTxt','lBtnSpin',true);
    try {
        const { data: u } = await sb.from('users').select('*').eq('pin',pin).maybeSingle();
        if (!u) { clearPins('lp'); document.getElementById('lp1').focus(); return showMsg('loginErr','PIN incorrecto'); }
        user = u;
        await loadAll();
        launchApp();
        if (!u.sleep_routine?.enabled) document.getElementById('sleepSetup').classList.add('open');
        else await processDailySleep();
    } catch(e) {
        showMsg('loginErr','Error de conexi√≥n');
    } finally { setBtnLoading('lBtnTxt','lBtnSpin',false); }
}

function launchApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appHeader').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'block';
    // Set timeline date to today
    document.getElementById('tlDatePicker').value = todayStr();
    renderAll();
}

function doLogout() {
    if (!confirm('¬øCerrar sesi√≥n?')) return;
    if (timerInterval) clearInterval(timerInterval);
    user = null; timer = null; db = { areas:[], projects:[], entries:[] };
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appHeader').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
    clearPins('lp');
    document.getElementById('lp1').focus();
}

// ‚îÄ‚îÄ‚îÄ SLEEP SETUP ‚îÄ‚îÄ‚îÄ
async function saveSleepSetup() {
    const st = document.getElementById('setupSleepTime').value;
    const wt = document.getElementById('setupWakeTime').value;
    if (!st || !wt) return alert('Completa ambos horarios');
    try {
        const { error } = await sb.from('users').update({ sleep_routine: { enabled:true, sleep_time:st, wake_time:wt } }).eq('id', user.id);
        if (error) throw error;
        user.sleep_routine = { enabled:true, sleep_time:st, wake_time:wt };
        document.getElementById('sleepSetup').classList.remove('open');
        if (document.getElementById('mainApp').style.display === 'none') launchApp();
        await processDailySleep();
    } catch(e) { alert('Error al guardar: ' + e.message); }
}

async function processDailySleep() {
    if (!user?.sleep_routine?.enabled) return;
    const r = user.sleep_routine;
    const today = new Date();
    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate()-1);
    const yStr = yesterday.toISOString().split('T')[0];

    const { data: ex } = await sb.from('time_entries').select('id').eq('user_id',user.id).eq('type','sleep').eq('date',yStr).maybeSingle();
    if (ex) return;

    // Check if there was late-night activity
    const sleepStart = new Date(yStr + 'T' + r.sleep_time);
    const wakeEnd = new Date(todayStr() + 'T' + r.wake_time);
    const { data: lateActivity } = await sb.from('time_entries')
        .select('end_time').eq('user_id',user.id).eq('type','tracked')
        .gte('end_time', sleepStart.toISOString()).lte('end_time', wakeEnd.toISOString()).limit(1);

    if (lateActivity && lateActivity.length > 0) {
        // Show popup ‚Äî detect approximate sleep
        const lastActivity = new Date(lateActivity[lateActivity.length - 1].end_time);
        const approxSleep = new Date(lastActivity.getTime() + 30 * 60000);
        document.getElementById('popupSleepTime').value = approxSleep.toTimeString().slice(0,5);
        document.getElementById('popupWakeTime').value = r.wake_time;
        document.getElementById('sleepPopup').classList.add('open');
    } else {
        // Auto apply routine
        const dur = Math.floor((wakeEnd - sleepStart) / 1000);
        if (dur > 0 && dur < 86400) {
            await sb.from('time_entries').insert([{
                user_id: user.id, type:'sleep', description:'Sue√±o',
                start_time: sleepStart.toISOString(),
                end_time: wakeEnd.toISOString(),
                duration: dur, date: yStr, auto_detected: true
            }]);
            await loadAll(); renderAll();
        }
    }
}

async function saveSleepPopup() {
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
    const yStr = yesterday.toISOString().split('T')[0];
    const st = document.getElementById('popupSleepTime').value;
    const wt = document.getElementById('popupWakeTime').value;
    if (!st || !wt) return;
    const start = new Date(yStr + 'T' + st);
    const end = new Date(todayStr() + 'T' + wt);
    const dur = Math.floor((end - start) / 1000);
    if (dur <= 0) return;
    await sb.from('time_entries').insert([{
        user_id: user.id, type:'sleep', description:'Sue√±o',
        start_time: start.toISOString(), end_time: end.toISOString(),
        duration: dur, date: yStr, auto_detected: false
    }]);
    closeSleepPopup();
    await loadAll(); renderAll();
}

function closeSleepPopup() { document.getElementById('sleepPopup').classList.remove('open'); }

async function updateSleepRoutine() {
    const st = document.getElementById('editSleepTime').value;
    const wt = document.getElementById('editWakeTime').value;
    if (!st || !wt) return;
    await sb.from('users').update({ sleep_routine: { enabled:true, sleep_time:st, wake_time:wt } }).eq('id', user.id);
    user.sleep_routine = { enabled:true, sleep_time:st, wake_time:wt };
    closeModal('sleepEditModal');
}

// ‚îÄ‚îÄ‚îÄ DATA LOAD ‚îÄ‚îÄ‚îÄ
async function loadAll() {
    const [a, p, e] = await Promise.all([
        sb.from('categories').select('*').eq('user_id',user.id).order('created_at'),
        sb.from('projects').select('*').eq('user_id',user.id).order('created_at'),
        sb.from('time_entries').select('*').eq('user_id',user.id).order('start_time',{ascending:false}).limit(300)
    ]);
    db.areas = a.data || [];
    db.projects = p.data || [];
    db.entries = e.data || [];
}

function renderAll() {
    renderQuickTrack();
    renderTimeline();
    renderAreas();
    renderEntries();
    renderDashboard();
    updateProgress();
    updateSelects();
}

// ‚îÄ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ‚îÄ
function updateProgress() {
    const mins = todayTrackedMinutes();
    const pct = Math.min((mins/1440)*100, 100);
    document.getElementById('progMin').textContent = mins;
    document.getElementById('progPct').textContent = Math.floor(pct)+'%';
    document.getElementById('progBar').style.width = pct+'%';
}

function todayTrackedMinutes() {
    return db.entries.filter(e => e.date === todayStr()).reduce((s,e) => s + Math.floor(e.duration/60), 0);
}

// ‚îÄ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ
function startTimer(id, type, name, meta) {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    timer = { id, type, name, meta, start: new Date(), elapsed: 0 };

    // Update UI
    document.getElementById('timerBanner').classList.add('visible');
    document.getElementById('tbName').textContent = name;
    document.getElementById('tbMeta').textContent = meta;
    document.getElementById('headerTimer').classList.add('visible');
    document.getElementById('headerTimerName').textContent = name;

    timerInterval = setInterval(() => {
        timer.elapsed++;
        const t = fmtSeconds(timer.elapsed);
        document.getElementById('tbTime').textContent = t;
        document.getElementById('headerTimerTime').textContent = t;
    }, 1000);

    renderQuickTrack();
}

async function stopTimer() {
    if (!timer || !timerInterval) return;
    clearInterval(timerInterval); timerInterval = null;

    const end = new Date();
    try {
        const payload = {
            user_id: user.id, type:'tracked',
            description: timer.name,
            start_time: timer.start.toISOString(),
            end_time: end.toISOString(),
            duration: timer.elapsed,
            date: todayStr()
        };
        if (timer.type === 'project') payload.project_id = timer.id;
        if (timer.type === 'area') payload.category_id = timer.id;

        const { data, error } = await sb.from('time_entries').insert([payload]).select().single();
        if (error) throw error;
        db.entries.unshift(data);
    } catch(e) { console.error(e); }

    timer = null;
    document.getElementById('timerBanner').classList.remove('visible');
    document.getElementById('headerTimer').classList.remove('visible');
    renderAll();
}

function openManualQuickSwitch() {
    stopTimer();
    // Optionally show quick-switch popup ‚Äî for now just stop
}

// ‚îÄ‚îÄ‚îÄ QUICK TRACK ‚îÄ‚îÄ‚îÄ
function renderQuickTrack() {
    const grid = document.getElementById('qtGrid');
    const items = [
        ...db.areas.map(a => ({id:a.id, type:'area', name:a.name, icon:a.icon||'üìÅ', color:a.color})),
        ...db.projects.map(p => {
            const area = db.areas.find(a => a.id === p.category_id);
            return {id:p.id, type:'project', name:p.name, icon:area?.icon||'üìå', color:p.color, areaNm:area?.name};
        })
    ].slice(0,8);

    if (!items.length) {
        grid.innerHTML = `<div class="qt-empty">Crea √°reas o proyectos para usar Quick Track ‚ö°<br><br>
        <button class="btn btn-sm" onclick="openModal('areaModal')">‚ûï Crear √Årea</button></div>`;
        return;
    }

    grid.innerHTML = items.map(it => {
        const running = timer && timer.id === it.id;
        const todayMin = db.entries.filter(e => e.date === todayStr() && (e.category_id === it.id || e.project_id === it.id)).reduce((s,e) => s + Math.floor(e.duration/60), 0);
        return `<div class="qt-item ${running?'running':''}" onclick="${running?'stopTimer()':'startTimerFrom(\''+it.id+'\',\''+it.type+'\',\''+escapeSQ(it.name)+'\',\''+escapeSQ(it.areaNm||it.type)+'\')'}" >
            <div>
                <div class="qt-label">${it.icon} ${it.name}</div>
                <div class="qt-sub">${fmtMin(todayMin)} hoy</div>
            </div>
            <div class="qt-play">${running?'‚èπ':'‚ñ∂'}</div>
        </div>`;
    }).join('');
}

function startTimerFrom(id, type, name, meta) {
    startTimer(id, type, name, meta);
}

// ‚îÄ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ‚îÄ
function renderTimeline() {
    const dateStr = document.getElementById('tlDatePicker').value || todayStr();
    document.getElementById('timelineDate').textContent = dateStr === todayStr() ? 'Hoy ‚Äî ' + fmtDateLabel(dateStr) : fmtDateLabel(dateStr);

    const dayEntries = db.entries.filter(e => e.date === dateStr);
    const wrap = document.getElementById('timelineWrap');
    let html = '';

    for (let h = 0; h < 24; h++) {
        const hLabel = String(h).padStart(2,'0') + ':00';
        const entriesInHour = dayEntries.filter(e => {
            const s = new Date(e.start_time).getHours();
            const en = new Date(e.end_time).getHours();
            return h >= s && h <= en;
        });

        let inner = '';
        if (entriesInHour.length) {
            inner = entriesInHour.map(e => {
                const cls = e.type === 'sleep' ? 'sleep' : 'tracked';
                const proj = db.projects.find(p => p.id === e.project_id);
                const area = db.areas.find(a => a.id === e.category_id || a.id === proj?.category_id);
                const label = e.description + (proj ? ' ¬∑ '+proj.name : '') + (area ? ' ¬∑ '+area.name : '');
                return `<div class="tl-entry ${cls}" onclick="editEntry('${e.id}')">${e.type==='sleep'?'üò¥ ':''} ${label} <span style="font-size:.75rem;opacity:.7">(${fmtSeconds(e.duration)})</span></div>`;
            }).join('');
        } else {
            inner = `<div class="tl-entry gap">Vac√≠o</div>`;
        }

        html += `<div class="tl-row">
            <div class="tl-label">${hLabel}</div>
            <div class="tl-col">
                ${inner}
                <button class="tl-add" onclick="openRetroModal('${dateStr}','${h}')">+ Agregar</button>
            </div>
        </div>`;
    }

    wrap.innerHTML = html;

    // Scroll to current hour
    if (dateStr === todayStr()) {
        const curHour = new Date().getHours();
        const rows = wrap.querySelectorAll('.tl-row');
        const targetRow = rows[Math.max(0, curHour - 1)];
        if (targetRow) setTimeout(() => targetRow.scrollIntoView({behavior:'smooth', block:'center'}), 100);
    }
}

function openRetroModal(date, hour) {
    document.getElementById('manDate').value = date;
    document.getElementById('manStart').value = String(hour).padStart(2,'0') + ':00';
    document.getElementById('manEnd').value = String(parseInt(hour)+1).padStart(2,'0') + ':00';
    openModal('manualModal');
}

// ‚îÄ‚îÄ‚îÄ AREAS ‚îÄ‚îÄ‚îÄ
function renderAreas() {
    const c = document.getElementById('areasContainer');
    if (!db.areas.length) {
        c.innerHTML = `<div class="empty"><div class="empty-icon">üìÅ</div><h3>No hay √°reas a√∫n</h3><p>Crea tu primera √°rea de vida</p><br><button class="btn btn-sm" onclick="openModal('areaModal')">‚ûï Crear √Årea</button></div>`;
        return;
    }
    c.innerHTML = db.areas.map(area => {
        const projs = db.projects.filter(p => p.category_id === area.id);
        const totalMins = db.entries.filter(e => e.category_id === area.id || db.projects.find(p => p.id===e.project_id)?.category_id===area.id).reduce((s,e) => s+Math.floor(e.duration/60),0);

        return `<div class="area-block">
            <div class="area-head">
                <div class="area-head-left">
                    <span style="font-size:1.6rem">${area.icon||'üìÅ'}</span>
                    ${area.name}
                    <span style="color:var(--text3);font-size:.85rem;font-weight:400">${projs.length} proyectos</span>
                </div>
                <div style="display:flex;align-items:center;gap:.75rem">
                    <span class="area-time">${fmtMin(totalMins)}</span>
                    <button class="icon-btn" onclick="deleteArea('${area.id}')">üóëÔ∏è</button>
                </div>
            </div>
            ${projs.length ? `<div class="proj-grid">${projs.map(p => projCard(p)).join('')}</div>` : `<p style="color:var(--text3);padding-left:1.5rem;font-size:.9rem">Sin proyectos</p>`}
        </div>`;
    }).join('');

    // Uncategorized projects
    const uncat = db.projects.filter(p => !p.category_id);
    if (uncat.length) {
        document.getElementById('areasContainer').innerHTML += `
            <div class="area-block">
                <div class="area-head">
                    <div class="area-head-left"><span style="font-size:1.6rem">üìå</span> Sin √Årea <span style="color:var(--text3);font-size:.85rem;font-weight:400">${uncat.length}</span></div>
                </div>
                <div class="proj-grid">${uncat.map(p => projCard(p)).join('')}</div>
            </div>`;
    }
}

function projCard(p) {
    const mins = db.entries.filter(e => e.project_id === p.id).reduce((s,e) => s+Math.floor(e.duration/60),0);
    const entries = db.entries.filter(e => e.project_id === p.id).length;
    return `<div class="proj-card">
        <div class="proj-top">
            <div class="proj-name">${p.name}</div>
            <div style="display:flex;align-items:center;gap:.5rem">
                <span class="proj-dot" style="background:${p.color};box-shadow:0 0 6px ${p.color}"></span>
                <button class="icon-btn" onclick="deleteProject('${p.id}')">üóëÔ∏è</button>
            </div>
        </div>
        <div class="proj-stat">
            <span style="color:var(--text2)">Tiempo total</span>
            <span>${fmtMin(mins)}</span>
        </div>
        <div class="proj-stat">
            <span style="color:var(--text2)">Entradas</span>
            <span>${entries}</span>
        </div>
        <div style="margin-top:.75rem">
            <button class="btn btn-sm btn-full" onclick="startTimerFrom('${p.id}','project','${escapeSQ(p.name)}','Proyecto')">‚ñ∂ Trackear</button>
        </div>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ ENTRIES ‚îÄ‚îÄ‚îÄ
function renderEntries() {
    const c = document.getElementById('entriesList');
    let filtered = [...db.entries];

    const areaF = document.getElementById('filterArea').value;
    if (areaF) {
        const areaProjs = db.projects.filter(p => p.category_id === areaF).map(p => p.id);
        filtered = filtered.filter(e => e.category_id === areaF || areaProjs.includes(e.project_id));
    }

    const period = document.getElementById('filterPeriod').value;
    const now = new Date(); const today = new Date(now.getFullYear(),now.getMonth(),now.getDate());
    if (period === 'today') filtered = filtered.filter(e => new Date(e.date) >= today);
    else if (period === 'week') { const w = new Date(today); w.setDate(w.getDate()-7); filtered = filtered.filter(e => new Date(e.date) >= w); }
    else if (period === 'month') { const m = new Date(today); m.setMonth(m.getMonth()-1); filtered = filtered.filter(e => new Date(e.date) >= m); }

    if (!filtered.length) {
        c.innerHTML = `<div class="empty"><div class="empty-icon">‚è±Ô∏è</div><h3>Sin entradas</h3><p>Inicia Quick Track o agrega una entrada manual</p></div>`;
        return;
    }

    c.innerHTML = filtered.map(e => {
        const proj = db.projects.find(p => p.id === e.project_id);
        const area = db.areas.find(a => a.id === e.category_id || a.id === proj?.category_id);
        return `<div class="entry-card">
            <div class="entry-dur">${fmtSeconds(e.duration)}</div>
            <div>
                <div class="entry-desc">${e.description}</div>
                <div class="entry-meta">
                    <span>${fmtDateLabel(e.date)} ¬∑ ${fmtTime(e.start_time)}‚Äì${fmtTime(e.end_time)}</span>
                    ${area ? `<span class="badge">${area.icon||''} ${area.name}</span>` : ''}
                    ${proj ? `<span class="badge" style="border-color:${proj.color}">${proj.name}</span>` : ''}
                    ${e.type === 'sleep' ? `<span class="badge sleep-badge">üò¥ Sue√±o</span>` : ''}
                </div>
            </div>
            <div class="entry-actions">
                <button class="icon-btn" onclick="deleteEntry('${e.id}')">üóëÔ∏è</button>
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
    renderPie();
    calcStats();
}

function renderPie() {
    const todayE = db.entries.filter(e => e.date === todayStr());
    const buckets = {};
    let total = 0;

    todayE.forEach(e => {
        const mins = Math.floor(e.duration/60);
        total += mins;
        if (e.type === 'sleep') { buckets['üò¥ Sue√±o'] = (buckets['üò¥ Sue√±o']||0)+mins; return; }
        const proj = db.projects.find(p => p.id===e.project_id);
        const area = db.areas.find(a => a.id===e.category_id||a.id===proj?.category_id);
        const label = area ? (area.icon||'')+' '+area.name : 'üìå Sin √°rea';
        buckets[label] = (buckets[label]||0)+mins;
    });

    const empty = 1440 - total;
    if (empty > 0) buckets['‚¨õ Vac√≠o'] = empty;

    const COLORS = ['#00ffff','#0066ff','#8b5cf6','#00ff88','#ff3366','#ffaa00','#6366f1','#374151'];
    let angle = 0;
    let paths = ''; let legend = '';

    Object.entries(buckets).forEach(([label, mins], i) => {
        const pct = mins / 1440;
        const startA = angle;
        angle += pct * 360;
        const r = 40, cx = 50, cy = 50, ir = 25;
        const x1 = cx+r*Math.cos((startA-90)*Math.PI/180);
        const y1 = cy+r*Math.sin((startA-90)*Math.PI/180);
        const x2 = cx+r*Math.cos((angle-90)*Math.PI/180);
        const y2 = cy+r*Math.sin((angle-90)*Math.PI/180);
        const xi1 = cx+ir*Math.cos((startA-90)*Math.PI/180);
        const yi1 = cy+ir*Math.sin((startA-90)*Math.PI/180);
        const xi2 = cx+ir*Math.cos((angle-90)*Math.PI/180);
        const yi2 = cy+ir*Math.sin((angle-90)*Math.PI/180);
        const lg = pct > 0.5 ? 1 : 0;
        const col = COLORS[i % COLORS.length];

        paths += `<path d="M${xi1} ${yi1} L${x1} ${y1} A${r} ${r} 0 ${lg} 1 ${x2} ${y2} L${xi2} ${yi2} A${ir} ${ir} 0 ${lg} 0 ${xi1} ${yi1} Z" fill="${col}" opacity=".85"/>`;
        legend += `<div class="legend-item"><div class="legend-dot" style="background:${col}"></div><span>${label}</span><span class="legend-val">${fmtMin(mins)}</span></div>`;
    });

    document.getElementById('pieSvg').innerHTML = paths;
    document.getElementById('pieLegend').innerHTML = legend;
    document.getElementById('pieCenterVal').textContent = Math.floor((total/1440)*100)+'%';
}

function calcStats() {
    // Sleep avg last 7 days
    const w = new Date(); w.setDate(w.getDate()-7);
    const sleepE = db.entries.filter(e => e.type==='sleep' && new Date(e.date)>=w);
    const avgSleepMin = sleepE.length ? sleepE.reduce((s,e)=>s+e.duration,0)/sleepE.length/60 : 0;
    document.getElementById('dashSleep').textContent = fmtMin(Math.round(avgSleepMin));

    // Empty today
    const tracked = db.entries.filter(e=>e.date===todayStr()).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    document.getElementById('dashEmpty').textContent = fmtMin(1440-tracked);

    // Tracked (no sleep)
    const trackedNoSleep = db.entries.filter(e=>e.date===todayStr()&&e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
    document.getElementById('dashTracked').textContent = fmtMin(trackedNoSleep);

    // Balance ‚Äî first area vs rest
    if (db.areas.length >= 2) {
        const a1 = db.areas[0], a1Projs = db.projects.filter(p=>p.category_id===a1.id).map(p=>p.id);
        const a1Mins = db.entries.filter(e=>e.date===todayStr()&&(e.category_id===a1.id||a1Projs.includes(e.project_id))).reduce((s,e)=>s+Math.floor(e.duration/60),0);
        const total2 = db.entries.filter(e=>e.date===todayStr()&&e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
        const pct = total2 ? Math.round((a1Mins/total2)*100) : 0;
        document.getElementById('dashBalance').textContent = `${a1.icon||''} ${pct}%`;
    } else {
        document.getElementById('dashBalance').textContent = '‚Äî';
    }
}

// ‚îÄ‚îÄ‚îÄ SELECTS ‚îÄ‚îÄ‚îÄ
function updateSelects() {
    const areaOpts = '<option value="">Sin √°rea</option>' + db.areas.map(a=>`<option value="${a.id}">${a.icon||''} ${a.name}</option>`).join('');
    ['projectArea','manArea','filterArea'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { const v = el.value; el.innerHTML = areaOpts.replace('Sin √°rea','Sin √°rea'); el.value = v; }
    });
    updateManProjects();
}

function updateManProjects() {
    const areaId = document.getElementById('manArea')?.value;
    const projs = areaId ? db.projects.filter(p=>p.category_id===areaId) : db.projects;
    document.getElementById('manProject').innerHTML = '<option value="">Sin proyecto</option>' + projs.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}

// ‚îÄ‚îÄ‚îÄ AREA CRUD ‚îÄ‚îÄ‚îÄ
async function saveArea() {
    const name = document.getElementById('areaName').value.trim();
    if (!name) return alert('Ingresa un nombre');
    const { data, error } = await sb.from('categories').insert([{
        user_id: user.id, name,
        icon: document.getElementById('areaIcon').value||'üìÅ',
        color: document.getElementById('areaColor').value
    }]).select().single();
    if (error) { console.error(error); return alert('Error al guardar'); }
    db.areas.push(data);
    closeModal('areaModal');
    document.getElementById('areaName').value=''; document.getElementById('areaIcon').value='';
    renderAll();
}

async function deleteArea(id) {
    if (!confirm('¬øEliminar √°rea y sus proyectos?')) return;
    await sb.from('categories').delete().eq('id',id);
    db.areas = db.areas.filter(a=>a.id!==id);
    db.projects = db.projects.filter(p=>p.category_id!==id);
    renderAll();
}

// ‚îÄ‚îÄ‚îÄ PROJECT CRUD ‚îÄ‚îÄ‚îÄ
async function saveProject() {
    const name = document.getElementById('projectName').value.trim();
    if (!name) return alert('Ingresa un nombre');
    const { data, error } = await sb.from('projects').insert([{
        user_id: user.id, name,
        category_id: document.getElementById('projectArea').value||null,
        color: document.getElementById('projectColor').value
    }]).select().single();
    if (error) { console.error(error); return alert('Error al guardar'); }
    db.projects.push(data);
    closeModal('projectModal');
    document.getElementById('projectName').value='';
    renderAll();
}

async function deleteProject(id) {
    if (!confirm('¬øEliminar proyecto?')) return;
    await sb.from('projects').delete().eq('id',id);
    db.projects = db.projects.filter(p=>p.id!==id);
    renderAll();
}

// ‚îÄ‚îÄ‚îÄ MANUAL ENTRY ‚îÄ‚îÄ‚îÄ
async function saveManual() {
    const desc = document.getElementById('manDesc').value.trim();
    const date = document.getElementById('manDate').value;
    const st = document.getElementById('manStart').value;
    const et = document.getElementById('manEnd').value;
    if (!desc||!date||!st||!et) return alert('Completa todos los campos');
    const start = new Date(date+'T'+st);
    const end = new Date(date+'T'+et);
    const dur = Math.floor((end-start)/1000);
    if (dur<=0) return alert('El fin debe ser posterior al inicio');
    const { data, error } = await sb.from('time_entries').insert([{
        user_id: user.id, type:'tracked', description:desc,
        project_id: document.getElementById('manProject').value||null,
        category_id: document.getElementById('manArea').value||null,
        start_time: start.toISOString(), end_time: end.toISOString(),
        duration: dur, date
    }]).select().single();
    if (error) { console.error(error); return alert('Error al guardar'); }
    db.entries.unshift(data);
    closeModal('manualModal');
    document.getElementById('manDesc').value='';
    renderAll();
}

// ‚îÄ‚îÄ‚îÄ ENTRY EDIT/DELETE ‚îÄ‚îÄ‚îÄ
async function deleteEntry(id) {
    if (!confirm('¬øEliminar esta entrada?')) return;
    await sb.from('time_entries').delete().eq('id',id);
    db.entries = db.entries.filter(e=>e.id!==id);
    renderAll();
}

function editEntry(id) {
    // For now: delete and re-enter (future: inline edit)
    if (confirm('¬øDeseas eliminar esta entrada para corregirla?')) deleteEntry(id);
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
function exportCSV() {
    const rows = db.entries.map(e => {
        const p = db.projects.find(x=>x.id===e.project_id);
        const a = db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);
        return [e.date, e.description, a?.name||'', p?.name||'', fmtTime(e.start_time), fmtTime(e.end_time), (e.duration/3600).toFixed(2), e.type].join(',');
    });
    const csv = 'Fecha,Descripci√≥n,√Årea,Proyecto,Inicio,Fin,Horas,Tipo\n' + rows.join('\n');
    dlFile(csv, '1440-export-'+todayStr()+'.csv', 'text/csv');
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20); doc.text('1440 ‚Äî Reporte de Tiempo', 20, 20);
    doc.setFontSize(10); doc.text('Generado: '+new Date().toLocaleDateString('es'), 20, 30);
    let y = 45;
    db.entries.forEach(e => {
        if (y > 270) { doc.addPage(); y = 20; }
        const p = db.projects.find(x=>x.id===e.project_id);
        const a = db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);
        doc.setFontSize(9);
        doc.text(`${e.date}  ${e.description}  [${fmtSeconds(e.duration)}]`, 20, y); y+=5;
        doc.setFontSize(7.5);
        doc.text(`${a?.name||'Sin √°rea'} ‚Üí ${p?.name||'Sin proyecto'}  ¬∑  ${fmtTime(e.start_time)}‚Äì${fmtTime(e.end_time)}`, 24, y); y+=6;
    });
    doc.save('1440-report-'+todayStr()+'.pdf');
}

function dlFile(content, filename, mime) {
    const blob = new Blob([content],{type:mime});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
}

// ‚îÄ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ‚îÄ
function goTab(name, el) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-'+name).classList.add('active');
    if (name==='dashboard') renderDashboard();
    if (name==='timeline') renderTimeline();
}

// ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ
function openModal(id) {
    if (id==='areaModal') { document.getElementById('areaName').value=''; document.getElementById('areaIcon').value=''; }
    if (id==='projectModal') { document.getElementById('projectName').value=''; updateSelects(); }
    if (id==='manualModal') {
        document.getElementById('manDate').value = todayStr();
        document.getElementById('manStart').value = '';
        document.getElementById('manEnd').value = '';
        document.getElementById('manDesc').value = '';
        updateSelects();
    }
    if (id==='sleepEditModal') {
        document.getElementById('editSleepTime').value = user.sleep_routine?.sleep_time||'22:30';
        document.getElementById('editWakeTime').value = user.sleep_routine?.wake_time||'07:00';
    }
    document.getElementById(id).classList.add('open');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function todayStr() { return new Date().toISOString().split('T')[0]; }
function fmtSeconds(s) {
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}
function fmtMin(m) {
    if (m < 0) m = 0;
    return `${Math.floor(m/60)}h ${String(Math.floor(m%60)).padStart(2,'0')}m`;
}
function fmtTime(iso) { return new Date(iso).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}); }
function fmtDateLabel(d) { return new Date(d+'T12:00:00').toLocaleDateString('es',{weekday:'short',day:'numeric',month:'short'}); }
function escapeSQ(s) { return (s||'').replace(/'/g,"\\'"); }
function showMsg(id,txt,isOk=false) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent=txt; el.className='msg '+(isOk?'ok':'err');
    el.classList.remove('hidden');
    setTimeout(()=>el.classList.add('hidden'),3000);
}
function setBtnLoading(txtId,spinId,loading) {
    document.getElementById(txtId).classList.toggle('hidden',loading);
    document.getElementById(spinId).classList.toggle('hidden',!loading);
}
function clearPins(prefix) { ['1','2','3','4'].forEach(i=>{ const el=document.getElementById(prefix+i); if(el) el.value=''; }); }

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
document.getElementById('lp1').focus();
</script>
</body>
</html>
