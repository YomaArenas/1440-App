<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>1440</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='44' fill='none' stroke='url(%23g)' stroke-width='12'/%3E%3Ccircle cx='50' cy='50' r='19' fill='%2300FFFF'/%3E%3Cdefs%3E%3ClinearGradient id='g'%3E%3Cstop stop-color='%2300FFFF'/%3E%3Cstop offset='1' stop-color='%230066FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{font-size:16px;height:100%}
body{font-family:'Outfit',sans-serif;min-height:100vh;overflow-x:hidden;line-height:1.5}
[data-theme="dark"]{
  --bg:#060d22;--bg2:#0b1735;--bg3:#0f2050;
  --glass:rgba(11,23,53,.78);--glass-bd:rgba(0,255,255,.13);
  --cyan:#00ffff;--blue:#0066ff;--ok:#00ff88;
  --del:#ff3366;--warn:#ffaa00;--sleep:#7c3aed;
  --t:#fff;--t2:#8fb0d4;--t3:#415e8a;
  --bdr:rgba(30,60,120,.8);--shadow:0 8px 32px rgba(0,0,0,.45);
  --sb:56px;--sb-exp:234px;--hh:68px;--bn:68px;
}
[data-theme="dark"] body{
  background:var(--bg);
  color:var(--t);
  background-image:radial-gradient(ellipse at 15% 20%,rgba(0,255,255,.05) 0%,transparent 50%),
                   radial-gradient(ellipse at 85% 80%,rgba(0,102,255,.05) 0%,transparent 50%);
}
[data-theme="light"]{
  --bg:#dde8ff;--bg2:rgba(255,255,255,.62);--bg3:rgba(255,255,255,.42);
  --glass:rgba(255,255,255,.58);--glass-bd:rgba(0,80,200,.18);
  --cyan:#0055cc;--blue:#003399;--ok:#00a855;
  --del:#cc0033;--warn:#cc7700;--sleep:#5b21b6;
  --t:#0a1628;--t2:#2a4a7a;--t3:#5a7aa0;
  --bdr:rgba(0,80,200,.15);--shadow:0 8px 32px rgba(0,80,200,.12);
  --sb:56px;--sb-exp:234px;--hh:68px;--bn:68px;
}
[data-theme="light"] body{background:linear-gradient(135deg,#d8eeff 0%,#e4eeff 40%,#ede8ff 100%);color:var(--t)}
.glass{background:var(--glass);backdrop-filter:blur(18px) saturate(160%);-webkit-backdrop-filter:blur(18px) saturate(160%);border:1px solid var(--glass-bd);box-shadow:var(--shadow)}
[data-theme="dark"] .card{background:var(--bg2);border:1px solid var(--bdr)}
[data-theme="light"] .card{background:rgba(255,255,255,.65);border:1px solid rgba(0,80,200,.13);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.layout{display:flex;min-height:100vh;position:relative;z-index:1}
/* SIDEBAR */
.sb{position:fixed;top:0;left:0;bottom:0;width:var(--sb);z-index:600;display:flex;flex-direction:column;overflow:hidden;transition:width .28s cubic-bezier(.4,0,.2,1)}
[data-theme="dark"] .sb{background:rgba(6,13,34,.97);border-right:1px solid rgba(26,51,102,.5)}
[data-theme="light"] .sb{background:rgba(255,255,255,.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-right:1px solid rgba(0,80,200,.12);box-shadow:2px 0 24px rgba(0,80,200,.07)}
.sb:hover{width:var(--sb-exp)}
.sb-top{height:var(--hh);display:flex;align-items:center;padding:0 13px;gap:10px;overflow:hidden;white-space:nowrap;border-bottom:1px solid var(--bdr);flex-shrink:0}
.sb-logo-svg{width:26px;height:26px;flex-shrink:0}
.sb-logo-txt{font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,var(--cyan),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;opacity:0;transition:opacity .2s .04s;white-space:nowrap}
.sb:hover .sb-logo-txt{opacity:1}
.sb-nav{flex:1;overflow:hidden;padding:6px 0}
.sb-sec{font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t3);padding:14px 16px 5px;white-space:nowrap;opacity:0;transition:opacity .15s}
.sb:hover .sb-sec{opacity:1}
.sb-item{display:flex;align-items:center;gap:14px;padding:13px 14px;cursor:pointer;transition:all .15s;color:var(--t2);white-space:nowrap;position:relative;font-size:1rem;font-weight:500}
.sb-item:hover,.sb-item.active{color:var(--cyan);background:rgba(0,255,255,.07)}
[data-theme="light"] .sb-item:hover,[data-theme="light"] .sb-item.active{color:var(--blue);background:rgba(0,80,200,.07)}
.sb-item.active::before{content:'';position:absolute;left:0;top:18%;bottom:18%;width:3px;background:linear-gradient(180deg,var(--cyan),var(--blue));border-radius:0 3px 3px 0}
.sb-ic{font-size:1.3rem;width:26px;text-align:center;flex-shrink:0}
.sb-lbl{opacity:0;transition:opacity .2s .04s}
.sb:hover .sb-lbl{opacity:1}
.sb-div{height:1px;background:var(--bdr);margin:6px 10px;flex-shrink:0}
.sb-bot{padding:6px 0 12px;border-top:1px solid var(--bdr);flex-shrink:0}
/* HEADER */
.hdr{position:fixed;top:0;right:0;height:var(--hh);left:var(--sb);display:flex;align-items:center;padding:0 1.5rem;gap:1rem;z-index:500;transition:left .28s cubic-bezier(.4,0,.2,1)}
[data-theme="dark"] .hdr{background:rgba(6,13,34,.96);backdrop-filter:blur(20px);border-bottom:1px solid rgba(26,51,102,.5)}
[data-theme="light"] .hdr{background:rgba(255,255,255,.78);backdrop-filter:blur(20px);border-bottom:1px solid rgba(0,80,200,.1);box-shadow:0 2px 16px rgba(0,80,200,.06)}
.sb:hover~.hdr{left:var(--sb-exp)}
.hdr-mantra{flex:1;min-width:0;cursor:pointer;padding:.3rem .6rem;border-radius:9px;transition:background .2s;overflow:hidden}
.hdr-mantra:hover{background:rgba(0,255,255,.06)}
[data-theme="light"] .hdr-mantra:hover{background:rgba(0,80,200,.06)}
.hdr-mq{font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t3)}
.hdr-mv{font-size:.9375rem;font-weight:600;color:var(--cyan);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
[data-theme="light"] .hdr-mv{color:var(--blue)}
.hdr-mph{font-size:.875rem;color:var(--t3);font-style:italic}
.hstats{display:flex;gap:.5rem;flex-shrink:0}
.hstat{display:flex;align-items:center;gap:.4rem;background:rgba(255,255,255,.05);border:1px solid var(--bdr);border-radius:20px;padding:.35rem 1rem;white-space:nowrap;cursor:pointer;transition:border-color .2s}
.hstat:hover{border-color:var(--cyan)}
[data-theme="light"] .hstat{background:rgba(0,80,200,.05)}
.hstat-ic{font-size:1rem}
.hstat-val{font-family:'Space Mono',monospace;font-size:.875rem;font-weight:700;color:var(--cyan)}
[data-theme="light"] .hstat-val{color:var(--blue)}
.hstat-lbl{font-size:.75rem;color:var(--t3)}
.ht{display:none;align-items:center;gap:.45rem;background:rgba(0,255,136,.09);border:1px solid rgba(0,255,136,.35);border-radius:20px;padding:.3rem .875rem;flex-shrink:0}
.ht.on{display:flex}
.ht-dot{width:7px;height:7px;background:var(--ok);border-radius:50%;box-shadow:0 0 6px var(--ok);animation:bl 1.4s ease-in-out infinite;flex-shrink:0}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.2}}
.ht-nm{font-size:.8125rem;font-weight:600;max-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ht-t{font-family:'Space Mono',monospace;font-size:.8125rem;color:var(--cyan);flex-shrink:0}
.ht-x{background:var(--del);border:none;border-radius:5px;color:#fff;padding:.22rem .5rem;font-size:.75rem;cursor:pointer;flex-shrink:0}
.hdr-btn{width:38px;height:38px;border-radius:9px;border:1px solid var(--bdr);background:rgba(255,255,255,.04);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all .2s;flex-shrink:0}
.hdr-btn:hover{border-color:var(--cyan);transform:scale(1.05)}
/* CONTENT */
.layout{margin-left:var(--sb);transition:margin-left .28s cubic-bezier(.4,0,.2,1)}
.sb:hover~.layout{margin-left:var(--sb-exp)}
.content{width:100%;padding-top:var(--hh);min-height:100vh}
.inner{max-width:1100px;margin:0 auto;padding:1.875rem 2rem 5rem}
.page{display:none}.page.active{display:block}
.page-title{font-size:1.375rem;font-weight:700;margin-bottom:1.25rem;display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
/* PROGRESS BAR */
.prog-wrap{border-radius:16px;padding:1.25rem 1.5rem;margin-bottom:1.125rem}
.prog-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.875rem;flex-wrap:wrap;gap:.5rem}
.prog-left{display:flex;align-items:baseline;gap:.4rem}
.prog-num{font-family:'Space Mono',monospace;font-size:1.75rem;font-weight:800;color:var(--cyan)}
[data-theme="light"] .prog-num{color:var(--blue)}
.prog-of{font-size:.875rem;color:var(--t3)}
.prog-pct{font-size:.875rem;color:var(--t2);font-family:'Space Mono',monospace}
.prog-legend{display:flex;gap:1rem}
.pleg{display:flex;align-items:center;gap:.4rem;font-size:.8125rem;color:var(--t2)}
.pleg-dot{width:11px;height:11px;border-radius:3px;flex-shrink:0}
.prog-bar{height:18px;background:var(--bg3);border-radius:9px;overflow:hidden;display:flex;gap:2px}
[data-theme="light"] .prog-bar{background:rgba(0,80,200,.1)}
.pb-t{height:100%;border-radius:9px 0 0 9px;min-width:0;background:linear-gradient(90deg,var(--cyan),var(--blue));transition:width .6s;position:relative;overflow:hidden}
.pb-t::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);animation:shim 2.5s linear infinite}
@keyframes shim{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.pb-s{height:100%;min-width:0;background:linear-gradient(90deg,#7c3aed,#5b21b6);transition:width .6s}
/* TIMER BANNER */
.tban{border-radius:16px;padding:1.25rem 1.5rem;margin-bottom:1.125rem;display:none}
.tban.on{display:block}
[data-theme="dark"] .tban{background:rgba(0,255,136,.04);border:1.5px solid rgba(0,255,136,.3)}
[data-theme="light"] .tban{background:rgba(0,168,85,.05);border:1.5px solid rgba(0,168,85,.28)}
.tban-row{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
.tban-left{display:flex;align-items:center;gap:.75rem}
.tban-dot{width:10px;height:10px;background:var(--ok);border-radius:50%;box-shadow:0 0 8px var(--ok);animation:bl 1.4s ease-in-out infinite;flex-shrink:0}
.tban-name{font-size:1.0625rem;font-weight:700}
.tban-meta{font-size:.8125rem;color:var(--t2)}
.tban-time{font-family:'Space Mono',monospace;font-size:2rem;font-weight:700;color:var(--cyan);white-space:nowrap}
[data-theme="light"] .tban-time{color:var(--blue)}
.tban-acts{display:flex;gap:.625rem;margin-top:.875rem}
.tban-acts .btn{flex:1}
/* SPLIT */
.split{display:grid;grid-template-columns:3fr 2fr;gap:1rem;margin-bottom:1.125rem;align-items:start}
.qt-card{border-radius:16px;padding:1.125rem}
.qt-lbl{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t3);margin-bottom:.875rem}
.qt-grid{display:grid;grid-template-columns:1fr 1fr;gap:.625rem;max-height:360px;overflow-y:auto}
.qt-item{border-radius:11px;padding:.75rem .875rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:space-between;gap:.4rem}
[data-theme="dark"] .qt-item{background:var(--bg3);border:1.5px solid var(--bdr)}
[data-theme="light"] .qt-item{background:rgba(255,255,255,.65);border:1.5px solid rgba(0,80,200,.12)}
.qt-item:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,255,255,.1)}
[data-theme="light"] .qt-item:hover{box-shadow:0 4px 16px rgba(0,80,200,.1)}
.qt-item.on{border-color:var(--ok)!important;background:rgba(0,255,136,.07)!important}
.qt-siesta{border:1.5px dashed var(--sleep)!important;background:rgba(124,58,237,.06)!important}
.qt-siesta:hover{background:rgba(124,58,237,.12)!important;border-style:solid!important}

.qt-nm{font-weight:600;font-size:.9375rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:85px}
.qt-st{font-size:.75rem;color:var(--t2);font-family:'Space Mono',monospace}
.qt-play{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.875rem;font-weight:700;flex-shrink:0;background:linear-gradient(135deg,var(--cyan),var(--blue));color:var(--bg)}
.rm-card{border-radius:16px;padding:1.25rem;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:.75rem;min-height:180px}
[data-theme="dark"] .rm-card{background:rgba(0,255,255,.05);border:1.5px solid rgba(0,255,255,.2)}
[data-theme="light"] .rm-card{background:rgba(0,80,200,.05);border:1.5px solid rgba(0,80,200,.18)}
.rm-card:hover{transform:translateY(-2px)}
[data-theme="dark"] .rm-card:hover{border-color:var(--cyan);box-shadow:0 6px 24px rgba(0,255,255,.1)}
[data-theme="light"] .rm-card:hover{border-color:var(--blue);box-shadow:0 6px 24px rgba(0,80,200,.1)}
.rm-ic{font-size:2.25rem}.rm-lbl{font-size:1rem;font-weight:700;color:var(--cyan);text-transform:uppercase;letter-spacing:.05em;line-height:1.3}
[data-theme="light"] .rm-lbl{color:var(--blue)}.rm-sub{font-size:.75rem;color:var(--t2)}
/* TIMELINE */
.tl-reflect{border-radius:11px;padding:.875rem 1.125rem;margin-bottom:1rem;font-size:.9375rem;color:#a5b4fc;font-style:italic;text-align:center;line-height:1.55}
[data-theme="dark"] .tl-reflect{background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25)}
[data-theme="light"] .tl-reflect{background:rgba(85,88,204,.06);border:1px solid rgba(85,88,204,.2);color:#4f46e5}
.tl-reflect strong{display:block;font-size:.6875rem;text-transform:uppercase;letter-spacing:.09em;color:var(--sleep);margin-bottom:.3rem;font-style:normal}
.tl-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:.875rem;flex-wrap:wrap;gap:.5rem}
.tl-wrap{overflow-y:auto;-webkit-overflow-scrolling:touch;max-height:calc(100vh - 320px)}
.tl-row{display:grid;grid-template-columns:56px 1fr;min-height:68px;border-bottom:1px solid rgba(26,51,102,.2)}
[data-theme="light"] .tl-row{border-bottom-color:rgba(0,80,200,.08)}
.tl-lbl{padding:.5rem .4rem 0;font-size:.75rem;color:var(--t3);font-family:'Space Mono',monospace;text-align:right}
.tl-col{position:relative;padding:4px 6px 4px 8px;min-height:68px}
.tl-e{border-radius:8px;padding:.4rem .75rem;font-size:.875rem;font-weight:600;margin-bottom:3px;cursor:pointer;transition:filter .15s;display:flex;align-items:center;gap:.5rem;min-height:32px;position:relative}
.tl-e:hover{filter:brightness(1.15)}
.tl-acts{display:none;gap:.25rem;margin-left:auto;flex-shrink:0}
.tl-e:hover .tl-acts{display:flex}
.tl-abtn{width:24px;height:24px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7rem;opacity:.85;transition:opacity .15s;flex-shrink:0}
.tl-abtn:hover{opacity:1}
.tl-abtn.edit{background:rgba(0,255,255,.15);color:var(--cyan)}
.tl-abtn.del{background:rgba(255,51,102,.15);color:var(--del)}
.tl-tracked{background:rgba(0,255,255,.09);border-left:3px solid var(--cyan);color:var(--cyan)}
[data-theme="light"] .tl-tracked{background:rgba(0,80,200,.08);border-left-color:var(--blue);color:var(--blue)}
.tl-sleep{background:rgba(124,58,237,.12);border-left:3px solid var(--sleep);color:#c4b5fd}
[data-theme="light"] .tl-sleep{background:rgba(91,33,182,.08);color:#5b21b6}
.tl-gap{background:rgba(255,255,255,.02);border-left:2px dashed rgba(26,51,102,.35);color:var(--t3);font-weight:400;cursor:default;font-size:.8125rem}
.tl-dur{font-size:.7rem;opacity:.6;margin-left:auto;font-family:'Space Mono',monospace;white-space:nowrap;flex-shrink:0}
.tl-add{position:absolute;right:5px;top:5px;background:transparent;border:1px dashed var(--bdr);color:var(--t3);border-radius:5px;padding:.15rem .45rem;font-size:.7rem;cursor:pointer;transition:all .15s;font-family:inherit;opacity:0}
.tl-row:hover .tl-add{opacity:1}
.tl-add:hover{border-color:var(--cyan);color:var(--cyan)}
.sl-edit{background:transparent;border:none;color:#c4b5fd;cursor:pointer;font-size:.7rem;text-decoration:underline;padding:.1rem .3rem;flex-shrink:0}
/* AREAS */
.areas-list{display:flex;flex-direction:column;gap:.875rem}
.area-card{border-radius:14px;overflow:hidden}
.area-head{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.125rem;cursor:pointer;transition:background .15s}
.area-head:hover{background:rgba(255,255,255,.03)}
.area-hl{display:flex;align-items:center;gap:.75rem}
.area-stripe{width:5px;height:36px;border-radius:3px;flex-shrink:0}
.area-ic{font-size:1.375rem}
.area-nm{font-size:1rem;font-weight:700}
.area-cnt{font-size:.75rem;color:var(--t3)}
.area-hr{display:flex;align-items:center;gap:.5rem}
.area-tot{font-family:'Space Mono',monospace;font-size:.875rem;font-weight:700}
.area-chev{font-size:1rem;color:var(--t3);transition:transform .25s;line-height:1}
.area-chev.open{transform:rotate(90deg)}
.area-body{display:none;padding:0 1rem 1rem}
.area-body.open{display:block}
.proj-stack{display:flex;flex-direction:column;gap:.45rem;margin-top:.625rem}
.proj-row{border-radius:10px;padding:.7rem .9rem;display:flex;align-items:center;gap:.65rem}
[data-theme="dark"] .proj-row{background:var(--bg3);border:1px solid var(--bdr)}
[data-theme="light"] .proj-row{background:rgba(255,255,255,.55);border:1px solid rgba(0,80,200,.1)}
.proj-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.proj-inf{flex:1;min-width:0}
.proj-nm{font-weight:600;font-size:.9375rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.proj-st{font-size:.75rem;color:var(--t2);font-family:'Space Mono',monospace}
.proj-acts{display:flex;gap:.35rem}
/* HISTORIAL */
.hist-filters{display:flex;gap:.625rem;margin-bottom:1rem;flex-wrap:wrap}
.hf-in{flex:1;min-width:160px;border-radius:10px;padding:.625rem 1rem;font-family:inherit;font-size:.9375rem;transition:all .2s}
[data-theme="dark"] .hf-in{background:var(--bg2);border:1.5px solid var(--bdr);color:var(--t)}
[data-theme="light"] .hf-in{background:rgba(255,255,255,.75);border:1.5px solid rgba(0,80,200,.15);color:var(--t)}
.hf-in:focus{outline:none;border-color:var(--cyan)}
.hf-sel{border-radius:10px;padding:.625rem .75rem;font-family:inherit;font-size:.875rem;cursor:pointer}
[data-theme="dark"] .hf-sel{background:var(--bg2);border:1.5px solid var(--bdr);color:var(--t)}
[data-theme="light"] .hf-sel{background:rgba(255,255,255,.75);border:1.5px solid rgba(0,80,200,.15);color:var(--t)}
.day-group{border-radius:14px;margin-bottom:.875rem;overflow:hidden}
[data-theme="dark"] .day-group{background:var(--bg2);border:1px solid var(--bdr)}
[data-theme="light"] .day-group{background:rgba(255,255,255,.65);border:1px solid rgba(0,80,200,.12);backdrop-filter:blur(12px)}
.day-head{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.125rem;cursor:pointer;transition:background .15s}
.day-head:hover{background:rgba(255,255,255,.03)}
.day-date{font-weight:700;font-size:.9375rem}
.day-stats{display:flex;align-items:center;gap:.5rem}
.day-dur{font-family:'Space Mono',monospace;font-size:.875rem;color:var(--cyan)}
[data-theme="light"] .day-dur{color:var(--blue)}
.day-cnt{font-size:.75rem;color:var(--t3);padding:.12rem .55rem;border-radius:10px}
[data-theme="dark"] .day-cnt{background:var(--bg3)}
[data-theme="light"] .day-cnt{background:rgba(0,80,200,.08)}
.day-chev{font-size:1rem;color:var(--t3);transition:transform .25s;margin-left:.3rem;line-height:1}
.day-chev.open{transform:rotate(90deg)}
.day-entries{display:none;padding:0 .875rem .875rem}
.day-entries.open{display:block}
.reg-item{display:flex;align-items:center;gap:.75rem;padding:.65rem .5rem;border-radius:9px;transition:background .15s}
.reg-item:hover{background:rgba(255,255,255,.03)}
.reg-bar{width:3.5px;height:36px;border-radius:2px;flex-shrink:0}
.reg-body{flex:1;min-width:0}
.reg-desc{font-size:.9375rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.reg-meta{font-size:.75rem;color:var(--t2);display:flex;gap:.4rem;flex-wrap:wrap;align-items:center;margin-top:.12rem}
.reg-dur{font-family:'Space Mono',monospace;font-size:.875rem;color:var(--cyan);white-space:nowrap;flex-shrink:0}
[data-theme="light"] .reg-dur{color:var(--blue)}
.reg-acts{display:flex;gap:.35rem;flex-shrink:0}
.badge{padding:.13rem .5rem;border-radius:5px;font-size:.75rem}
[data-theme="dark"] .badge{background:var(--bg3);border:1px solid var(--bdr)}
[data-theme="light"] .badge{background:rgba(0,80,200,.07);border:1px solid rgba(0,80,200,.14)}
.badge-sl{border-color:var(--sleep)!important;color:#c4b5fd!important}
/* AN√ÅLISIS */
.dash-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.875rem;margin-top:1rem}
.dstat{border-radius:14px;padding:1.125rem 1.25rem}
[data-theme="dark"] .dstat{background:var(--bg2);border:1px solid var(--bdr)}
[data-theme="light"] .dstat{background:rgba(255,255,255,.65);border:1px solid rgba(0,80,200,.12);backdrop-filter:blur(12px)}
.dstat h4{font-size:.75rem;text-transform:uppercase;letter-spacing:.09em;color:var(--t3);margin-bottom:.55rem}
.dstat-v{font-family:'Space Mono',monospace;font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--cyan),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.dstat-s{font-size:.75rem;color:var(--t3);margin-top:.2rem}
.pie-layout{display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;justify-content:center}
.pie-wrap{position:relative;width:160px;height:160px;flex-shrink:0}
.pie-svg{width:100%;height:100%}
.pie-ctr{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.pie-pct{font-family:'Space Mono',monospace;font-size:1.375rem;font-weight:700;color:var(--cyan)}
[data-theme="light"] .pie-pct{color:var(--blue)}
.pie-sub{font-size:.6875rem;color:var(--t3)}
.pie-leg{flex:1;min-width:140px}
.leg-item{display:flex;align-items:center;gap:.5rem;margin-bottom:.4rem;font-size:.875rem}
.leg-dot{width:11px;height:11px;border-radius:3px;flex-shrink:0}
.leg-val{margin-left:auto;font-family:'Space Mono',monospace;font-size:.8125rem;color:var(--cyan)}
[data-theme="light"] .leg-val{color:var(--blue)}
/* BUTTONS */
.btn{background:linear-gradient(135deg,var(--cyan),var(--blue));color:var(--bg);border:none;border-radius:11px;padding:.75rem 1.375rem;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;white-space:nowrap;letter-spacing:.02em}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}.btn:active{transform:scale(.97)}
.btn-sm{padding:.5rem 1rem;font-size:.875rem}.btn-xs{padding:.35rem .7rem;font-size:.8125rem}
.btn-full{width:100%}.btn-ok{background:linear-gradient(135deg,var(--ok),#00cc70);color:#000}
.btn-del{background:linear-gradient(135deg,var(--del),#cc0044);color:#fff}
.btn-ghost{background:transparent;color:var(--cyan);border:1.5px solid var(--bdr)}
.btn-ghost:hover{border-color:var(--cyan)}
[data-theme="light"] .btn-ghost{color:var(--blue)}[data-theme="light"] .btn-ghost:hover{border-color:var(--blue)}
.ibtn{width:32px;height:32px;background:rgba(255,255,255,.04);border:1px solid var(--bdr);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.875rem;color:var(--t2);transition:all .15s}
.ibtn:hover{border-color:var(--cyan);color:var(--cyan)}.ibtn.del:hover{border-color:var(--del);color:var(--del)}
/* MODALS */
.overlay{display:none;position:fixed;inset:0;background:rgba(5,11,31,.88);backdrop-filter:blur(10px);z-index:900;align-items:flex-end;justify-content:center;padding:.75rem}
.overlay.open{display:flex}
.modal{border-radius:20px 20px 14px 14px;padding:1.625rem;width:100%;max-width:520px;max-height:92vh;overflow-y:auto}
[data-theme="dark"] .modal{background:var(--bg2);border:1px solid var(--bdr)}
[data-theme="light"] .modal{background:rgba(255,255,255,.92);border:1px solid rgba(0,80,200,.15);backdrop-filter:blur(20px)}
@media(min-width:540px){.overlay{align-items:center;padding:1.25rem}.modal{border-radius:20px}}
.mhd{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.375rem}
.mhd h2{font-size:1.1875rem;font-weight:700}
.mclose{width:32px;height:32px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all .15s}
[data-theme="dark"] .mclose{background:var(--bg3);border:1px solid var(--bdr);color:var(--t2)}
[data-theme="light"] .mclose{background:rgba(0,0,0,.07);border:1px solid rgba(0,0,0,.1);color:var(--t2)}
.mclose:hover{border-color:var(--cyan);color:var(--cyan)}
.fg{margin-bottom:1rem}.fg label{display:block;font-size:.875rem;font-weight:600;color:var(--t2);margin-bottom:.4rem}
.fg input,.fg select{width:100%;border-radius:10px;padding:.75rem 1.0625rem;font-family:inherit;font-size:1rem;transition:all .2s}
[data-theme="dark"] .fg input,[data-theme="dark"] .fg select{background:var(--bg3);border:1.5px solid var(--bdr);color:var(--t)}
[data-theme="light"] .fg input,[data-theme="light"] .fg select{background:rgba(255,255,255,.85);border:1.5px solid rgba(0,80,200,.2);color:var(--t)}
.fg input:focus,.fg select:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,255,255,.08)}
[data-theme="light"] .fg input:focus,[data-theme="light"] .fg select:focus{box-shadow:0 0 0 3px rgba(0,80,200,.08)}
input[type=color]{height:46px;cursor:pointer;padding:.2rem}
input[type=time]{font-family:'Space Mono',monospace}
input[type=range]{width:100%;accent-color:var(--cyan);cursor:pointer;margin:.35rem 0}
.r2{display:grid;grid-template-columns:1fr 1fr;gap:.875rem}
.mbtns{display:flex;gap:.75rem;margin-top:1.25rem}.mbtns .btn{flex:1}
.ibox{padding:.875rem 1rem;border-radius:9px;margin:.75rem 0;font-size:.875rem;color:var(--t2)}
[data-theme="dark"] .ibox{background:rgba(0,255,255,.04);border-left:3px solid var(--cyan)}
[data-theme="light"] .ibox{background:rgba(0,80,200,.05);border-left:3px solid var(--blue)}
.ibox.warn{border-left-color:var(--warn)}.ibox strong{display:block;margin-bottom:.2rem;color:var(--cyan)}.ibox.warn strong{color:var(--warn)}
.dur-tabs{display:flex;gap:.45rem;flex-wrap:wrap;margin-bottom:.875rem}
.dtab{border-radius:9px;padding:.5rem .9rem;cursor:pointer;font-size:.875rem;font-weight:600;color:var(--t2);transition:all .15s}
[data-theme="dark"] .dtab{background:var(--bg3);border:1.5px solid var(--bdr)}
[data-theme="light"] .dtab{background:rgba(0,0,0,.05);border:1.5px solid rgba(0,80,200,.14)}
.dtab:hover,.dtab.sel{border-color:var(--cyan);color:var(--cyan);background:rgba(0,255,255,.1)}
[data-theme="light"] .dtab:hover,[data-theme="light"] .dtab.sel{border-color:var(--blue);color:var(--blue);background:rgba(0,80,200,.08)}
.dur-big{font-family:'Space Mono',monospace;font-size:1.375rem;font-weight:700;color:var(--cyan);text-align:center;margin:.5rem 0}
[data-theme="light"] .dur-big{color:var(--blue)}
.dur-hints{display:flex;justify-content:space-between;font-size:.6875rem;color:var(--t3);margin-top:.2rem}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:.4rem;border-radius:10px;padding:.55rem;max-height:155px;overflow-y:auto;margin-top:.5rem}
[data-theme="dark"] .emoji-grid{background:var(--bg3)}[data-theme="light"] .emoji-grid{background:rgba(0,0,0,.04)}
.ep{font-size:1.4375rem;width:35px;height:35px;display:flex;align-items:center;justify-content:center;border-radius:7px;cursor:pointer;transition:background .15s;border:1.5px solid transparent}
.ep:hover{background:rgba(0,255,255,.1)}.ep.sel{background:rgba(0,255,255,.15);border-color:var(--cyan)}
[data-theme="light"] .ep.sel{background:rgba(0,80,200,.1);border-color:var(--blue)}
/* SETTINGS */
.s-list{display:flex;flex-direction:column;gap:.75rem;margin-top:.5rem}
.s-item{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.0625rem;border-radius:11px;cursor:pointer;transition:all .15s}
[data-theme="dark"] .s-item{background:var(--bg3);border:1px solid var(--bdr)}
[data-theme="light"] .s-item{background:rgba(0,80,200,.05);border:1px solid rgba(0,80,200,.12)}
.s-item:hover{border-color:var(--cyan)}
.s-left{display:flex;align-items:center;gap:.875rem}
.s-ic{font-size:1.375rem}.s-lbl{font-size:1rem;font-weight:600}.s-sub{font-size:.75rem;color:var(--t3)}.s-arr{color:var(--t3);font-size:.9375rem}
/* LOGIN */
.lscr{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:1rem;z-index:1000}
[data-theme="dark"] .lscr{background:var(--bg)}
[data-theme="light"] .lscr{background:linear-gradient(135deg,#d8eeff,#e4eeff,#ede8ff)}
.lbox{border-radius:22px;padding:2.25rem;max-width:400px;width:100%}
[data-theme="dark"] .lbox{background:var(--bg2);border:1px solid var(--bdr)}
[data-theme="light"] .lbox{background:rgba(255,255,255,.72);border:1px solid rgba(0,80,200,.15);backdrop-filter:blur(24px);box-shadow:0 24px 64px rgba(0,80,200,.1)}
.llogo{text-align:center;margin-bottom:1.625rem}
.llogo svg{height:44px;width:auto}
.lsub{color:var(--t2);font-size:.875rem;margin-top:.45rem}
.ltabs{display:flex;gap:.3rem;padding:.28rem;border-radius:10px;margin-bottom:1.375rem}
[data-theme="dark"] .ltabs{background:var(--bg3)}[data-theme="light"] .ltabs{background:rgba(0,0,0,.06)}
.ltab{flex:1;background:transparent;border:none;border-radius:9px;padding:.625rem;cursor:pointer;font-family:inherit;font-weight:600;font-size:.9375rem;color:var(--t2);transition:all .2s}
.ltab.active{background:linear-gradient(135deg,var(--cyan),var(--blue));color:#000;box-shadow:0 2px 8px rgba(0,255,255,.3)}
.lform{display:none}.lform.active{display:block}
.pin-row{display:flex;gap:.5rem;justify-content:center;margin:1rem 0}
.pin-d{width:56px;height:64px;border-radius:11px;color:var(--cyan);font-size:1.75rem;font-weight:700;text-align:center;font-family:'Space Mono',monospace;transition:all .2s}
[data-theme="dark"] .pin-d{background:var(--bg3);border:2px solid var(--bdr)}
[data-theme="light"] .pin-d{background:rgba(255,255,255,.85);border:2px solid rgba(0,80,200,.2)}
.pin-d:focus{outline:none;border-color:var(--cyan);transform:scale(1.06)}
.fmsg{padding:.75rem;border-radius:9px;margin:.6rem 0;text-align:center;font-weight:600;font-size:.875rem}
.fmsg.err{background:rgba(255,51,102,.09);border:1.5px solid var(--del);color:var(--del)}
.fmsg.ok{background:#90EE90;border:1.5px solid #5FD35F;color:#000;font-weight:600}
.hidden{display:none!important}
.spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:currentColor;border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
/* SLEEP */
.sl-ov{display:none;position:fixed;inset:0;background:rgba(5,11,31,.97);backdrop-filter:blur(12px);z-index:1100;align-items:center;justify-content:center;padding:1rem}
.sl-ov.open{display:flex}
.sl-pop{display:none;position:fixed;bottom:1.125rem;right:.875rem;left:.875rem;border-radius:16px;padding:1.25rem;z-index:660;max-width:360px;margin:0 auto}
[data-theme="dark"] .sl-pop{background:var(--bg2);border:1.5px solid var(--sleep);box-shadow:0 8px 32px rgba(124,58,237,.28)}
[data-theme="light"] .sl-pop{background:rgba(255,255,255,.92);border:1.5px solid var(--sleep);backdrop-filter:blur(20px)}
.sl-pop.open{display:block;animation:slu .3s ease}
@keyframes slu{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.empty{text-align:center;padding:2.25rem 1rem;color:var(--t3)}
.empty-ic{font-size:2.5rem;opacity:.2;margin-bottom:.5rem}
.empty h3{font-size:1.0625rem;color:var(--t);margin-bottom:.3rem}
.empty p{font-size:.875rem}
/* BOTTOM NAV */
.bot-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:var(--bn);z-index:600;align-items:center;justify-content:space-around;padding:0 .5rem}
[data-theme="dark"] .bot-nav{background:rgba(6,13,34,.98);border-top:1px solid rgba(26,51,102,.6);backdrop-filter:blur(24px);box-shadow:0 -4px 24px rgba(0,0,0,.3)}
[data-theme="light"] .bot-nav{background:rgba(255,255,255,.95);border-top:1px solid rgba(0,80,200,.15);backdrop-filter:blur(24px);box-shadow:0 -4px 20px rgba(0,80,200,.08)}
.bn-item{display:flex;flex-direction:column;align-items:center;gap:.25rem;cursor:pointer;padding:.5rem .875rem;border-radius:12px;color:var(--t3);flex:1;min-width:0;transition:all .2s}
.bn-item.active,.bn-item:hover{color:var(--cyan)}
.bn-item.active{background:rgba(0,255,255,.08)}
[data-theme="light"] .bn-item.active,[data-theme="light"] .bn-item:hover{color:var(--blue)}
[data-theme="light"] .bn-item.active{background:rgba(0,80,200,.08)}
.bn-ic{font-size:1.5rem}.bn-lbl{font-size:.6875rem;font-weight:700;white-space:nowrap;letter-spacing:.02em}
/* COIN ANIMATION */
.coin-ic{display:inline-block;font-size:1.25rem;opacity:.85;animation:coinSpin 4s ease-in-out infinite;filter:drop-shadow(0 0 4px rgba(255,210,0,.5));cursor:default}
@keyframes coinSpin{
  0%,100%{transform:rotateY(0deg) scale(1);filter:drop-shadow(0 0 4px rgba(255,210,0,.5))}
  25%{transform:rotateY(60deg) scale(.85);filter:drop-shadow(0 0 8px rgba(255,210,0,.8))}
  50%{transform:rotateY(90deg) scale(.1);filter:drop-shadow(0 0 2px rgba(255,210,0,.3))}
  75%{transform:rotateY(60deg) scale(.85);filter:drop-shadow(0 0 8px rgba(255,210,0,.8))}
}
.toast{position:fixed;bottom:calc(var(--bn) + 1rem);left:50%;transform:translateX(-50%) translateY(8px);background:var(--ok);color:#000;padding:.65rem 1.5rem;border-radius:12px;font-weight:700;font-size:.9375rem;z-index:9999;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;white-space:nowrap;box-shadow:0 4px 20px rgba(0,255,136,.35)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.err{background:var(--del);color:#fff;box-shadow:0 4px 20px rgba(255,51,102,.35)}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px}
@media(max-width:768px){
  :root{--hh:60px}
  .hdr{padding:0 1rem;gap:.625rem}
  .hdr-mantra{padding:.25rem .5rem}
  .hdr-mq{font-size:.6rem}
  .hdr-mv,.hdr-mph{font-size:.8125rem}
  .sb{display:none!important}.hdr{left:0!important}
  .layout{margin-left:0!important}
  .content{padding-bottom:calc(var(--bn) + 1rem)}
  .inner{padding:1.25rem 1rem 1.5rem}
  .bot-nav{display:flex}
  .split{grid-template-columns:1fr!important;gap:.875rem}
  .rm-card{flex-direction:row;text-align:left;min-height:auto;padding:1rem;gap:.875rem}
  .rm-ic{font-size:1.875rem}.rm-sub{display:none}
  .prog-bar{height:20px}.prog-num{font-size:1.5rem}
  .hstats{gap:.35rem}.hstat{padding:.28rem .625rem}.hstat-lbl{display:none}
  .r2{grid-template-columns:1fr}
  .tban-time{font-size:1.5rem}
  .tl-wrap{max-height:calc(100vh - 260px)}
}
@media(max-width:440px){
  .hstat:nth-child(n+3){display:none}.dash-grid{grid-template-columns:1fr}
  .qt-grid{grid-template-columns:1fr}.pin-d{width:50px;height:58px;font-size:1.5rem}
}
@media(min-width:769px){.bot-nav{display:none!important}}
</style>
</head>
<body>
<div id="toast" class="toast"></div>
<!-- SLEEP SETUP -->
<div class="sl-ov" id="slOv">
  <div class="modal" style="max-width:420px">
    <div style="text-align:center;margin-bottom:1.375rem">
      <div style="font-size:2.5rem;margin-bottom:.4rem">üò¥</div>
      <h2 style="font-size:1.375rem;background:linear-gradient(135deg,var(--cyan),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Configura tu Sue√±o</h2>
      <p style="color:var(--t2);font-size:.875rem;margin-top:.35rem">1440 lo registrar√° autom√°ticamente cada d√≠a</p>
    </div>
    <div class="r2">
      <div class="fg"><label>üåô Duermo a:</label><input type="time" id="ss-sl" value="22:30"></div>
      <div class="fg"><label>‚òÄÔ∏è Despierto a:</label><input type="time" id="ss-wk" value="07:00"></div>
    </div>
    <button class="btn btn-ok btn-full" onclick="saveSleepSetup()">Guardar Rutina</button>
  </div>
</div>

<!-- SLEEP POPUP -->
<div class="sl-pop" id="slPop">
  <div style="display:flex;align-items:center;gap:.65rem;margin-bottom:.875rem">
    <span style="font-size:1.5rem">üò¥</span>
    <div><div style="font-weight:700;font-size:1rem">¬øC√≥mo dormiste?</div><div style="font-size:.8125rem;color:var(--t2)">Actividad fuera de rutina</div></div>
  </div>
  <div class="r2" style="margin-bottom:.875rem">
    <div class="fg"><label>Dorm√≠ a:</label><input type="time" id="pop-sl"></div>
    <div class="fg"><label>Despert√© a:</label><input type="time" id="pop-wk"></div>
  </div>
  <div style="display:flex;gap:.5rem">
    <button class="btn btn-ok btn-full btn-sm" onclick="saveSleepPop()">Guardar</button>
    <button class="btn btn-ghost btn-sm" onclick="closeEl('slPop')">Ignorar</button>
  </div>
</div>

<!-- LOGIN -->
<div class="lscr" id="lscr">
  <div class="lbox">
    <div class="llogo">
      <svg viewBox="0 0 803 297" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M78.5156 213.543V62.6669H73.1622L53.5333 133.947H16.06V130.383L41.0422 43.0649H117.773V213.543H169.522V250.965H19.6289V213.543H78.5156ZM257.765 43.0649H332.116V174.339H362.452V211.761H332.116V250.965H292.859V211.761H200.067V157.707L257.765 43.0649ZM233.972 168.993V174.339H292.859V62.6669H287.505L233.972 168.993ZM446.53 43.0649H520.882V174.339H551.218V211.761H520.882V250.965H481.625V211.761H388.833V157.707L446.53 43.0649ZM422.738 168.993V174.339H481.625V62.6669H476.271L422.738 168.993Z" fill="url(#lg1)"/>
        <path d="M631.098 147.015C631.098 140.283 633.577 134.442 638.534 129.492C643.491 124.542 649.339 122.067 656.081 122.067C662.822 122.067 668.671 124.542 673.628 129.492C678.585 134.442 681.063 140.283 681.063 147.015C681.063 153.747 678.585 159.588 673.628 164.538C668.671 169.488 662.822 171.963 656.081 171.963C649.339 171.963 643.491 169.488 638.534 164.538C633.577 159.588 631.098 153.747 631.098 147.015ZM579.35 123.849V170.181C579.35 197.901 586.091 218.988 599.573 233.442C613.254 247.896 632.09 255.123 656.081 255.123C680.072 255.123 698.809 247.896 712.291 233.442C725.971 218.988 732.812 197.901 732.812 170.181V123.849C732.812 96.9207 725.971 76.032 712.291 61.182C698.809 46.332 680.072 38.907 656.081 38.907C632.09 38.907 613.254 46.332 599.573 61.182C586.091 76.032 579.35 96.9207 579.35 123.849Z" fill="url(#lg2)"/>
        <circle cx="656" cy="147" r="29.5" fill="#00FFFF" opacity=".95"/>
        <defs>
          <linearGradient id="lg1" x1="87" y1="-61" x2="489" y2="329" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFFF"/><stop offset="1" stop-color="#0066FF"/></linearGradient>
          <linearGradient id="lg2" x1="579" y1="39" x2="733" y2="255" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFFF"/><stop offset="1" stop-color="#00A0A0"/></linearGradient>
        </defs>
      </svg>
      <div class="lsub">Cada minuto cuenta</div>
    </div>
    <div class="ltabs">
      <button class="ltab active" onclick="swLT('login',event)">Ingresar</button>
      <button class="ltab" onclick="swLT('register',event)">Crear Cuenta</button>
    </div>
    <div class="lform active" id="lf-login">
      <div class="fg"><label>Usuario</label><input type="text" id="l-u" placeholder="Tu usuario" autocomplete="off" autocapitalize="none" onkeydown="if(event.key==='Enter')document.getElementById('lp1').focus()"></div>
      <div class="fg"><label>PIN</label>
        <div class="pin-row">
          <input type="password" maxlength="1" class="pin-d" id="lp1" oninput="pf(this,'lp2')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="lp2" oninput="pf(this,'lp3')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="lp3" oninput="pf(this,'lp4')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="lp4" oninput="autoLg()" inputmode="numeric">
        </div>
      </div>
      <div id="lErr" class="fmsg err hidden"></div>
      <button class="btn btn-full" onclick="doLogin()"><span id="lT">Ingresar</span><span id="lS" class="spin hidden"></span></button>
    </div>
    <div class="lform" id="lf-register">
      <div class="fg"><label>Elige un usuario √∫nico</label><input type="text" id="r-u" placeholder="Tu usuario" autocomplete="off" autocapitalize="none" onkeydown="if(event.key==='Enter')document.getElementById('rp1').focus()"></div>
      <div class="fg"><label>PIN de 4 d√≠gitos</label>
        <div class="pin-row">
          <input type="password" maxlength="1" class="pin-d" id="rp1" oninput="pf(this,'rp2')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="rp2" oninput="pf(this,'rp3')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="rp3" oninput="pf(this,'rp4')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="rp4" inputmode="numeric">
        </div>
      </div>
      <div class="ibox warn"><strong>‚ö†Ô∏è Recuerda</strong>Usuario √∫nico ¬∑ PIN personal ¬∑ Sin recuperaci√≥n</div>
      <div id="rErr" class="fmsg err hidden"></div>
      <div id="rOk" class="fmsg ok hidden"></div>
      <button class="btn btn-ok btn-full" onclick="doReg()"><span id="rT">Crear Cuenta</span><span id="rS" class="spin hidden"></span></button>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<nav class="sb" id="sb" style="display:none">
  <div class="sb-top">
    <svg class="sb-logo-svg" viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="42" fill="none" stroke="url(#sg)" stroke-width="14"/><circle cx="50" cy="50" r="18" fill="#00FFFF"/><defs><linearGradient id="sg" x1="0" y1="0" x2="100" y2="100" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFFF"/><stop offset="1" stop-color="#0066FF"/></linearGradient></defs></svg>
    <span class="sb-logo-txt">1440</span>
  </div>
  <div class="sb-nav">
    <div class="sb-item active" id="sn-home" onclick="goPage('home')"><span class="sb-ic">üè†</span><span class="sb-lbl">Inicio</span></div>
    <div class="sb-item" id="sn-tl" onclick="goPage('tl')"><span class="sb-ic">üìÖ</span><span class="sb-lbl">Timeline</span></div>
    <div class="sb-item" id="sn-areas" onclick="goPage('areas')"><span class="sb-ic">üìÅ</span><span class="sb-lbl">√Åreas de Vida</span></div>
    <div class="sb-item" id="sn-dash" onclick="goPage('dash')"><span class="sb-ic">üìä</span><span class="sb-lbl">An√°lisis</span></div>
    <div class="sb-item" id="sn-hist" onclick="goPage('hist')"><span class="sb-ic">üìã</span><span class="sb-lbl">Historial</span></div>
    <div class="sb-div"></div>
    <div class="sb-sec">Crear</div>
    <div class="sb-item" onclick="openM('areaM')"><span class="sb-ic">üóÇÔ∏è</span><span class="sb-lbl">Nueva √Årea</span></div>
    <div class="sb-item" onclick="openM('projM')"><span class="sb-ic">üìã</span><span class="sb-lbl">Nuevo Proyecto</span></div>
  </div>
  <div class="sb-bot">
    <div class="sb-item" onclick="openM('settingsM')"><span class="sb-ic">‚öôÔ∏è</span><span class="sb-lbl">Ajustes</span></div>
    <div class="sb-item" style="color:#ff6b6b" onclick="doLogout()"><span class="sb-ic">üö™</span><span class="sb-lbl">Salir</span></div>
  </div>
</nav>

<!-- HEADER -->
<header class="hdr" id="hdr" style="display:none">
  <div class="hdr-mantra" onclick="openM('mantraM')" title="Editar mantra">
    <div class="hdr-mq">¬øQui√©n quieres ser?</div>
    <div id="hdrM" class="hdr-mph">Escribe tu mantra...</div>
  </div>
  <div class="hstats">
    <div class="hstat" style="cursor:default"><span class="hstat-ic">‚ö°</span><span class="hstat-val" id="hs-t">0m</span><span class="hstat-lbl">activo</span></div>
    <div class="hstat" onclick="openSleepEdit()" title="Editar rutina de sue√±o" style="cursor:pointer"><span class="hstat-ic">üò¥</span><span class="hstat-val" id="hs-s">0m</span><span class="hstat-lbl">sue√±o</span></div>
  </div>
  <div class="ht" id="ht"><div class="ht-dot"></div><div class="ht-nm" id="htN">‚Äî</div><div class="ht-t" id="htT">00:00</div><button class="ht-x" onclick="stopTimer()">‚èπ</button></div>
  <button class="hdr-btn" id="themeBtn" onclick="toggleTheme()" title="Tema">üåô</button>
  <button class="hdr-btn" onclick="openM('settingsM')" title="Ajustes">‚öôÔ∏è</button>
</header>

<!-- MAIN -->
<div class="layout" id="mainLayout" style="display:none">
  <div class="content">
    <div class="inner">

      <!-- HOME -->
      <div class="page active" id="page-home">
        <div class="prog-wrap glass">
          <div class="prog-top">
            <div class="prog-left">
              <span class="coin-ic" title="Tu presupuesto diario de tiempo">ü™ô</span>
              <span class="prog-num" id="progMin">0</span>
              <span class="prog-of">/ 1440 min</span>
              <span class="prog-pct" id="progPct">0%</span>
            </div>
            <div style="font-family:'Space Mono',monospace;font-size:1rem;font-weight:700;color:var(--warn);text-align:right" id="progRemaining">‚Äî</div>
            <div class="prog-legend">
              <div class="pleg"><div class="pleg-dot" style="background:var(--cyan)"></div><strong id="legT" style="color:var(--cyan);font-family:'Space Mono',monospace">0m</strong></div>
              <div class="pleg"><div class="pleg-dot" style="background:var(--sleep)"></div><strong id="legS" style="color:#c4b5fd;font-family:'Space Mono',monospace">0m</strong></div>
            </div>
          </div>
          <div class="prog-bar">
            <div class="pb-t" id="pbT" style="width:0%"></div>
            <div class="pb-s" id="pbS" style="width:0%"></div>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:.625rem">
            <button class="btn btn-ghost btn-xs" onclick="openSiestaModal()" title="Registrar siesta">üí§ Registrar siesta</button>
          </div>
        </div>
        <div class="tban" id="tBan">
          <div class="tban-row">
            <div class="tban-left"><div class="tban-dot"></div><div><div class="tban-name" id="tbN">‚Äî</div><div class="tban-meta" id="tbM">‚Äî</div></div></div>
            <div class="tban-time" id="tbT">00:00:00</div>
          </div>
          <div class="tban-acts">
            <button class="btn btn-del btn-sm" onclick="stopTimer()">‚èπ Detener</button>
            <button class="btn btn-ghost btn-sm" onclick="switchAct()">üîÑ Cambiar</button>
          </div>
        </div>
        <div class="split">
          <div class="qt-card card" style="border-radius:16px">
            <div class="qt-lbl">‚ö° Quick Track ‚Äî 1 click</div>
            <div class="qt-grid" id="qtG"></div>
          </div>
          <div class="rm-card glass" onclick="openM('manM')">
            <div class="rm-ic">üìù</div>
            <div><div class="rm-lbl">Registro<br>Manual</div><div class="rm-sub">Tiempo pasado</div></div>
          </div>
        
        <!-- MINI DASHBOARD HOY -->
        <div class="card" style="border-radius:16px;padding:1.25rem;margin-top:1.125rem">
          <div style="font-size:.875rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--t3);margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between">
            <span>üìä Tu d√≠a en resumen</span>
            <button class="btn btn-ghost btn-xs" onclick="goPage('dash')">Ver an√°lisis completo ‚Üí</button>
          </div>
          <div class="pie-layout">
            <div class="pie-wrap"><svg class="pie-svg" id="pieSvgHome" viewBox="0 0 100 100"></svg><div class="pie-ctr"><div class="pie-pct" id="piePctHome">0%</div><div class="pie-sub">registrado</div></div></div>
            <div class="pie-leg" id="pieLegHome"></div>
          </div>
        </div>
</div>
      </div>

      <!-- TIMELINE -->
      <div class="page" id="page-tl">
        <div class="page-title">üìÖ Timeline</div>
        <div class="tl-reflect"><strong>üí≠ Reflexi√≥n del d√≠a</strong><span id="tlReflect"></span></div>
        <div class="card" style="border-radius:16px;padding:1.25rem">
          <div class="tl-head">
            <span id="tlTit" style="font-weight:700;font-size:1rem">Hoy</span>
            <input type="date" id="tlDate" onchange="renderTL()" style="background:var(--bg3);border:1.5px solid var(--bdr);border-radius:9px;padding:.4rem .75rem;color:var(--t);font-family:inherit;font-size:.875rem">
          </div>
          <div class="tl-wrap" id="tlW"></div>
        </div>
      </div>

      <!-- √ÅREAS -->
      <div class="page" id="page-areas">
        <div class="page-title">üìÅ √Åreas de Vida
          <div style="margin-left:auto;display:flex;gap:.5rem">
            <button class="btn btn-ghost btn-sm" onclick="openNewArea()">+ √Årea</button>
            <button class="btn btn-sm" onclick="openNewProj()">+ Proyecto</button>
          </div>
        </div>
        <div class="areas-list" id="areasC"></div>
      </div>

      <!-- HISTORIAL -->
      <div class="page" id="page-hist">
        <div class="page-title">üìã Historial
          <div style="margin-left:auto;display:flex;gap:.4rem">
            <button class="btn btn-ghost btn-xs" onclick="exportCSV()">CSV</button>
            <button class="btn btn-ghost btn-xs" onclick="openM('pdfM')">PDF</button>
          </div>
        </div>
        <div class="hist-filters">
          <input class="hf-in" type="text" id="hSrch" placeholder="üîç Buscar..." oninput="renderHist()">
          <select class="hf-sel" id="hArea" onchange="renderHist()"><option value="">Todas las √°reas</option></select>
          <select class="hf-sel" id="hPer" onchange="renderHist()">
            <option value="today">Hoy</option><option value="week">Esta semana</option>
            <option value="month">Este mes</option><option value="all">Todo</option>
          </select>
        </div>
        <div id="histC"></div>
      </div>

      <!-- AN√ÅLISIS -->
      <div class="page" id="page-dash">
        <div class="page-title">üìä An√°lisis</div>

        <!-- TENDENCIAS SEMANALES -->
        <div class="card" style="border-radius:16px;padding:1.5rem;margin-bottom:1.125rem">
          <h3 style="font-size:1.125rem;font-weight:700;margin-bottom:1.25rem;display:flex;align-items:center;gap:.5rem">
            üìà Tendencias Semanales
          </h3>
          <div id="trendsWeekly"></div>
        </div>

        <!-- COMPARATIVA SEMANAL -->
        <div class="card" style="border-radius:16px;padding:1.5rem;margin-bottom:1.125rem">
          <h3 style="font-size:1.125rem;font-weight:700;margin-bottom:1.25rem">‚öñÔ∏è Esta semana vs anterior</h3>
          <div id="weekComparison"></div>
        </div>

        <!-- STATS ORIGINALES -->
        <div class="card" style="border-radius:16px;padding:1.25rem;margin-bottom:1rem">
          <div style="font-size:.75rem;text-transform:uppercase;letter-spacing:.09em;color:var(--t3);margin-bottom:.875rem">Distribuci√≥n de hoy</div>
          <div class="pie-layout">
            <div class="pie-wrap"><svg class="pie-svg" id="pieSvg" viewBox="0 0 100 100"></svg><div class="pie-ctr"><div class="pie-pct" id="piePct">0%</div><div class="pie-sub">registrado</div></div></div>
            <div class="pie-leg" id="pieLeg"></div>
          </div>
        </div>
        <div class="dash-grid">
          <div class="dstat"><h4>üò¥ Sue√±o promedio</h4><div class="dstat-v" id="dSleep">‚Äî</div><div class="dstat-s">√öltimos 7 d√≠as</div></div>
          <div class="dstat"><h4>üï≥ Sin registrar</h4><div class="dstat-v" id="dEmpty">‚Äî</div><div class="dstat-s">Minutos vac√≠os hoy</div></div>
          <div class="dstat"><h4>‚ö° Tiempo activo</h4><div class="dstat-v" id="dTrack">‚Äî</div><div class="dstat-s">Hoy sin sue√±o</div></div>
          <div class="dstat"><h4>‚öñÔ∏è √Årea principal</h4><div class="dstat-v" id="dBal">‚Äî</div><div class="dstat-s" id="dBalS">% del tiempo activo hoy</div></div>
          <div class="dstat"><h4>üìÖ D√≠as</h4><div class="dstat-v" id="dDays">0</div><div class="dstat-s">Con registros</div></div>
          <div class="dstat"><h4>üî• Racha</h4><div class="dstat-v" id="dStreak">0</div><div class="dstat-s">D√≠as consecutivos</div></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bot-nav" id="botNav" style="display:none">
  <div class="bn-item active" id="bn-home" onclick="goPage('home')"><div class="bn-ic">üè†</div><div class="bn-lbl">Inicio</div></div>
  <div class="bn-item" id="bn-tl" onclick="goPage('tl')"><div class="bn-ic">üìÖ</div><div class="bn-lbl">Timeline</div></div>
  <div class="bn-item" id="bn-areas" onclick="goPage('areas')"><div class="bn-ic">üìÅ</div><div class="bn-lbl">√Åreas</div></div>
  <div class="bn-item" id="bn-dash" onclick="goPage('dash')"><div class="bn-ic">üìä</div><div class="bn-lbl">An√°lisis</div></div>
  <div class="bn-item" id="bn-hist" onclick="goPage('hist')"><div class="bn-ic">üìã</div><div class="bn-lbl">Historial</div></div>
</nav>

<!-- AREA MODAL -->
<div class="overlay" id="areaM">
  <div class="modal"><div class="mhd"><h2 id="aMTit">Nueva √Årea</h2><button class="mclose" onclick="closeM('areaM')">√ó</button></div>
    <input type="hidden" id="aEId">
    <div class="fg"><label>Nombre</label><input type="text" id="aNm" placeholder="Trabajo, Salud..."></div>
    <div class="fg"><label>Emoji</label><input type="text" id="aIc" placeholder="üíº" maxlength="2"><div class="emoji-grid" id="emojiG"></div></div>
    <div class="fg"><label>Color</label><input type="color" id="aCl" value="#00ffff"></div>
    <div class="mbtns"><button class="btn btn-ghost" onclick="closeM('areaM')">Cancelar</button><button class="btn" onclick="saveArea()">Guardar</button></div>
  </div>
</div>

<!-- PROJECT MODAL -->
<div class="overlay" id="projM">
  <div class="modal"><div class="mhd"><h2 id="pMTit">Nuevo Proyecto</h2><button class="mclose" onclick="closeM('projM')">√ó</button></div>
    <input type="hidden" id="pEId">
    <div class="fg"><label>√Årea</label><select id="pAr"><option value="">Sin √°rea</option></select></div>
    <div class="fg"><label>Nombre</label><input type="text" id="pNm" placeholder="Cliente ABC..."></div>
    <div class="fg"><label>Color</label><input type="color" id="pCl" value="#0066ff"></div>
    <div class="mbtns"><button class="btn btn-ghost" onclick="closeM('projM')">Cancelar</button><button class="btn" onclick="saveProj()">Guardar</button></div>
  </div>
</div>

<!-- MANUAL REGISTRO ‚Äî hora inicio/fin real -->
<div class="overlay" id="manM">
  <div class="modal">
    <div class="mhd"><h2>üìù Registro Manual</h2><button class="mclose" onclick="closeM('manM')">√ó</button></div>
    <div class="fg"><label>¬øQu√© hiciste?</label><input type="text" id="mDes" placeholder="Describe la actividad..."></div>
    <div class="r2">
      <div class="fg"><label>√Årea</label><select id="mAr" onchange="updMPr()"><option value="">Sin √°rea</option></select></div>
      <div class="fg"><label>Proyecto</label><select id="mPr"><option value="">Sin proyecto</option></select></div>
    </div>
    <div style="display:flex;gap:.5rem;margin-bottom:.875rem">
      <button class="dtab sel" id="modeBtn-dur" onclick="setManualMode('dur')">‚è± Duraci√≥n</button>
      <button class="dtab" id="modeBtn-time" onclick="setManualMode('time')">üïê Hora exacta</button>
    </div>
    <div id="manMode-dur">
      <div class="fg">
        <label>Duraci√≥n</label>
        <div class="dur-big" id="durDisp">30 min</div>
        <div class="dur-tabs" id="durTabsEl">
          <div class="dtab" onclick="setDur(15)">15m</div>
          <div class="dtab sel" onclick="setDur(30)">30m</div>
          <div class="dtab" onclick="setDur(45)">45m</div>
          <div class="dtab" onclick="setDur(60)">1h</div>
          <div class="dtab" onclick="setDur(90)">1h30</div>
          <div class="dtab" onclick="setDur(120)">2h</div>
        </div>
        <input type="range" id="durSldr" min="5" max="240" step="5" value="30" oninput="onSldr(this.value)">
        <div class="dur-hints"><span>5m</span><span>1h</span><span>2h</span><span>4h</span></div>
      </div>
    </div>
    <div id="manMode-time" style="display:none">
      <div class="fg"><label>Fecha</label><input type="date" id="mDt"></div>
      <div class="r2">
        <div class="fg"><label>üïê Inicio</label><input type="time" id="mSt"></div>
        <div class="fg"><label>üïë Fin</label><input type="time" id="mEn"></div>
      </div>
    </div>
    <button class="btn btn-full" onclick="saveManual()">+ Registrar</button>
  </div>
</div>

<!-- EDIT ENTRY -->
<div class="overlay" id="editM">
  <div class="modal"><div class="mhd"><h2>‚úèÔ∏è Editar Registro</h2><button class="mclose" onclick="closeM('editM')">√ó</button></div>
    <input type="hidden" id="eId">
    <div class="fg"><label>Descripci√≥n</label><input type="text" id="eDes"></div>
    <div class="r2">
      <div class="fg"><label>√Årea</label><select id="eAr" onchange="updEPr()"><option value="">Sin √°rea</option></select></div>
      <div class="fg"><label>Proyecto</label><select id="ePr"><option value="">Sin proyecto</option></select></div>
    </div>
    <div class="fg"><label>Fecha</label><input type="date" id="eDt"></div>
    <div class="r2"><div class="fg"><label>Inicio</label><input type="time" id="eSt"></div><div class="fg"><label>Fin</label><input type="time" id="eEn"></div></div>
    <div class="mbtns"><button class="btn btn-ghost" onclick="closeM('editM')">Cancelar</button><button class="btn" onclick="updateReg()">Guardar</button></div>
  </div>
</div>

<!-- EDIT SLEEP ENTRY -->
<div class="overlay" id="sleepEditM">
  <div class="modal" style="max-width:380px">
    <div class="mhd"><h2>üò¥ Editar Sue√±o</h2><button class="mclose" onclick="closeM('sleepEditM')">√ó</button></div>
    <input type="hidden" id="slEId">
    <div class="r2">
      <div class="fg"><label>üåô Dorm√≠ a:</label><input type="time" id="slESt"></div>
      <div class="fg"><label>‚òÄÔ∏è Despert√© a:</label><input type="time" id="slEEn"></div>
    </div>
    <div class="mbtns"><button class="btn btn-ghost" onclick="closeM('sleepEditM')">Cancelar</button><button class="btn btn-ok" onclick="saveSleepEdit()">Guardar</button></div>
  </div>
</div>

<!-- CONFIRM MODAL (sin native confirm/prompt) -->
<div class="overlay" id="confirmM">
  <div class="modal" style="max-width:380px">
    <div style="text-align:center;padding:.5rem 0 .25rem">
      <div style="font-size:2.5rem;margin-bottom:.75rem" id="confirmIc">‚ö†Ô∏è</div>
      <div style="font-size:1.0625rem;font-weight:700;margin-bottom:.35rem" id="confirmMsg">¬øEst√°s seguro?</div>
      <div style="font-size:.875rem;color:var(--t2)" id="confirmSub"></div>
    </div>
    <div class="mbtns" style="margin-top:1.5rem">
      <button class="btn btn-ghost" onclick="resolveConfirm(false)">Cancelar</button>
      <button class="btn btn-del" id="confirmOkBtn" onclick="resolveConfirm(true)">Eliminar</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="overlay" id="settingsM">
  <div class="modal" style="max-width:440px">
    <div class="mhd"><h2>‚öôÔ∏è Ajustes</h2><button class="mclose" onclick="closeM('settingsM')">√ó</button></div>
    <div class="s-list">
      <div class="s-item" onclick="openSleepEdit();closeM('settingsM')"><div class="s-left"><span class="s-ic">üò¥</span><div><div class="s-lbl">Rutina de Sue√±o</div><div class="s-sub" id="sleepSub">‚Äî</div></div></div><span class="s-arr">‚Ä∫</span></div>
      <div class="s-item" onclick="openM('mantraM');closeM('settingsM')"><div class="s-left"><span class="s-ic">üåü</span><div><div class="s-lbl">Mi Mantra</div><div class="s-sub">Tu frase motivacional</div></div></div><span class="s-arr">‚Ä∫</span></div>
      <div class="s-item" onclick="exportCSV();closeM('settingsM')"><div class="s-left"><span class="s-ic">üìä</span><div><div class="s-lbl">Exportar CSV</div><div class="s-sub">Todos tus registros</div></div></div><span class="s-arr">‚Üì</span></div>
      <div class="s-item" onclick="openM('pdfM');closeM('settingsM')"><div class="s-left"><span class="s-ic">üìÑ</span><div><div class="s-lbl">Exportar PDF</div><div class="s-sub">Reporte completo</div></div></div><span class="s-arr">‚Üì</span></div>
      <div class="s-item" style="border-color:rgba(255,51,102,.25)" onclick="doLogout()"><div class="s-left"><span class="s-ic">üö™</span><div><div class="s-lbl" style="color:var(--del)">Cerrar Sesi√≥n</div><div class="s-sub" id="sUser">‚Äî</div></div></div></div>
    </div>
  </div>
</div>

<!-- SLEEP ROUTINE EDIT -->
<div class="overlay" id="sleepEM">
  <div class="modal" style="max-width:380px">
    <div class="mhd"><h2>üò¥ Rutina de Sue√±o</h2><button class="mclose" onclick="closeM('sleepEM')">√ó</button></div>
    <div class="r2"><div class="fg"><label>üåô Duermo a:</label><input type="time" id="eSl"></div><div class="fg"><label>‚òÄÔ∏è Despierto a:</label><input type="time" id="eWk"></div></div>
    <div class="mbtns"><button class="btn btn-ghost" onclick="closeM('sleepEM')">Cancelar</button><button class="btn btn-ok" onclick="updSleepR()">Guardar</button></div>
  </div>
</div>

<!-- PDF EXPORT MODAL -->
<div class="overlay" id="pdfM">
  <div class="modal" style="max-width:400px">
    <div class="mhd"><h2>üìÑ Exportar PDF</h2><button class="mclose" onclick="closeM('pdfM')">√ó</button></div>
    <p style="color:var(--t2);font-size:.9375rem;margin-bottom:1.25rem">¬øQu√© per√≠odo deseas exportar?</p>
    <div style="display:flex;flex-direction:column;gap:.5rem">
      <button class="btn btn-ghost" style="justify-content:flex-start;gap:.75rem" onclick="exportPDF('today');closeM('pdfM')">üìÖ <span>Solo hoy</span></button>
      <button class="btn btn-ghost" style="justify-content:flex-start;gap:.75rem" onclick="exportPDF('week');closeM('pdfM')">üìÜ <span>Esta semana (7 d√≠as)</span></button>
      <button class="btn btn-ghost" style="justify-content:flex-start;gap:.75rem" onclick="exportPDF('month');closeM('pdfM')">üóìÔ∏è <span>Este mes (30 d√≠as)</span></button>
      <button class="btn btn-ghost" style="justify-content:flex-start;gap:.75rem" onclick="exportPDF('all');closeM('pdfM')">üìã <span>Todo el historial</span></button>
    </div>
  </div>
</div>

<!-- SIESTA MODAL -->
<div class="overlay" id="siestaM">
  <div class="modal" style="max-width:400px">
    <div class="mhd"><h2>üí§ Registrar Siesta</h2><button class="mclose" onclick="closeM('siestaM')">√ó</button></div>
    <div class="r2">
      <div class="fg"><label>‚è∞ Inicio</label><input type="time" id="siest-st"></div>
      <div class="fg"><label>‚è∞ Fin</label><input type="time" id="siest-en"></div>
    </div>
    <div class="fg"><label>Fecha</label><input type="date" id="siest-dt"></div>
    <div class="mbtns"><button class="btn btn-ghost" onclick="closeM('siestaM')">Cancelar</button><button class="btn btn-ok" onclick="saveSiesta()">üí§ Guardar Siesta</button></div>
  </div>
</div>

<!-- MANTRA -->
<div class="overlay" id="mantraM">
  <div class="modal" style="max-width:480px">
    <div class="mhd"><h2>üåü Tu Mantra</h2><button class="mclose" onclick="closeM('mantraM')">√ó</button></div>
    <p style="color:var(--t2);font-size:.9375rem;margin-bottom:.75rem">Tu recordatorio diario. Aparecer√° en el header.</p>
    <div class="fg">
      <label style="font-size:1rem;margin-bottom:.625rem">¬øQui√©n quieres ser hoy?</label>
      <input type="text" id="manIn" placeholder="Ej: Hoy elijo el progreso sobre la perfecci√≥n" maxlength="80" style="font-size:1.0625rem;padding:.875rem 1.125rem">
    </div>
    <div style="background:rgba(0,255,255,.04);border-left:3px solid var(--cyan);padding:.75rem 1rem;border-radius:8px;margin:.875rem 0;font-size:.8125rem;color:var(--t2)">
      <strong style="display:block;margin-bottom:.3rem;color:var(--cyan);font-size:.75rem">üí° EJEMPLOS</strong>
      "Cada minuto es una nueva oportunidad"<br>
      "Mi tiempo es mi poder"<br>
      "Hoy importa m√°s que ayer"
    </div>
    <div class="mbtns"><button class="btn btn-ghost" onclick="closeM('mantraM')">Cancelar</button><button class="btn" onclick="saveMantra()">Guardar Mantra</button></div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

/*
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
 MIGRACI√ìN DE BASE DE DATOS NECESARIA:
 
 ALTER TABLE users ADD COLUMN IF NOT EXISTS mantra TEXT;
 
 Este campo almacenar√° el mantra del usuario en lugar de localStorage.
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
*/

const SB='https://ilzxgnqylmycktwsrfcr.supabase.co';
const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsenhnbnF5bG15Y2t0d3NyZmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTg0OTAsImV4cCI6MjA4NjMzNDQ5MH0.MkXUo8CjpH2QTUuLpoqA0LRHwTzC9p4WiFn1lFmk0d4';
const {createClient}=supabase; const sb=createClient(SB,SK);
let user=null, db={areas:[],projects:[],entries:[]};
let timerIv=null, timerStart=null, selDur=30, manualMode='dur';
let confirmResolve=null;


/* ‚îÄ‚îÄ FAVICON BADGE ‚îÄ‚îÄ */
const FAVICON_NORMAL='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'44\' fill=\'none\' stroke=\'url(%23g)\' stroke-width=\'12\'/%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'19\' fill=\'%2300FFFF\'/%3E%3Cdefs%3E%3ClinearGradient id=\'g\'%3E%3Cstop stop-color=\'%2300FFFF\'/%3E%3Cstop offset=\'1\' stop-color=\'%230066FF\'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E';
const FAVICON_ACTIVE='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'44\' fill=\'none\' stroke=\'url(%23g)\' stroke-width=\'12\'/%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'19\' fill=\'%2300FF88\'/%3E%3Ccircle cx=\'75\' cy=\'25\' r=\'15\' fill=\'%2300FF88\'/%3E%3Cdefs%3E%3ClinearGradient id=\'g\'%3E%3Cstop stop-color=\'%2300FFFF\'/%3E%3Cstop offset=\'1\' stop-color=\'%230066FF\'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E';
function updateFavicon(active){
  const link=document.querySelector('link[rel*="icon"]')||document.createElement('link');
  link.type='image/svg+xml';link.rel='icon';
  link.href=active?FAVICON_ACTIVE:FAVICON_NORMAL;
  document.head.appendChild(link);
}

/* ‚îÄ‚îÄ THEME ‚îÄ‚îÄ */
function toggleTheme(){
  const t=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('themeBtn').textContent=t==='dark'?'üåô':'‚òÄÔ∏è';
  localStorage.setItem('1440_theme',t);
}
(()=>{const s=localStorage.getItem('1440_theme')||'dark';document.documentElement.setAttribute('data-theme',s)})();

/* ‚îÄ‚îÄ TZ helpers ‚îÄ‚îÄ */
function localDate(d){if(!d)d=new Date();return[d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('-')}
function today(){return localDate()}
function fmtT(iso){try{return new Date(iso).toLocaleTimeString([],{hour:'numeric',minute:'2-digit',hour12:true})}catch{return'--:--'}}
function fmtTInput(iso){try{const d=new Date(iso);return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}catch{return''}}
function fmtDay(d){try{return new Date(d+'T12:00:00').toLocaleDateString([],{weekday:'short',day:'numeric',month:'short'})}catch{return d}}


/* ‚îÄ‚îÄ REFLEXIONES ‚îÄ‚îÄ */
const REFLEXIONES=[
  "Si hoy fuera el √∫ltimo d√≠a de mi vida, ¬øestar√≠a orgulloso de lo que voy a hacer hoy?",
  "El tiempo es el recurso m√°s democr√°tico: todos tenemos 1440 minutos al d√≠a",
  "No se trata de tener tiempo, se trata de crear tiempo",
  "Cada minuto es una elecci√≥n entre qui√©n eres y qui√©n quieres ser",
  "La productividad no es hacer m√°s cosas, es hacer las cosas correctas",
  "Tu atenci√≥n determina tu realidad",
  "El tiempo que disfrutas perdiendo no es tiempo perdido",
  "Hoy importa m√°s que ayer",
  "El progreso es mejor que la perfecci√≥n",
  "Peque√±as acciones diarias crean grandes resultados",
  "Tu futuro yo te agradecer√° el tiempo que inviertes hoy",
  "Lo urgente rara vez es importante, y lo importante rara vez es urgente"
];
function getReflexion(){
  const d=new Date();
  const dayOfYear=Math.floor((d-new Date(d.getFullYear(),0,0))/86400000);
  return REFLEXIONES[dayOfYear%REFLEXIONES.length];
}

/* ‚îÄ‚îÄ EMOJIS ‚îÄ‚îÄ */
const EM=['üíº','üíª','üì±','üéØ','üèãÔ∏è','‚ù§Ô∏è','üè†','üìö','üé®','üéµ','üå±','‚úàÔ∏è','üçé','üí°','üî¨','üéÆ','üí∞','ü§ù','üåç','‚ö°','üî•','üí™','üßò','üë®‚Äçüë©‚Äçüëß','üéì','üõ†Ô∏è','üìä','üåô','‚òÄÔ∏è','‚≠ê','üöÄ','üé≠','üçï','üé¨','üèÜ','ü¶Å'];
function buildEmoji(){document.getElementById('emojiG').innerHTML=EM.map(e=>`<div class="ep" onclick="pickE('${e}')" data-e="${e}">${e}</div>`).join('')}
function pickE(e){document.getElementById('aIc').value=e;document.querySelectorAll('.ep').forEach(el=>el.classList.toggle('sel',el.dataset.e===e))}

/* ‚îÄ‚îÄ SOUNDS ‚îÄ‚îÄ */
function beep(f=880,d=80,v=.2){try{const c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=f;o.type='sine';g.gain.setValueAtTime(v,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+d/1000);o.start();o.stop(c.currentTime+d/1000);setTimeout(()=>c.close(),d+150)}catch(e){}}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
let _toastTimer=null;
function showToast(msg,isErr=false){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast'+(isErr?' err':'');
  if(_toastTimer)clearTimeout(_toastTimer);
  requestAnimationFrame(()=>{t.classList.add('show');_toastTimer=setTimeout(()=>t.classList.remove('show'),2500)});
}

/* ‚îÄ‚îÄ SIESTA ‚îÄ‚îÄ */
function openSiestaModal(){
  const now=new Date();
  const h=String(now.getHours()).padStart(2,'0'),m=String(now.getMinutes()).padStart(2,'0');
  document.getElementById('siest-dt').value=today();
  document.getElementById('siest-en').value=`${h}:${m}`;
  const prev=new Date(now.getTime()-30*60000);
  document.getElementById('siest-st').value=String(prev.getHours()).padStart(2,'0')+':'+String(prev.getMinutes()).padStart(2,'0');
  openM('siestaM');
}
async function saveSiesta(){
  const st=document.getElementById('siest-st').value,en=document.getElementById('siest-en').value,dt=document.getElementById('siest-dt').value;
  if(!st||!en||!dt)return showToast('Completa todos los campos',true);
  const start=new Date(dt+'T'+st+':00'),end=new Date(dt+'T'+en+':00');
  let dur=Math.floor((end-start)/1000);
  if(dur<=0){showToast('La hora de fin debe ser posterior',true);return}
  const pl={user_id:user.id,type:'sleep',subtype:'siesta',description:'Siesta üí§',start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,date:dt};
  const{data,error}=await sb.from('time_entries').insert([pl]).select().single();
  if(error){showToast('Error al guardar',true);return}
  db.entries.unshift(data);closeM('siestaM');renderAll();showToast('üí§ Siesta guardada ‚úì');
}

/* ‚îÄ‚îÄ CUSTOM CONFIRM (reemplaza native confirm/prompt) ‚îÄ‚îÄ */
function askConfirm(msg,sub='',ic='‚ö†Ô∏è',btnLbl='Eliminar'){
  return new Promise(res=>{
    confirmResolve=res;
    document.getElementById('confirmIc').textContent=ic;
    document.getElementById('confirmMsg').textContent=msg;
    document.getElementById('confirmSub').textContent=sub||'';
    document.getElementById('confirmOkBtn').textContent=btnLbl;
    openM('confirmM');
  });
}
function resolveConfirm(v){closeM('confirmM');if(confirmResolve){confirmResolve(v);confirmResolve=null}}

/* ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ */
const PAGES=['home','tl','areas','hist','dash'];
function goPage(name){
  PAGES.forEach(p=>document.getElementById('page-'+p)?.classList.remove('active'));
  document.getElementById('page-'+name)?.classList.add('active');
  document.querySelectorAll('.sb-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('sn-'+name)?.classList.add('active');
  document.querySelectorAll('.bn-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('bn-'+name)?.classList.add('active');
  if(name==='tl')renderTL();
  if(name==='dash')renderDash();
  if(name==='hist')renderHist();
  if(name==='areas')renderAreas();
}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
function swLT(t,ev){document.querySelectorAll('.ltab').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.lform').forEach(e=>e.classList.remove('active'));ev.target.classList.add('active');document.getElementById('lf-'+t).classList.add('active');document.getElementById(t==='login'?'l-u':'r-u').focus()}
function pf(el,nid){if(el.value.length===1)document.getElementById(nid)?.focus()}
function getPin(p){return['1','2','3','4'].map(i=>document.getElementById(p+i)?.value||'').join('')}
function autoLg(){setTimeout(()=>{if(getPin('lp').length===4)doLogin()},80)}

async function doReg(){
  const u=document.getElementById('r-u').value.trim().toLowerCase(),pin=getPin('rp');
  if(!u)return smsg('rErr','Ingresa un usuario');
  if(pin.length!==4)return smsg('rErr','PIN de 4 d√≠gitos requerido');
  if(!/^[a-z0-9_]{3,20}$/.test(u))return smsg('rErr','3-20 chars: letras, n√∫meros, _');
  setBL('rT','rS',true);
  try{
    const{data:ex}=await sb.from('users').select('id').eq('username',u).maybeSingle();
    if(ex)return smsg('rErr','Usuario ya existe');
    const{data:nd,error}=await sb.from('users').insert([{username:u,pin}]).select().single();
    if(error)throw error;
    user=nd; smsg('rOk','¬°Cuenta creada!',true);
    setTimeout(()=>{clearPins('rp');document.getElementById('slOv').classList.add('open')},1200);
  }catch(e){smsg('rErr','Error: '+e.message)}finally{setBL('rT','rS',false)}
}

async function doLogin(){
  const u=document.getElementById('l-u').value.trim().toLowerCase(),pin=getPin('lp');
  if(!u)return smsg('lErr','Ingresa tu usuario');
  if(pin.length!==4)return smsg('lErr','PIN incompleto');
  setBL('lT','lS',true);
  try{
    const{data:ud}=await sb.from('users').select('*').eq('username',u).eq('pin',pin).maybeSingle();
    if(!ud){clearPins('lp');document.getElementById('lp1').focus();return smsg('lErr','Usuario o PIN incorrecto')}
    user=ud; await loadAll(); launchApp();
    if(!ud.sleep_routine?.enabled)document.getElementById('slOv').classList.add('open');
    else await procSleep();
    if(ud.active_timer?.start){timerStart=new Date(ud.active_timer.start);resumeTimerUI(ud.active_timer.name,ud.active_timer.meta)}
  }catch(e){smsg('lErr','Error de conexi√≥n: '+e.message)}finally{setBL('lT','lS',false)}
}

function launchApp(){
  document.getElementById('lscr').style.display='none';
  document.getElementById('hdr').style.display='flex';
  document.getElementById('mainLayout').style.display='flex';
  document.getElementById('sb').style.display='flex';
  document.getElementById('themeBtn').textContent=document.documentElement.getAttribute('data-theme')==='dark'?'üåô':'‚òÄÔ∏è';
  document.getElementById('sUser').textContent='@'+user.username;
  const r=user.sleep_routine;
  document.getElementById('sleepSub').textContent=r?.enabled?`${r.sleep_time} ‚Äì ${r.wake_time}`:'No configurado';
  if(window.innerWidth<=768)document.getElementById('botNav').style.display='flex';
  document.getElementById('tlDate').value=today();
  buildEmoji(); loadMantra(); renderAll();
}

function doLogout(){
  if(timerIv)clearInterval(timerIv);
  user=null;timerStart=null;db={areas:[],projects:[],entries:[]};
  ['hdr','mainLayout','sb','botNav'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none'});
  document.getElementById('lscr').style.display='flex';
  closeM('settingsM');clearPins('lp');
  document.getElementById('l-u').focus();
}

/* ‚îÄ‚îÄ SLEEP ‚îÄ‚îÄ */
async function saveSleepSetup(){
  const st=document.getElementById('ss-sl').value,wt=document.getElementById('ss-wk').value;if(!st||!wt)return;
  await sb.from('users').update({sleep_routine:{enabled:true,sleep_time:st,wake_time:wt}}).eq('id',user.id);
  user.sleep_routine={enabled:true,sleep_time:st,wake_time:wt};
  document.getElementById('slOv').classList.remove('open');
  document.getElementById('sleepSub').textContent=`${st} ‚Äì ${wt}`;
  if(document.getElementById('mainLayout').style.display==='none')launchApp();
  await procSleep();
}
async function procSleep(){
  if(!user?.sleep_routine?.enabled)return;
  const r=user.sleep_routine;
  const yest=new Date();yest.setDate(yest.getDate()-1);const yStr=localDate(yest);
  const{data:ex}=await sb.from('time_entries').select('id').eq('user_id',user.id).eq('type','sleep').eq('date',yStr).maybeSingle();
  if(ex)return;
  const sleepStart=new Date(yStr+'T'+r.sleep_time+':00'),wakeEnd=new Date(today()+'T'+r.wake_time+':00');
  const{data:late}=await sb.from('time_entries').select('end_time').eq('user_id',user.id).eq('type','tracked').gte('end_time',sleepStart.toISOString()).order('end_time',{ascending:false}).limit(1);
  if(late?.length){
    const ap=new Date(new Date(late[0].end_time).getTime()+30*60000);
    document.getElementById('pop-sl').value=String(ap.getHours()).padStart(2,'0')+':'+String(ap.getMinutes()).padStart(2,'0');
    document.getElementById('pop-wk').value=r.wake_time;
    document.getElementById('slPop').classList.add('open');
  }else{
    const dur=Math.floor((wakeEnd-sleepStart)/1000);
    if(dur>0&&dur<86400){
      const{data}=await sb.from('time_entries').insert([{user_id:user.id,type:'sleep',description:'Sue√±o',start_time:sleepStart.toISOString(),end_time:wakeEnd.toISOString(),duration:dur,date:yStr,auto_detected:true}]).select().single();
      if(data){db.entries.unshift(data);renderAll()}
    }
  }
}
async function saveSleepPop(){
  const yest=new Date();yest.setDate(yest.getDate()-1);const yStr=localDate(yest);
  const st=document.getElementById('pop-sl').value,wt=document.getElementById('pop-wk').value;if(!st||!wt)return;
  const start=new Date(yStr+'T'+st+':00'),end=new Date(today()+'T'+wt+':00');
  const dur=Math.floor((end-start)/1000);if(dur<=0)return;
  const{data}=await sb.from('time_entries').insert([{user_id:user.id,type:'sleep',description:'Sue√±o',start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,date:yStr}]).select().single();
  if(data)db.entries.unshift(data);closeEl('slPop');renderAll();
}
function openSleepEdit(){document.getElementById('eSl').value=user.sleep_routine?.sleep_time||'22:30';document.getElementById('eWk').value=user.sleep_routine?.wake_time||'07:00';openM('sleepEM')}
async function updSleepR(){
  const st=document.getElementById('eSl').value,wt=document.getElementById('eWk').value;if(!st||!wt)return;
  await sb.from('users').update({sleep_routine:{enabled:true,sleep_time:st,wake_time:wt}}).eq('id',user.id);
  user.sleep_routine={enabled:true,sleep_time:st,wake_time:wt};
  document.getElementById('sleepSub').textContent=`${st} ‚Äì ${wt}`;
  closeM('sleepEM');renderAll();showToast('Rutina de sue√±o guardada ‚úì');
}
function openSleepEntryEdit(id){
  const e=db.entries.find(x=>x.id===id);if(!e)return;
  document.getElementById('slEId').value=id;
  document.getElementById('slESt').value=fmtTInput(e.start_time);
  document.getElementById('slEEn').value=fmtTInput(e.end_time);
  openM('sleepEditM');
}
async function saveSleepEdit(){
  const id=document.getElementById('slEId').value;
  const e=db.entries.find(x=>x.id===id);if(!e)return;
  const st=document.getElementById('slESt').value,en=document.getElementById('slEEn').value;
  const start=new Date(e.date+'T'+st+':00');
  let end=new Date(e.date+'T'+en+':00');
  let dur=Math.floor((end-start)/1000);
  if(dur<=0){end=new Date(end.getTime()+86400000);dur=Math.floor((end-start)/1000)}
  await sb.from('time_entries').update({start_time:start.toISOString(),end_time:end.toISOString(),duration:dur}).eq('id',id);
  const i=db.entries.findIndex(x=>x.id===id);
  if(i>-1)db.entries[i]={...db.entries[i],start_time:start.toISOString(),end_time:end.toISOString(),duration:dur};
  closeM('sleepEditM');renderAll();showToast('Sue√±o actualizado ‚úì');
}

/* ‚îÄ‚îÄ MANTRA ‚îÄ‚îÄ */
function loadMantra(){
  const v=user?.mantra||'';
  const el=document.getElementById('hdrM');
  el.textContent=v||'Escribe tu mantra...';
  el.className=v?'hdr-mv':'hdr-mph'
}
async async function saveMantra(){
  const v=document.getElementById('manIn').value.trim();
  if(!v)return showToast('Escribe tu mantra',true);
  await sb.from('users').update({mantra:v}).eq('id',user.id);
  user.mantra=v;
  loadMantra();
  closeM('mantraM');
  showToast('üåü Mantra guardado');
}).eq('id',user.id);user.mantra=v;}loadMantra();closeM('mantraM');showToast('Mantra guardado ‚úì')}

/* ‚îÄ‚îÄ DATA ‚Äî SIN L√çMITE ‚îÄ‚îÄ */
async function loadAll(){
  const[a,p,e]=await Promise.all([
    sb.from('categories').select('*').eq('user_id',user.id).order('created_at'),
    sb.from('projects').select('*').eq('user_id',user.id).order('created_at'),
    sb.from('time_entries').select('*').eq('user_id',user.id).order('start_time',{ascending:false})
    // Sin .limit() ‚Äî fix bug de truncado silencioso
  ]);
  db.areas=a.data||[];db.projects=p.data||[];db.entries=e.data||[];
}
function renderAll(){updProg();renderQT();updSelects();renderMiniDash()}

/* ‚îÄ‚îÄ PROGRESS ‚Äî dual segment cyan + purple + sue√±o fallback ‚îÄ‚îÄ */
function updProg(){
  const dayE=db.entries.filter(e=>e.date===today());
  const tM=dayE.filter(e=>e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  let sM=dayE.filter(e=>e.type==='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  // Fallback: si no hay entradas de sue√±o hoy, usar sleep_routine preestablecida
  if(!sM&&user?.sleep_routine?.enabled){
    const r=user.sleep_routine;
    const base=new Date('2000-01-01T00:00:00');
    const sl=new Date('2000-01-01T'+r.sleep_time+':00');
    const wk=new Date('2000-01-01T'+r.wake_time+':00');
    const mins=wk>sl?Math.round((wk-sl)/60000):Math.round((wk.getTime()+86400000-sl.getTime())/60000);
    if(mins>0&&mins<720)sM=mins;
  }
  const tot=tM+sM;
  const tP=Math.min((tM/1440)*100,100);
  const sP=Math.min((sM/1440)*100,Math.max(0,100-tP));
  const remaining=Math.max(0,1440-tot);
  document.getElementById('progMin').textContent=tot;
  document.getElementById('progPct').textContent=Math.floor((tot/1440)*100)+'%';
  document.getElementById('progRemaining').textContent=fmtM(remaining)+' quedan';
  document.getElementById('pbT').style.width=tP+'%';
  document.getElementById('pbS').style.width=sP+'%';
  document.getElementById('legT').textContent=fmtM(tM);
  document.getElementById('legS').textContent=fmtM(sM);
  document.getElementById('hs-t').textContent=fmtM(tM);
  document.getElementById('hs-s').textContent=fmtM(sM);
}

/* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
function resumeTimerUI(name,meta){
  document.getElementById('tBan').classList.add('on');
  document.getElementById('tbN').textContent=name;
  document.getElementById('tbM').textContent=meta||'';
  document.getElementById('ht').classList.add('on');
  document.getElementById('htN').textContent=name;
  if(timerIv)clearInterval(timerIv);
  timerIv=setInterval(()=>{
    const el=Math.floor((Date.now()-timerStart.getTime())/1000);
    document.getElementById('tbT').textContent=fmtS(el);
    document.getElementById('htT').textContent=String(Math.floor(el/3600)).padStart(2,'0')+':'+String(Math.floor((el%3600)/60)).padStart(2,'0');
  },1000);
  renderQT();
}
async function startTimer(id,type,name,meta){
  if(timerIv)clearInterval(timerIv);
  timerStart=new Date();
  beep(880,70,.2);setTimeout(()=>beep(1100,70,.15),90);
  const t={id,type,name,meta,start:timerStart.toISOString()};
  user.active_timer=t;
  await sb.from('users').update({active_timer:t}).eq('id',user.id);
  resumeTimerUI(name,meta);
}
async function stopTimer(){
  if(!timerStart)return;
  if(timerIv){clearInterval(timerIv);timerIv=null}
  beep(440,120,.18);
  const end=new Date(),dur=Math.floor((end-timerStart)/1000);
  const t=user.active_timer||{};
  if(dur>5){
    const pl={user_id:user.id,type:'tracked',description:t.name||'Actividad',start_time:timerStart.toISOString(),end_time:end.toISOString(),duration:dur,date:localDate(timerStart)};
    if(t.type==='project')pl.project_id=t.id;if(t.type==='area')pl.category_id=t.id;
    const{data}=await sb.from('time_entries').insert([pl]).select().single();if(data)db.entries.unshift(data);
  }
  user.active_timer=null;await sb.from('users').update({active_timer:null}).eq('id',user.id);
  timerStart=null;
  document.getElementById('tBan').classList.remove('on');
  document.getElementById('ht').classList.remove('on');
  updateFavicon(false);
  renderAll();
}
function switchAct(){stopTimer()}

/* ‚îÄ‚îÄ QUICK TRACK ‚Äî todos los items, scroll ‚îÄ‚îÄ */
function renderQT(){
  const g=document.getElementById('qtG');
  const items=[
    ...db.areas.map(a=>({id:a.id,type:'area',name:a.name,icon:a.icon||'üìÅ',color:a.color,sub:'√Årea'})),
    ...db.projects.map(p=>{const ar=db.areas.find(a=>a.id===p.category_id);return{id:p.id,type:'project',name:p.name,icon:ar?.icon||'üìå',color:p.color,sub:ar?.name||'Proyecto'}})
  ];
  // Ordenar por frecuencia de uso
  items.forEach(it=>{
    it.useCount=db.entries.filter(e=>e.category_id===it.id||e.project_id===it.id).length;
  });
  items.sort((a,b)=>b.useCount-a.useCount); // Sin .slice(0,8) ‚Äî fix ocultar sin feedback
  if(!items.length){g.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:1.25rem;color:var(--t3)"><button class="btn btn-sm" onclick="openNewArea()">‚ûï Crear √Årea</button></div>`;return}
  // Agregar bot√≥n de siesta al inicio
  const siestaBtn=`<div class="qt-item qt-siesta" onclick="openSiestaModal()" style="border-color:#7c3aed35;background:rgba(124,58,237,.05)">
    <div><div class="qt-nm">üí§ Siesta</div><div class="qt-st">Registro r√°pido</div></div>
    <div class="qt-play" style="background:linear-gradient(135deg,#7c3aed,#5b21b6)">‚ñ∂</div>
  </div>`;
  const active=user?.active_timer;
  g.innerHTML=siestaBtn+items.map(it=>{
    const on=active&&active.id===it.id;
    const m=db.entries.filter(e=>e.date===today()&&(e.category_id===it.id||e.project_id===it.id)).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const col=it.color||'';
    return`<div class="qt-item${on?' on':''}" style="${col?'border-color:'+col+'35':''}"
      onclick="${on?'stopTimer()':'startTimer(\''+it.id+'\',\''+it.type+'\',\''+esc(it.name)+'\',\''+esc(it.sub)+'\')'}" >
      <div><div class="qt-nm">${it.icon} ${it.name}</div><div class="qt-st">${fmtM(m)}</div></div>
      <div class="qt-play" style="${!on&&col?'background:linear-gradient(135deg,'+col+','+col+'99)':''}">${on?'‚èπ':'‚ñ∂'}</div>
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ TIMELINE ‚Äî openManualAt FIXED: prellenar hora ‚îÄ‚îÄ */
function renderTL(){
  const ds=document.getElementById('tlDate').value||today();
  document.getElementById('tlReflect').textContent='\"'+getReflexion()+'\"';
  document.getElementById('tlTit').textContent=ds===today()?'Hoy ‚Äî '+fmtDay(ds):fmtDay(ds);
  const dayE=db.entries.filter(e=>e.date===ds);
  const r=user?.sleep_routine;
  let html='';
  for(let h=0;h<24;h++){
    const lbl=String(h).padStart(2,'0')+':00';
    let isSl=false;
    if(r?.enabled){const sh=parseInt(r.sleep_time?.split(':')[0]||22),wh=parseInt(r.wake_time?.split(':')[0]||7);isSl=sh>wh?(h>=sh||h<wh):(h>=sh&&h<wh)}
    const inH=dayE.filter(e=>{if(!e.start_time||!e.end_time)return false;const s=new Date(e.start_time).getHours(),en=new Date(e.end_time).getHours();return h>=s&&h<=en});
    let inner='';
    if(inH.length){
      inner=inH.map(e=>{
        const cls=e.type==='sleep'?'tl-sleep':'tl-tracked';
        const pj=db.projects.find(p=>p.id===e.project_id);
        const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
        const txt=e.description+(pj?' ¬∑ '+pj.name:'');
        const isSiesta=e.subtype==='siesta';
        const sleepIcon=isSiesta?'üí§':'üò¥';
        const slBtn=e.type==='sleep'?`<button class="sl-edit" onclick="event.stopPropagation();openSleepEntryEdit('${e.id}')">‚úèÔ∏è</button>`:'';
        const actBtns=e.type!=='sleep'
          ?`<div class="tl-acts"><button class="tl-abtn edit" onclick="event.stopPropagation();openEditE('${e.id}')" title="Editar">‚úèÔ∏è</button><button class="tl-abtn del" onclick="event.stopPropagation();delEntry('${e.id}')" title="Eliminar">üóëÔ∏è</button></div>`
          :`<div class="tl-acts"><button class="tl-abtn edit" onclick="event.stopPropagation();openSleepEntryEdit('${e.id}')" title="Editar sue√±o">‚úèÔ∏è</button><button class="tl-abtn del" onclick="event.stopPropagation();delEntry('${e.id}')" title="Eliminar">üóëÔ∏è</button></div>`;
        return`<div class="tl-e ${cls}" onclick="${e.type!=='sleep'?'openEditE(\''+e.id+'\')':'openSleepEntryEdit(\''+e.id+'\')'}">
          ${e.type==='sleep'?sleepIcon+' ':(ar?.icon?ar.icon+' ':'')}${txt}${slBtn}
          <span class="tl-dur">${fmtS(e.duration)}</span>
          ${actBtns}
        </div>`;
      }).join('');
    }else if(isSl&&ds===today()){
      inner=`<div class="tl-e tl-sleep">üò¥ ${r.sleep_time}‚Äì${r.wake_time}</div>`;
    }else{
      inner=`<div class="tl-e tl-gap">‚Äî</div>`;
    }
    html+=`<div class="tl-row"><div class="tl-lbl">${lbl}</div><div class="tl-col">${inner}<button class="tl-add" onclick="openManualAt('${ds}',${h})">+</button></div></div>`;
  }
  const w=document.getElementById('tlW');w.innerHTML=html;
  if(ds===today()){const ch=new Date().getHours();const rows=w.querySelectorAll('.tl-row');if(rows[Math.max(0,ch-1)])requestAnimationFrame(()=>rows[Math.max(0,ch-1)].scrollIntoView({block:'center'}))}
}

/* openManualAt ‚Äî FIXED: prellenar fecha + hora ‚îÄ‚îÄ */
function openManualAt(date,hour){
  updSelects();
  setManualMode('time');
  document.getElementById('mDt').value=date||today();
  document.getElementById('mSt').value=String(hour).padStart(2,'0')+':00';
  document.getElementById('mEn').value=String(Math.min(hour+1,23)).padStart(2,'0')+':00';
  openM('manM');
}

/* ‚îÄ‚îÄ MANUAL MODE ‚îÄ‚îÄ */
function setManualMode(mode){
  manualMode=mode;
  document.getElementById('manMode-dur').style.display=mode==='dur'?'block':'none';
  document.getElementById('manMode-time').style.display=mode==='time'?'block':'none';
  document.getElementById('modeBtn-dur').classList.toggle('sel',mode==='dur');
  document.getElementById('modeBtn-time').classList.toggle('sel',mode==='time');
}

/* ‚îÄ‚îÄ DUR TABS ‚îÄ‚îÄ */
function setDur(v){
  selDur=v;
  document.getElementById('durSldr').value=v;
  updDurUI(v);
  document.querySelectorAll('#durTabsEl .dtab').forEach(el=>el.classList.remove('sel'));
  const map={15:0,30:1,45:2,60:3,90:4,120:5};
  if(map[v]!==undefined)document.querySelectorAll('#durTabsEl .dtab')[map[v]]?.classList.add('sel');
}
function onSldr(v){selDur=parseInt(v);updDurUI(v);const map={15:0,30:1,45:2,60:3,90:4,120:5};document.querySelectorAll('#durTabsEl .dtab').forEach(el=>el.classList.remove('sel'));if(map[v]!==undefined)document.querySelectorAll('#durTabsEl .dtab')[map[v]]?.classList.add('sel')}
function updDurUI(v){v=parseInt(v);const h=Math.floor(v/60),m=v%60;document.getElementById('durDisp').textContent=h>0?(m>0?`${h}h ${m}min`:`${h}h`):v+' min'}

/* ‚îÄ‚îÄ SAVE MANUAL ‚Äî con modo hora exacta ‚îÄ‚îÄ */
async function saveManual(){
  const desc=document.getElementById('mDes').value.trim();if(!desc)return alert('Describe la actividad');
  let start,end,dur,dateStr;
  if(manualMode==='dur'){
    end=new Date();start=new Date(end.getTime()-selDur*60000);
    dur=selDur*60;dateStr=localDate(start);
  }else{
    dateStr=document.getElementById('mDt').value||today();
    const st=document.getElementById('mSt').value,et=document.getElementById('mEn').value;
    if(!st||!et)return alert('Ingresa hora de inicio y fin');
    start=new Date(dateStr+'T'+st+':00');end=new Date(dateStr+'T'+et+':00');
    dur=Math.floor((end-start)/1000);
    if(dur<=0)return alert('La hora de fin debe ser posterior al inicio');
  }
  const pl={user_id:user.id,type:'tracked',description:desc,
    project_id:document.getElementById('mPr').value||null,
    category_id:document.getElementById('mAr').value||null,
    start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,date:dateStr};
  const{data,error}=await sb.from('time_entries').insert([pl]).select().single();
  if(error)return showToast('Error: '+error.message,true);
  db.entries.unshift(data);closeM('manM');
  document.getElementById('mDes').value='';renderAll();showToast('Registro guardado ‚úì');
}

/* ‚îÄ‚îÄ AREAS ‚îÄ‚îÄ */
function renderAreas(){
  const c=document.getElementById('areasC');
  if(!db.areas.length){c.innerHTML=`<div class="empty"><div class="empty-ic">üìÅ</div><h3>Sin √°reas</h3><p>Crea tu primera √°rea</p><br><button class="btn btn-sm" onclick="openNewArea()">‚ûï Nueva √Årea</button></div>`;return}
  c.innerHTML=db.areas.map((a,i)=>{
    const pjs=db.projects.filter(p=>p.category_id===a.id);
    const tm=db.entries.filter(e=>e.category_id===a.id||db.projects.find(p=>p.id===e.project_id)?.category_id===a.id).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const col=a.color||'#00ffff';
    return`<div class="area-card card" style="border-color:${col}20">
      <div class="area-head" onclick="togA('ab${i}','ac${i}')">
        <div class="area-hl"><div class="area-stripe" style="background:${col}"></div><span class="area-ic">${a.icon||'üìÅ'}</span><div><div class="area-nm">${a.name}</div><div class="area-cnt">${pjs.length} proy.</div></div></div>
        <div class="area-hr"><span class="area-tot" style="color:${col}">${fmtM(tm)}</span><div class="ibtn" onclick="event.stopPropagation();openEditArea('${a.id}')">‚úèÔ∏è</div><div class="ibtn del" onclick="event.stopPropagation();delArea('${a.id}')">üóëÔ∏è</div><span class="area-chev" id="ac${i}">‚Ä∫</span></div>
      </div>
      <div class="area-body" id="ab${i}"><div class="proj-stack">${pjs.map(p=>projRow(p)).join('')}</div><div style="margin-top:.625rem"><button class="btn btn-ghost btn-sm" onclick="openNewProjFor('${a.id}')">+ Proyecto</button></div></div>
    </div>`;
  }).join('')+(()=>{const uc=db.projects.filter(p=>!p.category_id);if(!uc.length)return'';return`<div class="area-card card"><div class="area-head" onclick="togA('ab-u','ac-u')"><div class="area-hl"><div class="area-stripe" style="background:#5580b3"></div><span class="area-ic">üìå</span><div><div class="area-nm">Sin √Årea</div><div class="area-cnt">${uc.length}</div></div></div><div class="area-hr"><span class="area-chev" id="ac-u">‚Ä∫</span></div></div><div class="area-body" id="ab-u"><div class="proj-stack">${uc.map(p=>projRow(p)).join('')}</div></div></div>`})();
}
function projRow(p){const m=db.entries.filter(e=>e.project_id===p.id).reduce((s,e)=>s+Math.floor(e.duration/60),0);return`<div class="proj-row"><div class="proj-dot" style="background:${p.color||'#0066ff'}"></div><div class="proj-inf"><div class="proj-nm">${p.name}</div><div class="proj-st">${fmtM(m)}</div></div><div class="proj-acts"><div class="ibtn" onclick="startTimer('${p.id}','project','${esc(p.name)}','Proyecto')">‚ñ∂</div><div class="ibtn" onclick="openEditProj('${p.id}')">‚úèÔ∏è</div><div class="ibtn del" onclick="delProj('${p.id}')">üóëÔ∏è</div></div></div>`}
function togA(bid,cid){const b=document.getElementById(bid),c=document.getElementById(cid);if(!b)return;const op=b.classList.contains('open');b.classList.toggle('open',!op);if(c)c.classList.toggle('open',!op)}

/* ‚îÄ‚îÄ HISTORIAL ‚Äî grouped by day ‚îÄ‚îÄ */
function renderHist(){
  const c=document.getElementById('histC');
  let f=[...db.entries];
  const q=document.getElementById('hSrch').value.toLowerCase();
  if(q)f=f.filter(e=>e.description?.toLowerCase().includes(q));
  const af=document.getElementById('hArea').value;
  if(af){const ps=db.projects.filter(p=>p.category_id===af).map(p=>p.id);f=f.filter(e=>e.category_id===af||ps.includes(e.project_id))}
  const per=document.getElementById('hPer').value;const n=new Date();
  if(per==='today')f=f.filter(e=>e.date===today());
  else if(per==='week'){const w=new Date(n);w.setDate(w.getDate()-7);f=f.filter(e=>new Date(e.date+'T12:00:00')>=w)}
  else if(per==='month'){const m=new Date(n);m.setMonth(m.getMonth()-1);f=f.filter(e=>new Date(e.date+'T12:00:00')>=m)}
  if(!f.length){c.innerHTML=`<div class="empty"><div class="empty-ic">üìã</div><h3>Sin registros</h3><p>Usa Quick Track o Registro Manual</p></div>`;return}
  const grp={};f.forEach(e=>{if(!grp[e.date])grp[e.date]=[];grp[e.date].push(e)});
  const dates=Object.keys(grp).sort((a,b)=>b.localeCompare(a));
  c.innerHTML=dates.map((date,di)=>{
    const entries=grp[date];
    const totalM=entries.reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const isT=date===today();
    const rows=entries.map(e=>{
      const pj=db.projects.find(p=>p.id===e.project_id);
      const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
      const col=e.type==='sleep'?'#7c3aed':(ar?.color||'#00ffff');
      return`<div class="reg-item">
        <div class="reg-bar" style="background:${col}"></div>
        <div class="reg-body"><div class="reg-desc">${e.description}</div>
          <div class="reg-meta"><span>${fmtT(e.start_time)}‚Äì${fmtT(e.end_time)}</span>${ar?`<span class="badge" style="border-color:${ar.color}40">${ar.icon||''} ${ar.name}</span>`:''} ${e.type==='sleep'?`<span class="badge badge-sl">üò¥</span>`:''}</div>
        </div>
        <div class="reg-dur">${fmtS(e.duration)}</div>
        <div class="reg-acts">${e.type!=='sleep'?`<div class="ibtn" onclick="openEditE('${e.id}')">‚úèÔ∏è</div>`:''}${e.type==='sleep'?`<div class="ibtn" onclick="openSleepEntryEdit('${e.id}')">‚úèÔ∏è</div>`:''}<div class="ibtn del" onclick="delEntry('${e.id}')">üóëÔ∏è</div></div>
      </div>`;
    }).join('');
    return`<div class="day-group">
      <div class="day-head" onclick="togDay('dy${di}','dc${di}')">
        <div class="day-date">${isT?'üìÖ Hoy':'üìÜ '+fmtDay(date)}</div>
        <div class="day-stats"><span class="day-dur">${fmtM(totalM)}</span><span class="day-cnt">${entries.length}</span><span class="day-chev${isT?' open':''}" id="dc${di}">‚Ä∫</span></div>
      </div>
      <div class="day-entries${isT?' open':''}" id="dy${di}">${rows}</div>
    </div>`;
  }).join('');
}
function togDay(bid,cid){const b=document.getElementById(bid),c=document.getElementById(cid);if(!b)return;const op=b.classList.contains('open');b.classList.toggle('open',!op);if(c)c.classList.toggle('open',!op)}


/* ‚îÄ‚îÄ MINI DASHBOARD (Inicio) ‚îÄ‚îÄ */
function renderMiniDash(){
  const dayE=db.entries.filter(e=>e.date===today());
  const bk={};let tot=0;
  dayE.forEach(e=>{const m=Math.floor(e.duration/60);tot+=m;if(e.type==='sleep'){bk['üò¥ Sue√±o']=(bk['üò¥ Sue√±o']||0)+m;return}const pj=db.projects.find(p=>p.id===e.project_id);const a=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);const lbl=a?(a.icon||'')+' '+a.name:'Sin √°rea';bk[lbl]=(bk[lbl]||0)+m});
  const empty=1440-tot;if(empty>0)bk['‚¨õ Vac√≠o']=empty;
  const C=['#00ffff','#7c3aed','#0066ff','#00ff88','#ff3366','#ffaa00','#8b5cf6','#374151'];
  let ang=0,paths='',leg='';
  Object.entries(bk).forEach(([lbl,m],i)=>{
    const pc=m/1440,sa=ang;ang+=pc*360;
    const r=40,cx=50,cy=50,ir=22;
    const a1=sa*Math.PI/180-Math.PI/2,a2=ang*Math.PI/180-Math.PI/2;
    const x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1),x2=cx+r*Math.cos(a2),y2=cy+r*Math.sin(a2);
    const xi1=cx+ir*Math.cos(a1),yi1=cy+ir*Math.sin(a1),xi2=cx+ir*Math.cos(a2),yi2=cy+ir*Math.sin(a2);
    const lg=pc>.5?1:0,col=C[i%C.length];
    paths+=`<path d="M${xi1} ${yi1} L${x1} ${y1} A${r} ${r} 0 ${lg} 1 ${x2} ${y2} L${xi2} ${yi2} A${ir} ${ir} 0 ${lg} 0 ${xi1} ${yi1} Z" fill="${col}" opacity=".9"/>`;
    leg+=`<div class="leg-item"><div class="leg-dot" style="background:${col}"></div><span style="font-size:.8125rem">${lbl}</span><span class="leg-val">${fmtM(m)}</span></div>`;
  });
  document.getElementById('pieSvgHome').innerHTML=paths;
  document.getElementById('pieLegHome').innerHTML=leg;
  document.getElementById('piePctHome').textContent=Math.floor((tot/1440)*100)+'%';
}


/* ‚îÄ‚îÄ TENDENCIAS ‚îÄ‚îÄ */
function renderTrends(){
  const now=new Date();
  const thisWeek=[],lastWeek=[];
  for(let i=0;i<7;i++){
    const d=new Date(now);d.setDate(d.getDate()-i);
    thisWeek.push(localDate(d));
    const d2=new Date(now);d2.setDate(d2.getDate()-i-7);
    lastWeek.push(localDate(d2));
  }
  
  // Calcular minutos por √°rea esta semana
  const thisWeekByArea={};
  db.entries.filter(e=>thisWeek.includes(e.date)&&e.type!=='sleep').forEach(e=>{
    const pj=db.projects.find(p=>p.id===e.project_id);
    const a=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
    if(a){
      thisWeekByArea[a.name]=(thisWeekByArea[a.name]||0)+Math.floor(e.duration/60);
    }
  });
  
  // Calcular semana pasada
  const lastWeekByArea={};
  db.entries.filter(e=>lastWeek.includes(e.date)&&e.type!=='sleep').forEach(e=>{
    const pj=db.projects.find(p=>p.id===e.project_id);
    const a=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
    if(a){
      lastWeekByArea[a.name]=(lastWeekByArea[a.name]||0)+Math.floor(e.duration/60);
    }
  });
  
  // Renderizar comparaci√≥n
  const allAreas=new Set([...Object.keys(thisWeekByArea),...Object.keys(lastWeekByArea)]);
  let html='<div style="display:flex;flex-direction:column;gap:.75rem">';
  allAreas.forEach(area=>{
    const thisW=thisWeekByArea[area]||0;
    const lastW=lastWeekByArea[area]||0;
    const diff=thisW-lastW;
    const trend=diff>0?'üìà':'üìâ';
    const trendColor=diff>0?'var(--ok)':'var(--del)';
    const pct=lastW>0?Math.round((diff/lastW)*100):0;
    html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;border-radius:10px;background:var(--bg3)">
      <div><strong>${area}</strong></div>
      <div style="display:flex;align-items:center;gap:1rem">
        <span style="font-family:'Space Mono',monospace">${fmtM(thisW)}</span>
        <span style="color:${trendColor};font-weight:700">${trend} ${Math.abs(pct)}%</span>
      </div>
    </div>`;
  });
  html+='</div>';
  document.getElementById('weekComparison').innerHTML=html;
  
  // Gr√°fico de tendencia semanal simple
  let trendHtml='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:.5rem">';
  thisWeek.reverse().forEach((date,i)=>{
    const dayEntries=db.entries.filter(e=>e.date===date&&e.type!=='sleep');
    const mins=dayEntries.reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const height=Math.min((mins/180)*100,100); // max 3h = 100%
    const dayName=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'][new Date(date+'T12:00').getDay()];
    trendHtml+=`<div style="text-align:center">
      <div style="height:120px;display:flex;align-items:flex-end;justify-content:center">
        <div style="width:100%;background:linear-gradient(180deg,var(--cyan),var(--blue));border-radius:6px 6px 0 0;height:${height}%;min-height:${mins>0?'8px':'0'}"></div>
      </div>
      <div style="font-size:.7rem;color:var(--t3);margin-top:.3rem">${dayName}</div>
      <div style="font-family:'Space Mono',monospace;font-size:.75rem;font-weight:700;color:var(--cyan)">${fmtM(mins)}</div>
    </div>`;
  });
  trendHtml+='</div>';
  document.getElementById('trendsWeekly').innerHTML=trendHtml;
}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function renderDash(){
  const dayE=db.entries.filter(e=>e.date===today());
  const bk={};let tot=0;
  dayE.forEach(e=>{const m=Math.floor(e.duration/60);tot+=m;if(e.type==='sleep'){bk['üò¥ Sue√±o']=(bk['üò¥ Sue√±o']||0)+m;return}const pj=db.projects.find(p=>p.id===e.project_id);const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);const lbl=ar?(ar.icon||'')+' '+ar.name:'Sin √°rea';bk[lbl]=(bk[lbl]||0)+m});
  const empty=1440-tot;if(empty>0)bk['‚¨õ Vac√≠o']=empty;
  const C=['#00ffff','#7c3aed','#0066ff','#00ff88','#ff3366','#ffaa00','#8b5cf6','#374151'];
  let ang=0,paths='',leg='';
  Object.entries(bk).forEach(([lbl,m],i)=>{
    const pc=m/1440,sa=ang;ang+=pc*360;
    const r=40,cx=50,cy=50,ir=22;
    const a1=sa*Math.PI/180-Math.PI/2,a2=ang*Math.PI/180-Math.PI/2;
    const x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1),x2=cx+r*Math.cos(a2),y2=cy+r*Math.sin(a2);
    const xi1=cx+ir*Math.cos(a1),yi1=cy+ir*Math.sin(a1),xi2=cx+ir*Math.cos(a2),yi2=cy+ir*Math.sin(a2);
    const lg=pc>.5?1:0,col=C[i%C.length];
    paths+=`<path d="M${xi1} ${yi1} L${x1} ${y1} A${r} ${r} 0 ${lg} 1 ${x2} ${y2} L${xi2} ${yi2} A${ir} ${ir} 0 ${lg} 0 ${xi1} ${yi1} Z" fill="${col}" opacity=".9"/>`;
    leg+=`<div class="leg-item"><div class="leg-dot" style="background:${col}"></div><span>${lbl}</span><span class="leg-val">${fmtM(m)}</span></div>`;
  });
  document.getElementById('pieSvg').innerHTML=paths;
  document.getElementById('pieLeg').innerHTML=leg;
  document.getElementById('piePct').textContent=Math.floor((tot/1440)*100)+'%';
  const w=new Date();w.setDate(w.getDate()-7);
  const sE=db.entries.filter(e=>e.type==='sleep'&&new Date(e.date+'T12:00:00')>=w);
  document.getElementById('dSleep').textContent=fmtM(Math.round(sE.length?sE.reduce((s,e)=>s+e.duration,0)/sE.length/60:0));
  document.getElementById('dEmpty').textContent=fmtM(1440-tot);
  const trNS=dayE.filter(e=>e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  document.getElementById('dTrack').textContent=fmtM(trNS);
  // Calcular √°rea con m√°s tiempo hoy
  const areaStats={};
  dayE.filter(e=>e.type!=='sleep').forEach(e=>{
    const pj=db.projects.find(p=>p.id===e.project_id);
    const a=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
    if(a){
      areaStats[a.id]=(areaStats[a.id]||{name:a.name,icon:a.icon,mins:0});
      areaStats[a.id].mins+=Math.floor(e.duration/60);
    }
  });
  const topArea=Object.values(areaStats).sort((a,b)=>b.mins-a.mins)[0];
  if(topArea){
    document.getElementById('dTopArea').textContent=`${topArea.icon||'üìÅ'} ${topArea.name}`;
  }else{
    document.getElementById('dTopArea').textContent='‚Äî';
  }
  const uD=new Set(db.entries.filter(e=>e.type!=='sleep').map(e=>e.date)).size;document.getElementById('dDays').textContent=uD;
  let streak=0,d=new Date();for(let i=0;i<365;i++){const ds=localDate(d);if(db.entries.some(e=>e.date===ds&&e.type!=='sleep')){streak++;d.setDate(d.getDate()-1)}else break}document.getElementById('dStreak').textContent=streak;
}

/* ‚îÄ‚îÄ SELECTS ‚îÄ‚îÄ */
function updSelects(){
  const opts='<option value="">Sin √°rea</option>'+db.areas.map(a=>`<option value="${a.id}">${a.icon||''} ${a.name}</option>`).join('');
  ['pAr','mAr','eAr','hArea'].forEach(id=>{const el=document.getElementById(id);if(!el)return;const v=el.value;el.innerHTML=opts;el.value=v});
  updMPr();updEPr();
}
function updMPr(){const aid=document.getElementById('mAr')?.value;const ps=aid?db.projects.filter(p=>p.category_id===aid):db.projects;document.getElementById('mPr').innerHTML='<option value="">Sin proyecto</option>'+ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}
function updEPr(){const aid=document.getElementById('eAr')?.value;const ps=aid?db.projects.filter(p=>p.category_id===aid):db.projects;document.getElementById('ePr').innerHTML='<option value="">Sin proyecto</option>'+ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}

/* ‚îÄ‚îÄ AREA CRUD ‚îÄ‚îÄ */
function openNewArea(){document.getElementById('aEId').value='';document.getElementById('aMTit').textContent='Nueva √Årea';document.getElementById('aNm').value='';document.getElementById('aIc').value='';buildEmoji();openM('areaM')}
function openEditArea(id){const a=db.areas.find(x=>x.id===id);if(!a)return;document.getElementById('aEId').value=id;document.getElementById('aMTit').textContent='Editar √Årea';document.getElementById('aNm').value=a.name;document.getElementById('aIc').value=a.icon||'';document.getElementById('aCl').value=a.color||'#00ffff';buildEmoji();setTimeout(()=>document.querySelectorAll('.ep').forEach(el=>el.classList.toggle('sel',el.dataset.e===a.icon)),50);openM('areaM')}
async function saveArea(){const nm=document.getElementById('aNm').value.trim();if(!nm)return alert('Nombre requerido');const eid=document.getElementById('aEId').value;const pl={name:nm,icon:document.getElementById('aIc').value||'üìÅ',color:document.getElementById('aCl').value};if(eid){await sb.from('categories').update(pl).eq('id',eid);const i=db.areas.findIndex(a=>a.id===eid);if(i>-1)db.areas[i]={...db.areas[i],...pl}}else{const{data,error}=await sb.from('categories').insert([{user_id:user.id,...pl}]).select().single();if(error)return alert(error.message);db.areas.push(data)}closeM('areaM');renderAll();renderAreas();showToast('√Årea guardada ‚úì')}
async function delArea(id){const ok=await askConfirm('¬øEliminar esta √°rea?','Se eliminar√°n sus proyectos asociados','üóëÔ∏è','Eliminar');if(!ok)return;await sb.from('categories').delete().eq('id',id);db.areas=db.areas.filter(a=>a.id!==id);db.projects=db.projects.filter(p=>p.category_id!==id);renderAll();renderAreas()}
function openNewProj(){document.getElementById('pEId').value='';document.getElementById('pMTit').textContent='Nuevo Proyecto';document.getElementById('pNm').value='';updSelects();openM('projM')}
function openNewProjFor(aid){openNewProj();setTimeout(()=>{document.getElementById('pAr').value=aid},60)}
function openEditProj(id){const p=db.projects.find(x=>x.id===id);if(!p)return;document.getElementById('pEId').value=id;document.getElementById('pMTit').textContent='Editar Proyecto';document.getElementById('pNm').value=p.name;document.getElementById('pCl').value=p.color||'#0066ff';updSelects();setTimeout(()=>document.getElementById('pAr').value=p.category_id||'',60);openM('projM')}
async function saveProj(){const nm=document.getElementById('pNm').value.trim();if(!nm)return alert('Nombre requerido');const eid=document.getElementById('pEId').value;const pl={name:nm,category_id:document.getElementById('pAr').value||null,color:document.getElementById('pCl').value};if(eid){await sb.from('projects').update(pl).eq('id',eid);const i=db.projects.findIndex(p=>p.id===eid);if(i>-1)db.projects[i]={...db.projects[i],...pl}}else{const{data,error}=await sb.from('projects').insert([{user_id:user.id,...pl}]).select().single();if(error)return alert(error.message);db.projects.push(data)}closeM('projM');renderAll();renderAreas();showToast('Proyecto guardado ‚úì')}
async function delProj(id){const ok=await askConfirm('¬øEliminar este proyecto?','','üóëÔ∏è','Eliminar');if(!ok)return;await sb.from('projects').delete().eq('id',id);db.projects=db.projects.filter(p=>p.id!==id);renderAll();renderAreas()}

/* ‚îÄ‚îÄ EDIT / DELETE ENTRIES ‚îÄ‚îÄ */
function openEditE(id){const e=db.entries.find(x=>x.id===id);if(!e||e.type==='sleep')return;document.getElementById('eId').value=id;document.getElementById('eDes').value=e.description||'';document.getElementById('eDt').value=e.date||today();document.getElementById('eSt').value=fmtTInput(e.start_time);document.getElementById('eEn').value=fmtTInput(e.end_time);updSelects();setTimeout(()=>{document.getElementById('eAr').value=e.category_id||'';updEPr();setTimeout(()=>document.getElementById('ePr').value=e.project_id||'',80)},80);openM('editM')}
async function updateReg(){const id=document.getElementById('eId').value;const desc=document.getElementById('eDes').value.trim();const date=document.getElementById('eDt').value;const st=document.getElementById('eSt').value,et=document.getElementById('eEn').value;if(!desc||!date||!st||!et)return alert('Completa todos los campos');const start=new Date(date+'T'+st+':00'),end=new Date(date+'T'+et+':00');const dur=Math.floor((end-start)/1000);if(dur<=0)return alert('Fin debe ser posterior');const upd={description:desc,date,start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,project_id:document.getElementById('ePr').value||null,category_id:document.getElementById('eAr').value||null};await sb.from('time_entries').update(upd).eq('id',id);const i=db.entries.findIndex(e=>e.id===id);if(i>-1)db.entries[i]={...db.entries[i],...upd};closeM('editM');renderAll();showToast('Registro actualizado ‚úì')}
async function delEntry(id){const ok=await askConfirm('¬øEliminar este registro?','Esta acci√≥n no se puede deshacer','üóëÔ∏è','Eliminar');if(!ok)return;await sb.from('time_entries').delete().eq('id',id);db.entries=db.entries.filter(e=>e.id!==id);renderAll();renderHist()}

/* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ */
function exportCSV(){const rows=db.entries.map(e=>{const p=db.projects.find(x=>x.id===e.project_id);const a=db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);return[e.date,`"${e.description}"`,a?.name||'',p?.name||'',fmtT(e.start_time),fmtT(e.end_time),(e.duration/3600).toFixed(2),e.type].join(',')});dlF('Fecha,Descripci√≥n,√Årea,Proyecto,Inicio,Fin,Horas,Tipo\n'+rows.join('\n'),'1440-'+today()+'.csv','text/csv')}
function exportPDF(period='all'){
  try{
    const{jsPDF}=window.jspdf;const doc=new jsPDF();
    const n=new Date();let filtered=[...db.entries];
    let periodLabel='Todo el historial';
    if(period==='today'){filtered=filtered.filter(e=>e.date===today());periodLabel='Hoy ‚Äî '+new Date().toLocaleDateString([],{dateStyle:'long'})}
    else if(period==='week'){const w=new Date(n);w.setDate(w.getDate()-7);filtered=filtered.filter(e=>new Date(e.date+'T12:00:00')>=w);periodLabel='√öltimos 7 d√≠as'}
    else if(period==='month'){const m=new Date(n);m.setMonth(m.getMonth()-1);filtered=filtered.filter(e=>new Date(e.date+'T12:00:00')>=m);periodLabel='√öltimo mes'}
    // Header
    doc.setFillColor(6,13,34);doc.rect(0,0,210,32,'F');
    doc.setTextColor(0,255,255);doc.setFontSize(20);doc.setFont(undefined,'bold');doc.text('1440',14,14);
    doc.setFontSize(8);doc.setTextColor(143,176,212);doc.text('Cada minuto cuenta',14,20);
    doc.setFontSize(10);doc.setTextColor(255,255,255);doc.text(periodLabel,14,27);
    doc.setFontSize(7);doc.setTextColor(143,176,212);doc.text('Generado: '+new Date().toLocaleString([],{dateStyle:'short',timeStyle:'short'}),160,27);
    // Stats summary
    const totalMin=filtered.filter(e=>e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const sleepMin=filtered.filter(e=>e.type==='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const days=new Set(filtered.map(e=>e.date)).size;
    doc.setFillColor(11,23,53);doc.rect(0,32,210,14,'F');
    doc.setFontSize(8);doc.setTextColor(0,255,255);doc.setFont(undefined,'bold');
    doc.text(`‚ö° Activo: ${fmtM(totalMin)}`,14,40);
    doc.text(`üò¥ Sue√±o: ${fmtM(sleepMin)}`,70,40);
    doc.text(`üìÖ D√≠as: ${days}`,126,40);
    doc.text(`üìã Registros: ${filtered.length}`,162,40);
    // Table header
    let y=54;
    doc.setFillColor(0,102,255);doc.rect(8,y-5,194,8,'F');
    doc.setTextColor(255,255,255);doc.setFontSize(7.5);doc.setFont(undefined,'bold');
    doc.text('Fecha',10,y);doc.text('Actividad',34,y);doc.text('√Årea',102,y);doc.text('Duraci√≥n',147,y);doc.text('Tipo',172,y);
    y+=6;
    // Entries
    let row=0;
    filtered.sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
      if(y>278){doc.addPage();y=20;row=0}
      const p=db.projects.find(x=>x.id===e.project_id);
      const a=db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);
      const isSleep=e.type==='sleep';
      if(row%2===0){doc.setFillColor(isSleep?245:248,isSleep?240:248,isSleep?255:248);doc.rect(8,y-4,194,7,'F')}
      doc.setTextColor(isSleep?91:40,isSleep?33:40,isSleep?182:40);doc.setFontSize(7);doc.setFont(undefined,'normal');
      const desc=(e.description||'').substring(0,38);
      const aname=(a?.name||'‚Äî').substring(0,22);
      doc.text(e.date||'',10,y);
      doc.text(desc,34,y);
      doc.text(aname,102,y);
      doc.text(fmtS(e.duration),147,y);
      doc.text(isSleep?'Sue√±o':'Activo',172,y);
      y+=7;row++;
    });
    // Totals by area
    if(filtered.length){
      y+=4;
      if(y>268){doc.addPage();y=20}
      doc.setFillColor(6,13,34);doc.rect(8,y-4,194,7,'F');
      doc.setTextColor(0,255,255);doc.setFontSize(8);doc.setFont(undefined,'bold');
      doc.text('TOTALES POR √ÅREA',10,y);y+=9;
      const totals={};filtered.filter(e=>e.type!=='sleep').forEach(e=>{const p2=db.projects.find(x=>x.id===e.project_id);const a2=db.areas.find(x=>x.id===e.category_id||x.id===p2?.category_id);const lbl=(a2?.icon||'')+' '+(a2?.name||'Sin √°rea');totals[lbl]=(totals[lbl]||0)+Math.floor(e.duration/60)});
      Object.entries(totals).sort((a,b)=>b[1]-a[1]).forEach(([lbl,m])=>{
        if(y>278){doc.addPage();y=20}
        doc.setFillColor(240,248,255);doc.rect(8,y-4,194,6,'F');
        doc.setTextColor(40,40,40);doc.setFontSize(7.5);doc.setFont(undefined,'normal');
        doc.text(lbl,12,y);doc.text(fmtM(m),170,y);
        const pct=totalMin?Math.round((m/totalMin)*100):0;
        doc.setTextColor(0,102,255);doc.text(pct+'%',190,y);
        y+=6;
      });
    }
    doc.save('1440-'+period+'-'+today()+'.pdf');
    showToast('PDF descargado ‚úì');
  }catch(e){showToast('Error PDF: '+e.message,true)}
}
function dlF(c,n,m){const b=new Blob([c],{type:m});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click()}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
function openM(id){
  if(id==='manM'){updSelects();setManualMode('dur');setDur(30);document.getElementById('mDt').value=today()}
  if(id==='projM')updSelects();
  if(id==='mantraM')document.getElementById('manIn').value=user?.mantra||'';
  document.getElementById(id)?.classList.add('open');
}
function closeM(id){document.getElementById(id)?.classList.remove('open')}
function closeEl(id){document.getElementById(id)?.classList.remove('open')}
document.addEventListener('click',e=>{const ov=e.target.closest('.overlay');if(ov&&e.target===ov&&ov.id!=='confirmM')closeM(ov.id)});

/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
function fmtS(s){s=s||0;const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60;return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sc).padStart(2,'0')}`}
function fmtM(m){m=Math.max(0,Math.floor(m||0));if(m<60)return m+'m';return`${Math.floor(m/60)}h ${String(m%60).padStart(2,'0')}m`}
function esc(s){return(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;')}
function smsg(id,txt,ok=false){const el=document.getElementById(id);if(!el)return;el.textContent=txt;el.className='fmsg '+(ok?'ok':'err');el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),3500)}
function setBL(t,s,l){document.getElementById(t)?.classList.toggle('hidden',l);document.getElementById(s)?.classList.toggle('hidden',!l)}
function clearPins(p){['1','2','3','4'].forEach(i=>{const el=document.getElementById(p+i);if(el)el.value=''})}

/* ‚îÄ‚îÄ RESIZE handler ‚îÄ‚îÄ */
window.addEventListener('resize',()=>{
  if(user){
    const bn=document.getElementById('botNav');
    if(bn)bn.style.display=window.innerWidth<=768?'flex':'none';
  }
});

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
document.getElementById('l-u').focus();
</script>
</body>
</html>
