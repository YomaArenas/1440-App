<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1440 ‚Äî Cada minuto cuenta</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#050b1f;--bg2:#0a1532;--bg3:#0f1f45;
  --cyan:#00ffff;--blue:#0066ff;--success:#00ff88;
  --danger:#ff3366;--warn:#ffaa00;--sleep:#6366f1;
  --text:#fff;--t2:#99b3d9;--t3:#5580b3;
  --border:#1a3366;--hh:62px;
}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
body::before{content:'';position:fixed;inset:0;
  background:radial-gradient(circle at 15% 25%,rgba(0,255,255,.07) 0%,transparent 45%),
             radial-gradient(circle at 85% 75%,rgba(0,102,255,.07) 0%,transparent 45%);
  pointer-events:none;z-index:0}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{position:fixed;top:0;left:0;right:0;height:var(--hh);
  background:rgba(5,11,31,.97);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 1.5rem;gap:1rem;z-index:500}

/* Logo ‚Äî only last 0 has LED dot */
.logo{font-family:'Space Mono',monospace;font-size:1.55rem;font-weight:700;
  background:linear-gradient(135deg,var(--cyan),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  letter-spacing:.04em;line-height:1;flex-shrink:0;display:flex;align-items:center}
.led-zero{position:relative;display:inline-block;-webkit-text-fill-color:transparent}
.led-zero::after{content:'';position:absolute;
  width:5px;height:5px;background:var(--cyan);border-radius:50%;
  box-shadow:0 0 6px var(--cyan),0 0 14px rgba(0,255,255,.6);
  top:50%;left:50%;transform:translate(-50%,-50%)}

/* Mantra */
.mantra{flex:1;min-width:0;cursor:pointer;padding:.25rem .5rem;border-radius:8px;transition:background .2s}
.mantra:hover{background:rgba(255,255,255,.04)}
.mantra-q{font-size:.68rem;color:var(--t3);font-weight:700;text-transform:uppercase;letter-spacing:.1em}
.mantra-a{font-size:.88rem;font-weight:600;color:var(--cyan);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mantra-ph{font-size:.82rem;color:var(--t3);font-style:italic}

/* Compact timer in header */
.htimer{display:none;align-items:center;gap:.5rem;
  background:rgba(0,255,255,.08);border:1px solid rgba(0,255,255,.25);
  border-radius:8px;padding:.3rem .85rem;flex-shrink:0}
.htimer.on{display:flex}
.hdot{width:7px;height:7px;background:var(--success);border-radius:50%;
  box-shadow:0 0 8px var(--success);animation:blink 1.4s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
.htname{font-size:.8rem;font-weight:600;max-width:120px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.httime{font-family:'Space Mono',monospace;font-size:.82rem;color:var(--cyan)}

.hactions{display:flex;gap:.4rem;align-items:center;flex-shrink:0}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{background:linear-gradient(135deg,var(--cyan),var(--blue));color:var(--bg);
  border:none;border-radius:10px;padding:.72rem 1.3rem;
  font-family:inherit;font-size:.88rem;font-weight:700;cursor:pointer;
  transition:all .25s;display:inline-flex;align-items:center;
  justify-content:center;gap:.4rem;letter-spacing:.02em}
.btn:hover{transform:translateY(-2px);filter:brightness(1.1)}
.btn:active{transform:translateY(0)}
.btn-sm{padding:.42rem .82rem;font-size:.77rem}
.btn-full{width:100%}
.btn-ok{background:linear-gradient(135deg,var(--success),#00cc70);color:#000}
.btn-del{background:linear-gradient(135deg,var(--danger),#cc0044);color:#fff}
.btn-ghost{background:transparent;color:var(--cyan);border:2px solid var(--border)}
.btn-ghost:hover{border-color:var(--cyan)}
.btn-sleep{background:linear-gradient(135deg,var(--sleep),#4f46e5);color:#fff}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{max-width:1360px;margin:0 auto;
  padding:calc(var(--hh) + 1.4rem) 1.75rem 4rem;
  position:relative;z-index:1}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.prog-wrap{background:var(--bg2);border:2px solid var(--border);
  border-radius:14px;padding:1rem 1.25rem;margin-bottom:1.25rem}
.prog-top{display:flex;justify-content:space-between;
  align-items:center;margin-bottom:.55rem;font-size:.87rem}
.prog-top strong{color:var(--cyan);font-family:'Space Mono',monospace;font-size:1rem}
.prog-track{height:11px;background:var(--bg3);border-radius:6px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--blue));
  border-radius:6px;transition:width .5s ease;position:relative}
.prog-fill::after{content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);
  animation:shim 2s linear infinite}
@keyframes shim{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

/* ‚îÄ‚îÄ TOP ROW ‚Äî Quick track + Register Manual side by side ‚îÄ‚îÄ */
.top-row{display:grid;grid-template-columns:1fr auto;gap:1.25rem;
  align-items:start;margin-bottom:1.25rem}

/* Register Manual button ‚Äî vertical card style */
.reg-manual-card{background:linear-gradient(135deg,rgba(0,255,255,.06),rgba(0,102,255,.06));
  border:2px solid rgba(0,255,255,.3);border-radius:14px;
  padding:1.1rem 1.25rem;cursor:pointer;transition:all .25s;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:.6rem;text-align:center;min-width:140px}
.reg-manual-card:hover{border-color:var(--cyan);transform:translateY(-2px);
  box-shadow:0 6px 24px rgba(0,255,255,.15)}
.reg-manual-icon{font-size:2rem}
.reg-manual-label{font-size:.82rem;font-weight:700;color:var(--cyan);
  text-transform:uppercase;letter-spacing:.06em}
.reg-manual-sub{font-size:.72rem;color:var(--t2)}

/* ‚îÄ‚îÄ QUICK TRACK ‚îÄ‚îÄ */
.qt-wrap{background:var(--bg2);border:2px solid var(--border);
  border-radius:14px;padding:1.1rem 1.25rem;flex:1}
.sec-title{font-size:.72rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.1em;color:var(--t3);margin-bottom:.85rem}
.qt-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:.6rem}
.qt-item{background:var(--bg3);border:2px solid var(--border);
  border-radius:11px;padding:.8rem 1rem;cursor:pointer;
  transition:all .25s;display:flex;justify-content:space-between;align-items:center}
.qt-item:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,255,255,.12)}
.qt-item.on{border-color:var(--success);background:rgba(0,255,136,.07)}
.qt-name{font-weight:600;font-size:.9rem;margin-bottom:.18rem}
.qt-sub{font-size:.75rem;color:var(--t2);font-family:'Space Mono',monospace}
.qt-play{width:30px;height:30px;background:linear-gradient(135deg,var(--cyan),var(--blue));
  border-radius:7px;display:flex;align-items:center;justify-content:center;
  font-size:.9rem;color:var(--bg);font-weight:700;flex-shrink:0}

/* ‚îÄ‚îÄ ACTIVE TIMER BANNER ‚îÄ‚îÄ */
.tbanner{background:linear-gradient(135deg,rgba(0,255,255,.07),rgba(0,102,255,.07));
  border:2px solid var(--cyan);border-radius:16px;
  padding:1.2rem 1.5rem;margin-bottom:1.25rem;display:none}
.tbanner.on{display:block}
.tb-top{display:flex;align-items:center;gap:.7rem;margin-bottom:.5rem}
.tb-dot{width:10px;height:10px;background:var(--success);border-radius:50%;
  box-shadow:0 0 10px var(--success);animation:blink 1.4s ease-in-out infinite}
.tb-badge{font-size:.72rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.08em;color:var(--success)}
.tb-name{font-size:1.2rem;font-weight:700}
.tb-meta{font-size:.8rem;color:var(--t2);margin-top:.1rem}
.tb-time{font-family:'Space Mono',monospace;font-size:2.6rem;font-weight:700;
  text-align:center;background:linear-gradient(135deg,var(--cyan),var(--success));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:.5rem 0}
.tb-btns{display:flex;gap:.65rem}
.tb-btns .btn{flex:1}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;gap:.45rem;margin-bottom:1.4rem;overflow-x:auto;padding-bottom:.2rem}
.tab{background:transparent;color:var(--t2);border:2px solid transparent;
  border-radius:9px;padding:.62rem 1.1rem;cursor:pointer;transition:all .25s;
  font-weight:600;font-size:.86rem;white-space:nowrap;font-family:inherit}
.tab:hover{color:var(--cyan);background:var(--bg2)}
.tab.active{color:var(--cyan);border-color:var(--cyan);background:rgba(0,255,255,.07)}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ */
.tl-scroll{overflow-y:auto;max-height:68vh}
.tl-row{display:grid;grid-template-columns:54px 1fr;
  min-height:70px;border-bottom:1px solid rgba(26,51,102,.35);position:relative}
.tl-lbl{padding:.4rem .4rem 0 0;font-size:.72rem;color:var(--t3);
  font-family:'Space Mono',monospace;text-align:right}
.tl-col{position:relative;padding:3px 5px;min-height:70px}
.tl-e{border-radius:7px;padding:.4rem .7rem;font-size:.81rem;font-weight:600;
  margin-bottom:3px;cursor:pointer;transition:filter .2s;
  display:flex;align-items:center;gap:.45rem}
.tl-e:hover{filter:brightness(1.2)}
.tl-tracked{background:rgba(0,255,255,.1);border-left:3px solid var(--cyan);color:var(--cyan)}
.tl-sleep{background:rgba(99,102,241,.15);border-left:3px solid var(--sleep);color:#a5b4fc}
.tl-gap{background:rgba(55,65,81,.15);border-left:3px dashed #2d3748;
  color:var(--t3);font-weight:400;cursor:default}
.tl-dur{font-size:.7rem;opacity:.65;margin-left:auto;
  font-family:'Space Mono',monospace;white-space:nowrap}
.tl-add{position:absolute;right:5px;top:5px;background:transparent;
  border:1px dashed var(--border);color:var(--t3);border-radius:5px;
  padding:.18rem .45rem;font-size:.7rem;cursor:pointer;transition:all .2s;font-family:inherit}
.tl-add:hover{border-color:var(--cyan);color:var(--cyan)}

/* ‚îÄ‚îÄ AREAS ‚Äî more visual, less horizontal ‚îÄ‚îÄ */
.areas-masonry{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.1rem}
.area-card{background:var(--bg2);border:2px solid var(--border);
  border-radius:16px;overflow:hidden;transition:all .25s}
.area-card:hover{transform:translateY(-2px)}
.area-card-top{padding:1.1rem 1.25rem;cursor:pointer;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border)}
.area-left{display:flex;align-items:center;gap:.75rem}
.area-stripe{width:6px;height:36px;border-radius:3px;flex-shrink:0}
.area-icon{font-size:1.35rem}
.area-info{}
.area-name{font-size:1rem;font-weight:700;line-height:1.2}
.area-cnt{font-size:.75rem;color:var(--t3)}
.area-right{display:flex;align-items:center;gap:.6rem}
.area-total{font-family:'Space Mono',monospace;font-size:.85rem;font-weight:700}
.area-chev{font-size:.85rem;color:var(--t3);transition:transform .3s}
.area-chev.open{transform:rotate(90deg)}
.area-body{padding:0 1.1rem 1.1rem;display:none}
.area-body.open{display:block}
.proj-stack{display:flex;flex-direction:column;gap:.5rem;margin-top:.85rem}
.proj-row{background:var(--bg3);border:1px solid var(--border);border-radius:10px;
  padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem;transition:all .2s}
.proj-row:hover{border-color:rgba(255,255,255,.15)}
.proj-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.proj-info{flex:1;min-width:0}
.proj-name{font-weight:600;font-size:.9rem}
.proj-stat{font-size:.75rem;color:var(--t2);font-family:'Space Mono',monospace}
.proj-actions{display:flex;gap:.35rem}
.area-footer{display:flex;gap:.5rem;margin-top:.85rem}

/* ‚îÄ‚îÄ REGISTROS ‚îÄ‚îÄ */
.reg-list{display:flex;flex-direction:column;gap:.7rem}
.reg-card{background:var(--bg2);border:2px solid var(--border);
  border-radius:13px;padding:.95rem 1.15rem;
  display:grid;grid-template-columns:80px 1fr auto;
  gap:.9rem;align-items:center;transition:all .25s}
.reg-card:hover{border-color:rgba(0,255,255,.25);transform:translateY(-1px)}
.reg-dur{font-family:'Space Mono',monospace;font-size:1.2rem;
  font-weight:700;color:var(--cyan)}
.reg-desc{font-weight:600;margin-bottom:.2rem;font-size:.93rem}
.reg-meta{font-size:.78rem;color:var(--t2);
  display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
.badge{padding:.15rem .5rem;background:var(--bg3);
  border:1px solid var(--border);border-radius:5px;font-size:.74rem}
.badge-sleep{border-color:var(--sleep);color:#a5b4fc}
.reg-acts{display:flex;gap:.35rem}

/* ‚îÄ‚îÄ DASHBOARD GRID ‚Äî asymmetric ‚îÄ‚îÄ */
.dash-grid{
  display:grid;
  grid-template-columns:1.4fr 1fr 1fr;
  grid-template-rows:auto auto;
  gap:1.1rem;margin-bottom:1.5rem}
.dash-card{background:var(--bg2);border:2px solid var(--border);
  border-radius:16px;padding:1.4rem}
.dash-card h3{font-size:.73rem;text-transform:uppercase;
  letter-spacing:.09em;color:var(--t2);margin-bottom:.85rem}
.dash-val{font-family:'Space Mono',monospace;font-size:2.3rem;font-weight:800;
  background:linear-gradient(135deg,var(--cyan),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.dash-sub{font-size:.8rem;color:var(--t3);margin-top:.2rem}
.pie-wrap{position:relative;width:160px;height:160px;margin:.6rem auto}
.pie-svg{width:100%;height:100%}
.pie-center{position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);text-align:center}
.pie-cv{font-family:'Space Mono',monospace;font-size:1.3rem;
  font-weight:700;color:var(--cyan)}
.pie-cs{font-size:.68rem;color:var(--t3)}
.legend-item{display:flex;align-items:center;gap:.5rem;
  margin-bottom:.38rem;font-size:.8rem}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.legend-val{margin-left:auto;font-family:'Space Mono',monospace;
  font-size:.75rem;color:var(--cyan)}
.dash-span2{grid-row:span 2}

@media(max-width:900px){
  .dash-grid{grid-template-columns:1fr 1fr;grid-template-rows:auto}
  .dash-span2{grid-row:span 1}
}
@media(max-width:600px){.dash-grid{grid-template-columns:1fr}}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;
  background:rgba(5,11,31,.93);backdrop-filter:blur(10px);
  z-index:900;align-items:center;justify-content:center;padding:1rem}
.overlay.open{display:flex}
.modal{background:var(--bg2);border:2px solid var(--border);
  border-radius:20px;padding:1.75rem;
  max-width:490px;width:100%;max-height:92vh;overflow-y:auto}
.mhead{display:flex;justify-content:space-between;
  align-items:center;margin-bottom:1.35rem}
.mhead h2{font-size:1.3rem;font-weight:700}
.mclose{width:29px;height:29px;background:var(--bg3);
  border:1px solid var(--border);border-radius:7px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  color:var(--t2);font-size:1.05rem;transition:all .2s}
.mclose:hover{border-color:var(--cyan);color:var(--cyan)}
.fg{margin-bottom:1rem}
.fg label{display:block;font-size:.81rem;font-weight:600;
  color:var(--t2);margin-bottom:.38rem}
.fg input,.fg select,.fg textarea{width:100%;background:var(--bg3);
  border:2px solid var(--border);border-radius:9px;
  padding:.72rem 1rem;color:var(--text);font-family:inherit;
  font-size:.92rem;transition:all .25s}
.fg input:focus,.fg select:focus,.fg textarea:focus{
  outline:none;border-color:var(--cyan);box-shadow:0 0 0 3px rgba(0,255,255,.1)}
.fg textarea{min-height:72px;resize:vertical}
input[type=color]{height:42px;cursor:pointer}
input[type=time]{font-family:'Space Mono',monospace}
.r2{display:grid;grid-template-columns:1fr 1fr;gap:.9rem}
.mbtns{display:flex;gap:.7rem;margin-top:1.2rem}
.mbtns .btn{flex:1}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-scr{position:fixed;inset:0;background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding:1rem;z-index:1000}
.login-box{background:var(--bg2);border:2px solid var(--border);
  border-radius:20px;padding:2rem;max-width:390px;width:100%;
  box-shadow:0 0 60px rgba(0,255,255,.06)}
.login-logo{text-align:center;margin-bottom:1.4rem}
.login-title{font-family:'Space Mono',monospace;font-size:2.8rem;
  font-weight:700;background:linear-gradient(135deg,var(--cyan),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  line-height:1;display:inline-flex;align-items:center;letter-spacing:.05em}
.led-zero-lg{position:relative;display:inline-block;-webkit-text-fill-color:transparent}
.led-zero-lg::after{content:'';position:absolute;
  width:7px;height:7px;background:var(--cyan);border-radius:50%;
  box-shadow:0 0 8px var(--cyan),0 0 18px rgba(0,255,255,.5);
  top:50%;left:50%;transform:translate(-50%,-50%)}
.login-sub{color:var(--t2);font-size:.81rem;margin-top:.45rem}
.ltabs{display:flex;gap:.35rem;background:var(--bg3);
  padding:.28rem;border-radius:9px;margin-bottom:1.35rem}
.ltab{flex:1;background:transparent;border:none;border-radius:7px;
  padding:.58rem;cursor:pointer;font-family:inherit;font-weight:600;
  font-size:.86rem;color:var(--t2);transition:all .25s}
.ltab.active{background:linear-gradient(135deg,var(--cyan),var(--blue));color:var(--bg)}
.lform{display:none}
.lform.active{display:block}
.pin-row{display:flex;gap:.55rem;justify-content:center;margin:1rem 0}
.pin-d{width:50px;height:58px;background:var(--bg3);border:2px solid var(--border);
  border-radius:10px;color:var(--cyan);font-size:1.55rem;font-weight:700;
  text-align:center;font-family:'Space Mono',monospace;transition:all .25s}
.pin-d:focus{outline:none;border-color:var(--cyan);transform:scale(1.06)}
.ibox{background:rgba(0,255,255,.04);border-left:3px solid var(--cyan);
  padding:.8rem .95rem;border-radius:8px;margin:.8rem 0;
  font-size:.81rem;color:var(--t2)}
.ibox.warn{border-left-color:var(--warn)}
.ibox strong{display:block;margin-bottom:.22rem;color:var(--cyan)}
.ibox.warn strong{color:var(--warn)}
.msg{padding:.7rem;border-radius:8px;margin:.6rem 0;
  text-align:center;font-weight:600;font-size:.83rem}
.msg.err{background:rgba(255,51,102,.1);border:2px solid var(--danger);color:var(--danger)}
.msg.ok{background:rgba(0,255,136,.1);border:2px solid var(--success);color:var(--success)}
.hidden{display:none!important}
.spin{display:inline-block;width:13px;height:13px;
  border:2px solid rgba(255,255,255,.3);border-top-color:currentColor;
  border-radius:50%;animation:spinA .7s linear infinite}
@keyframes spinA{to{transform:rotate(360deg)}}

/* Sleep setup overlay */
.sleep-ov{display:none;position:fixed;inset:0;
  background:rgba(5,11,31,.97);backdrop-filter:blur(10px);
  z-index:1100;align-items:center;justify-content:center;padding:1rem}
.sleep-ov.open{display:flex}

/* Sleep smart popup */
.sleep-pop{display:none;position:fixed;bottom:1.5rem;right:1.5rem;
  background:var(--bg2);border:2px solid var(--sleep);border-radius:16px;
  padding:1.3rem;max-width:300px;width:100%;z-index:600;
  box-shadow:0 8px 32px rgba(99,102,241,.3)}
.sleep-pop.open{display:block;animation:slideUp .35s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* Icon btn */
.ibtn{width:28px;height:28px;background:var(--bg3);border:1px solid var(--border);
  border-radius:6px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .2s;font-size:.82rem;color:var(--t2)}
.ibtn:hover{border-color:var(--danger);color:var(--danger)}
.ibtn.edit:hover{border-color:var(--cyan);color:var(--cyan)}

.empty{text-align:center;padding:2.5rem 1rem;color:var(--t3)}
.empty-ic{font-size:2.5rem;opacity:.25;margin-bottom:.6rem}
.empty h3{font-size:1rem;color:var(--text);margin-bottom:.3rem}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--blue);border-radius:3px}

@media(max-width:768px){
  .main{padding:calc(var(--hh)+1rem) 1rem 4rem}
  .hdr{padding:0 1rem}
  .top-row{grid-template-columns:1fr;grid-template-rows:auto auto}
  .reg-manual-card{flex-direction:row;text-align:left;min-width:unset}
  .reg-card{grid-template-columns:1fr}
  .tb-time{font-size:2rem}
  .areas-masonry{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div class="login-scr" id="loginScr">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-title">144<span class="led-zero-lg">0</span></div>
      <div class="login-sub">Cada minuto cuenta</div>
    </div>
    <div class="ltabs">
      <button class="ltab active" onclick="swLTab('login')">Ingresar</button>
      <button class="ltab" onclick="swLTab('register')">Crear Cuenta</button>
    </div>

    <!-- Login form -->
    <div class="lform active" id="lf-login">
      <div class="ibox"><strong>üë§ Usuario + PIN</strong>Ingresa tu nombre de usuario y PIN</div>
      <div class="fg"><label>Nombre de usuario</label>
        <input type="text" id="l-user" placeholder="tu_usuario" autocomplete="off" style="text-transform:lowercase">
      </div>
      <div class="fg"><label>PIN de 4 d√≠gitos</label>
        <div class="pin-row">
          <input type="password" maxlength="1" class="pin-d" id="lp1" oninput="pf(this,'lp2')">
          <input type="password" maxlength="1" class="pin-d" id="lp2" oninput="pf(this,'lp3')">
          <input type="password" maxlength="1" class="pin-d" id="lp3" oninput="pf(this,'lp4')">
          <input type="password" maxlength="1" class="pin-d" id="lp4" oninput="autoLogin()">
        </div>
      </div>
      <div id="loginErr" class="msg err hidden"></div>
      <button class="btn btn-full" onclick="doLogin()">
        <span id="lTxt">Ingresar</span><span id="lSpin" class="spin hidden"></span>
      </button>
    </div>

    <!-- Register form -->
    <div class="lform" id="lf-register">
      <div class="fg"><label>Nombre de usuario</label>
        <input type="text" id="r-user" placeholder="elige_tu_usuario" autocomplete="off" style="text-transform:lowercase">
      </div>
      <div class="fg"><label>PIN de 4 d√≠gitos</label>
        <div class="pin-row">
          <input type="password" maxlength="1" class="pin-d" id="rp1" oninput="pf(this,'rp2')">
          <input type="password" maxlength="1" class="pin-d" id="rp2" oninput="pf(this,'rp3')">
          <input type="password" maxlength="1" class="pin-d" id="rp3" oninput="pf(this,'rp4')">
          <input type="password" maxlength="1" class="pin-d" id="rp4">
        </div>
      </div>
      <div class="ibox warn"><strong>‚ö†Ô∏è Importante</strong>El usuario debe ser √∫nico ¬∑ El PIN es personal ¬∑ Sin recuperaci√≥n</div>
      <div id="regErr" class="msg err hidden"></div>
      <div id="regOk" class="msg ok hidden"></div>
      <button class="btn btn-ok btn-full" onclick="doRegister()">
        <span id="rTxt">Crear Cuenta</span><span id="rSpin" class="spin hidden"></span>
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SLEEP SETUP ‚ïê‚ïê -->
<div class="sleep-ov" id="sleepOv">
  <div class="modal" style="max-width:430px">
    <div style="text-align:center;margin-bottom:1.4rem">
      <div style="font-size:2.5rem;margin-bottom:.4rem">üò¥</div>
      <h2 style="font-size:1.35rem;background:linear-gradient(135deg,var(--cyan),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent">
        Configura tu Sue√±o</h2>
      <p style="color:var(--t2);margin-top:.4rem;font-size:.86rem">
        Una vez configurado, 1440 lo registra autom√°ticamente cada d√≠a</p>
    </div>
    <div class="r2">
      <div class="fg"><label>üåô Me duermo a:</label><input type="time" id="ss-sleep" value="22:30"></div>
      <div class="fg"><label>‚òÄÔ∏è Me despierto a:</label><input type="time" id="ss-wake" value="07:00"></div>
    </div>
    <div class="ibox"><strong>üí° C√≥mo funciona</strong>Rutina normal = registro autom√°tico. Cambios = te preguntamos.</div>
    <button class="btn btn-ok btn-full" onclick="saveSleepSetup()">Guardar Rutina de Sue√±o</button>
  </div>
</div>

<!-- ‚ïê‚ïê SLEEP SMART POPUP ‚ïê‚ïê -->
<div class="sleep-pop" id="sleepPop">
  <div style="display:flex;align-items:center;gap:.6rem;margin-bottom:.85rem">
    <span style="font-size:1.35rem">üò¥</span>
    <div><div style="font-weight:700;font-size:.92rem">¬øC√≥mo dormiste anoche?</div>
    <div style="font-size:.75rem;color:var(--t2)">Detectamos actividad fuera de tu rutina</div></div>
  </div>
  <div class="r2" style="margin-bottom:.85rem">
    <div class="fg"><label>Dorm√≠ a:</label><input type="time" id="pop-sleep"></div>
    <div class="fg"><label>Despert√© a:</label><input type="time" id="pop-wake"></div>
  </div>
  <div style="display:flex;gap:.45rem">
    <button class="btn btn-ok btn-full btn-sm" onclick="saveSleepPop()">Guardar</button>
    <button class="btn btn-ghost btn-sm" onclick="closeEl('sleepPop')">Ignorar</button>
  </div>
</div>

<!-- ‚ïê‚ïê MANTRA MODAL ‚ïê‚ïê -->
<div class="overlay" id="mantraModal">
  <div class="modal" style="max-width:400px">
    <div class="mhead"><h2>üåü Tu Mantra</h2>
      <button class="mclose" onclick="closeM('mantraModal')">√ó</button></div>
    <p style="color:var(--t2);margin-bottom:1.1rem;font-size:.88rem">
      Esta respuesta quedar√° fija en tu header como recordatorio diario.</p>
    <div class="fg"><label>¬øQui√©n quieres ser?</label>
      <input type="text" id="mantraIn" placeholder="Tu mantra aqu√≠..." maxlength="60"></div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('mantraModal')">Cancelar</button>
      <button class="btn" onclick="saveMantra()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP HEADER ‚ïê‚ïê -->
<header class="hdr" id="appHdr" style="display:none">
  <div class="logo">144<span class="led-zero">0</span></div>

  <div class="mantra" onclick="openMantraModal()" title="Click para editar tu mantra">
    <div class="mantra-q">¬øQui√©n quieres ser?</div>
    <div id="mantraDisp" class="mantra-ph">Toca para escribir tu mantra...</div>
  </div>

  <div class="htimer" id="hTimer">
    <div class="hdot"></div>
    <div class="htname" id="hTName">‚Äî</div>
    <div class="httime" id="hTTime">00:00:00</div>
    <button class="btn btn-del btn-sm" onclick="stopTimer()" style="padding:.28rem .6rem;font-size:.7rem">‚èπ</button>
  </div>

  <div class="hactions">
    <button class="btn btn-sleep btn-sm" onclick="openM('sleepEditModal')" title="Editar rutina de sue√±o">üò¥</button>
    <button class="btn btn-sm" onclick="openDash()">üìä</button>
    <button class="btn btn-ghost btn-sm" onclick="exportCSV()">CSV</button>
    <button class="btn btn-ghost btn-sm" onclick="exportPDF()">PDF</button>
    <button class="btn btn-del btn-sm" onclick="doLogout()">üö™</button>
  </div>
</header>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main class="main" id="mainApp" style="display:none">

  <!-- Progress 1440 -->
  <div class="prog-wrap">
    <div class="prog-top">
      <span>Hoy: <strong id="progMin">0</strong> / 1440 min</span>
      <span id="progPct" style="color:var(--t2)">0%</span>
    </div>
    <div class="prog-track"><div class="prog-fill" id="progBar" style="width:0%"></div></div>
  </div>

  <!-- Active Timer Banner -->
  <div class="tbanner" id="tBanner">
    <div class="tb-top"><div class="tb-dot"></div><div class="tb-badge">Tracking ahora</div></div>
    <div class="tb-name" id="tbName">‚Äî</div>
    <div class="tb-meta" id="tbMeta">‚Äî</div>
    <div class="tb-time" id="tbTime">00:00:00</div>
    <div class="tb-btns">
      <button class="btn btn-del" onclick="stopTimer()">‚èπ Detener</button>
      <button class="btn btn-ghost" onclick="switchAct()">üîÑ Cambiar</button>
    </div>
  </div>

  <!-- Top Row: Quick Track + Registro Manual -->
  <div class="top-row">
    <div class="qt-wrap">
      <div class="sec-title">‚ö° Quick Track ‚Äî 1 click</div>
      <div class="qt-grid" id="qtGrid"></div>
    </div>

    <div class="reg-manual-card" onclick="openM('manualModal')">
      <div class="reg-manual-icon">üìù</div>
      <div class="reg-manual-label">Registro<br>Manual</div>
      <div class="reg-manual-sub">Tiempo pasado</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="goTab('timeline',this)">üìÖ Timeline</button>
    <button class="tab" onclick="goTab('areas',this)">üìÅ √Åreas</button>
    <button class="tab" onclick="goTab('registros',this)">üìã Registros</button>
    <button class="tab" onclick="goTab('dashboard',this)">üìä Dashboard</button>
  </div>

  <!-- TIMELINE -->
  <div class="tab-pane active" id="tab-timeline">
    <div style="background:var(--bg2);border:2px solid var(--border);border-radius:16px;padding:1.2rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.65rem">
        <h3 id="tlTitle" style="font-size:1rem">Hoy</h3>
        <input type="date" id="tlDate" onchange="renderTimeline()"
          style="background:var(--bg3);border:2px solid var(--border);border-radius:8px;padding:.38rem .65rem;color:var(--text);font-family:inherit;font-size:.8rem">
      </div>
      <div class="tl-scroll" id="tlWrap"></div>
    </div>
  </div>

  <!-- AREAS -->
  <div class="tab-pane" id="tab-areas">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;flex-wrap:wrap;gap:.65rem">
      <h2>√Åreas de Vida</h2>
      <div style="display:flex;gap:.5rem">
        <button class="btn btn-ghost btn-sm" onclick="openM('areaModal')">‚ûï √Årea</button>
        <button class="btn btn-sm" onclick="openM('projectModal')">‚ûï Proyecto</button>
      </div>
    </div>
    <div class="areas-masonry" id="areasC"></div>
  </div>

  <!-- REGISTROS -->
  <div class="tab-pane" id="tab-registros">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;flex-wrap:wrap;gap:.65rem">
      <h2>Registros de Tiempo</h2>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <select id="fArea" onchange="renderRegs()"
          style="background:var(--bg3);border:2px solid var(--border);border-radius:8px;padding:.38rem .65rem;color:var(--text);font-family:inherit;font-size:.8rem">
          <option value="">Todas las √°reas</option></select>
        <select id="fPer" onchange="renderRegs()"
          style="background:var(--bg3);border:2px solid var(--border);border-radius:8px;padding:.38rem .65rem;color:var(--text);font-family:inherit;font-size:.8rem">
          <option value="today">Hoy</option>
          <option value="week">Esta semana</option>
          <option value="month">Este mes</option>
          <option value="all">Todo</option>
        </select>
      </div>
    </div>
    <div class="reg-list" id="regList"></div>
  </div>

  <!-- DASHBOARD -->
  <div class="tab-pane" id="tab-dashboard">
    <h2 style="margin-bottom:1.2rem">Dashboard</h2>
    <div class="dash-grid">
      <div class="dash-card dash-span2">
        <h3>Distribuci√≥n 1440</h3>
        <div class="pie-wrap">
          <svg class="pie-svg" id="pieSvg" viewBox="0 0 100 100"></svg>
          <div class="pie-center"><div class="pie-cv" id="piePct">0%</div><div class="pie-cs">registrado</div></div>
        </div>
        <div id="pieLeg"></div>
      </div>
      <div class="dash-card"><h3>üò¥ Sue√±o Promedio</h3><div class="dash-val" id="dSleep">0h</div><div class="dash-sub">√öltimos 7 d√≠as</div></div>
      <div class="dash-card"><h3>üï≥ Vac√≠o Hoy</h3><div class="dash-val" id="dEmpty">24h</div><div class="dash-sub">Sin registrar</div></div>
      <div class="dash-card"><h3>‚è± Trackeado Hoy</h3><div class="dash-val" id="dTrack">0h</div><div class="dash-sub">Excluyendo sue√±o</div></div>
      <div class="dash-card"><h3>‚öñÔ∏è Balance</h3><div class="dash-val" id="dBal">‚Äî</div><div class="dash-sub" id="dBalSub">√Årea 1 vs resto</div></div>
    </div>
  </div>

</main>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->
<!-- Area -->
<div class="overlay" id="areaModal">
  <div class="modal">
    <div class="mhead"><h2 id="areaMTitle">Nueva √Årea</h2><button class="mclose" onclick="closeM('areaModal')">√ó</button></div>
    <input type="hidden" id="aEditId">
    <div class="fg"><label>Nombre</label><input type="text" id="aName" placeholder="Trabajo, Salud, Familia..."></div>
    <div class="r2">
      <div class="fg"><label>Emoji</label><input type="text" id="aIcon" placeholder="üíº" maxlength="2"></div>
      <div class="fg"><label>Color</label><input type="color" id="aColor" value="#00ffff"></div>
    </div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('areaModal')">Cancelar</button>
      <button class="btn" onclick="saveArea()">Guardar</button>
    </div>
  </div>
</div>

<!-- Project -->
<div class="overlay" id="projectModal">
  <div class="modal">
    <div class="mhead"><h2 id="projMTitle">Nuevo Proyecto</h2><button class="mclose" onclick="closeM('projectModal')">√ó</button></div>
    <input type="hidden" id="pEditId">
    <div class="fg"><label>√Årea de Vida</label><select id="pArea"><option value="">Sin √°rea</option></select></div>
    <div class="fg"><label>Nombre</label><input type="text" id="pName" placeholder="Ej: Cliente ABC"></div>
    <div class="fg"><label>Color</label><input type="color" id="pColor" value="#0066ff"></div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('projectModal')">Cancelar</button>
      <button class="btn" onclick="saveProject()">Guardar</button>
    </div>
  </div>
</div>

<!-- Manual Registro -->
<div class="overlay" id="manualModal">
  <div class="modal">
    <div class="mhead"><h2>üìù Registro Manual</h2><button class="mclose" onclick="closeM('manualModal')">√ó</button></div>
    <div class="fg"><label>¬øQu√© hiciste?</label><input type="text" id="mDesc" placeholder="Descripci√≥n..."></div>
    <div class="r2">
      <div class="fg"><label>√Årea</label><select id="mArea" onchange="updMProj()"><option value="">Sin √°rea</option></select></div>
      <div class="fg"><label>Proyecto</label><select id="mProj"><option value="">Sin proyecto</option></select></div>
    </div>
    <div class="fg"><label>Fecha</label><input type="date" id="mDate"></div>
    <div class="r2">
      <div class="fg"><label>Inicio</label><input type="time" id="mStart"></div>
      <div class="fg"><label>Fin</label><input type="time" id="mEnd"></div>
    </div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('manualModal')">Cancelar</button>
      <button class="btn" onclick="saveManual()">Guardar Registro</button>
    </div>
  </div>
</div>

<!-- Edit Registro -->
<div class="overlay" id="editRegModal">
  <div class="modal">
    <div class="mhead"><h2>‚úèÔ∏è Editar Registro</h2><button class="mclose" onclick="closeM('editRegModal')">√ó</button></div>
    <input type="hidden" id="eId">
    <div class="fg"><label>Descripci√≥n</label><input type="text" id="eDesc"></div>
    <div class="r2">
      <div class="fg"><label>√Årea</label><select id="eArea" onchange="updEProj()"><option value="">Sin √°rea</option></select></div>
      <div class="fg"><label>Proyecto</label><select id="eProj"><option value="">Sin proyecto</option></select></div>
    </div>
    <div class="fg"><label>Fecha</label><input type="date" id="eDate"></div>
    <div class="r2">
      <div class="fg"><label>Inicio</label><input type="time" id="eStart"></div>
      <div class="fg"><label>Fin</label><input type="time" id="eEnd"></div>
    </div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('editRegModal')">Cancelar</button>
      <button class="btn" onclick="updateReg()">Guardar Cambios</button>
    </div>
  </div>
</div>

<!-- Sleep Edit -->
<div class="overlay" id="sleepEditModal">
  <div class="modal" style="max-width:400px">
    <div class="mhead"><h2>üò¥ Rutina de Sue√±o</h2><button class="mclose" onclick="closeM('sleepEditModal')">√ó</button></div>
    <div class="r2">
      <div class="fg"><label>üåô Me duermo a:</label><input type="time" id="esSleep"></div>
      <div class="fg"><label>‚òÄÔ∏è Me despierto a:</label><input type="time" id="esWake"></div>
    </div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('sleepEditModal')">Cancelar</button>
      <button class="btn btn-ok" onclick="updSleepRoutine()">Guardar</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SB_URL='https://ilzxgnqylmycktwsrfcr.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsenhnbnF5bG15Y2t0d3NyZmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTg0OTAsImV4cCI6MjA4NjMzNDQ5MH0.MkXUo8CjpH2QTUuLpoqA0LRHwTzC9p4WiFn1lFmk0d4';
const{createClient}=supabase;const sb=createClient(SB_URL,SB_KEY);
let user=null,db={areas:[],projects:[],entries:[]},timer=null,timerIv=null;

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function swLTab(t){
  document.querySelectorAll('.ltab').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.lform').forEach(e=>e.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('lf-'+t).classList.add('active');
  document.getElementById(t==='login'?'l-user':'r-user').focus();
}
function pf(el,nid){if(el.value.length===1)document.getElementById(nid)?.focus()}
function getPin(p){return['1','2','3','4'].map(i=>document.getElementById(p+i).value).join('')}
function autoLogin(){setTimeout(()=>{if(getPin('lp').length===4)doLogin()},80)}

async function doRegister(){
  const uname=document.getElementById('r-user').value.trim().toLowerCase();
  const pin=getPin('rp');
  if(!uname)return showMsg('regErr','Ingresa un nombre de usuario');
  if(pin.length!==4)return showMsg('regErr','PIN incompleto');
  if(!/^[a-z0-9_]{3,20}$/.test(uname))return showMsg('regErr','Usuario: 3-20 caracteres, solo letras, n√∫meros y _');
  setBL('rTxt','rSpin',true);
  try{
    const{data:ex}=await sb.from('users').select('id').eq('username',uname).maybeSingle();
    if(ex)return showMsg('regErr','Nombre de usuario ya en uso');
    const{data:u,error}=await sb.from('users').insert([{username:uname,pin}]).select().single();
    if(error)throw error;
    user=u;
    showMsg('regOk','¬°Cuenta creada! Configurando sue√±o...',true);
    setTimeout(()=>{clearPins('rp');document.getElementById('sleepOv').classList.add('open')},1200);
  }catch(e){showMsg('regErr','Error: '+e.message)}
  finally{setBL('rTxt','rSpin',false)}
}

async function doLogin(){
  const uname=document.getElementById('l-user').value.trim().toLowerCase();
  const pin=getPin('lp');
  if(!uname)return showMsg('loginErr','Ingresa tu nombre de usuario');
  if(pin.length!==4)return showMsg('loginErr','PIN incompleto');
  setBL('lTxt','lSpin',true);
  try{
    const{data:u}=await sb.from('users').select('*').eq('username',uname).eq('pin',pin).maybeSingle();
    if(!u){clearPins('lp');document.getElementById('lp1').focus();return showMsg('loginErr','Usuario o PIN incorrecto')}
    user=u;await loadAll();launchApp();
    if(!u.sleep_routine?.enabled)document.getElementById('sleepOv').classList.add('open');
    else await procDailySleep();
  }catch(e){showMsg('loginErr','Error de conexi√≥n')}
  finally{setBL('lTxt','lSpin',false)}
}

function launchApp(){
  document.getElementById('loginScr').style.display='none';
  document.getElementById('appHdr').style.display='flex';
  document.getElementById('mainApp').style.display='block';
  document.getElementById('tlDate').value=today();
  loadMantra();renderAll();
}

function doLogout(){
  if(!confirm('¬øCerrar sesi√≥n?'))return;
  if(timerIv)clearInterval(timerIv);
  user=null;timer=null;db={areas:[],projects:[],entries:[]};
  document.getElementById('loginScr').style.display='flex';
  document.getElementById('appHdr').style.display='none';
  document.getElementById('mainApp').style.display='none';
  clearPins('lp');document.getElementById('l-user').focus();
}

// ‚îÄ‚îÄ SLEEP ‚îÄ‚îÄ
async function saveSleepSetup(){
  const st=document.getElementById('ss-sleep').value;
  const wt=document.getElementById('ss-wake').value;
  if(!st||!wt)return alert('Completa ambos horarios');
  try{
    await sb.from('users').update({sleep_routine:{enabled:true,sleep_time:st,wake_time:wt}}).eq('id',user.id);
    user.sleep_routine={enabled:true,sleep_time:st,wake_time:wt};
    document.getElementById('sleepOv').classList.remove('open');
    if(document.getElementById('mainApp').style.display==='none')launchApp();
    await procDailySleep();
  }catch(e){alert('Error: '+e.message)}
}

async function procDailySleep(){
  if(!user?.sleep_routine?.enabled)return;
  const r=user.sleep_routine;
  const tod=new Date(),yest=new Date(tod);yest.setDate(yest.getDate()-1);
  const yStr=yest.toISOString().split('T')[0];
  const{data:ex}=await sb.from('time_entries').select('id').eq('user_id',user.id).eq('type','sleep').eq('date',yStr).maybeSingle();
  if(ex)return;
  const sleepStart=new Date(yStr+'T'+r.sleep_time);
  const wakeEnd=new Date(today()+'T'+r.wake_time);
  const{data:late}=await sb.from('time_entries').select('end_time')
    .eq('user_id',user.id).eq('type','tracked')
    .gte('end_time',sleepStart.toISOString())
    .lte('end_time',wakeEnd.toISOString())
    .order('end_time',{ascending:false}).limit(1);
  if(late&&late.length>0){
    const la=new Date(late[0].end_time);
    const approx=new Date(la.getTime()+30*60000);
    document.getElementById('pop-sleep').value=approx.toTimeString().slice(0,5);
    document.getElementById('pop-wake').value=r.wake_time;
    document.getElementById('sleepPop').classList.add('open');
  }else{
    const dur=Math.floor((wakeEnd-sleepStart)/1000);
    if(dur>0&&dur<86400){
      const{data}=await sb.from('time_entries').insert([{
        user_id:user.id,type:'sleep',description:'Sue√±o',
        start_time:sleepStart.toISOString(),end_time:wakeEnd.toISOString(),
        duration:dur,date:yStr,auto_detected:true
      }]).select().single();
      if(data){db.entries.unshift(data);renderAll()}
    }
  }
}

async function saveSleepPop(){
  const yest=new Date();yest.setDate(yest.getDate()-1);
  const yStr=yest.toISOString().split('T')[0];
  const st=document.getElementById('pop-sleep').value;
  const wt=document.getElementById('pop-wake').value;
  if(!st||!wt)return;
  const start=new Date(yStr+'T'+st),end=new Date(today()+'T'+wt);
  const dur=Math.floor((end-start)/1000);if(dur<=0)return;
  const{data}=await sb.from('time_entries').insert([{
    user_id:user.id,type:'sleep',description:'Sue√±o',
    start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,date:yStr
  }]).select().single();
  if(data)db.entries.unshift(data);
  closeEl('sleepPop');renderAll();
}

async function updSleepRoutine(){
  const st=document.getElementById('esSleep').value;
  const wt=document.getElementById('esWake').value;
  if(!st||!wt)return;
  await sb.from('users').update({sleep_routine:{enabled:true,sleep_time:st,wake_time:wt}}).eq('id',user.id);
  user.sleep_routine={enabled:true,sleep_time:st,wake_time:wt};
  closeM('sleepEditModal');renderTimeline();
}

// ‚îÄ‚îÄ MANTRA ‚îÄ‚îÄ
function loadMantra(){
  const v=localStorage.getItem('1440_m_'+user.id)||'';
  const el=document.getElementById('mantraDisp');
  if(v){el.textContent=v;el.className='mantra-a'}
  else{el.textContent='Toca para escribir tu mantra...';el.className='mantra-ph'}
}
function openMantraModal(){
  document.getElementById('mantraIn').value=localStorage.getItem('1440_m_'+user.id)||'';
  openM('mantraModal');
}
function saveMantra(){
  const v=document.getElementById('mantraIn').value.trim();
  if(v){
    localStorage.setItem('1440_m_'+user.id,v);
    document.getElementById('mantraDisp').textContent=v;
    document.getElementById('mantraDisp').className='mantra-a';
  }
  closeM('mantraModal');
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
async function loadAll(){
  const[a,p,e]=await Promise.all([
    sb.from('categories').select('*').eq('user_id',user.id).order('created_at'),
    sb.from('projects').select('*').eq('user_id',user.id).order('created_at'),
    sb.from('time_entries').select('*').eq('user_id',user.id).order('start_time',{ascending:false}).limit(300)
  ]);
  db.areas=a.data||[];db.projects=p.data||[];db.entries=e.data||[];
}
function renderAll(){updateProg();renderQT();renderTimeline();renderAreas();renderRegs();updSelects()}

// ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ
function updateProg(){
  const m=db.entries.filter(e=>e.date===today()).reduce((s,e)=>s+Math.floor(e.duration/60),0);
  const p=Math.min((m/1440)*100,100);
  document.getElementById('progMin').textContent=m;
  document.getElementById('progPct').textContent=Math.floor(p)+'%';
  document.getElementById('progBar').style.width=p+'%';
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function startTimer(id,type,name,meta){
  if(timerIv){clearInterval(timerIv);timerIv=null}
  timer={id,type,name,meta,start:new Date(),elapsed:0};
  document.getElementById('tBanner').classList.add('on');
  document.getElementById('tbName').textContent=name;
  document.getElementById('tbMeta').textContent=meta;
  document.getElementById('hTimer').classList.add('on');
  document.getElementById('hTName').textContent=name;
  timerIv=setInterval(()=>{
    timer.elapsed++;
    const t=fmtS(timer.elapsed);
    document.getElementById('tbTime').textContent=t;
    document.getElementById('hTTime').textContent=t;
  },1000);
  renderQT();
}
async function stopTimer(){
  if(!timer||!timerIv)return;
  clearInterval(timerIv);timerIv=null;
  const end=new Date();
  const pl={user_id:user.id,type:'tracked',description:timer.name,
    start_time:timer.start.toISOString(),end_time:end.toISOString(),
    duration:timer.elapsed,date:today()};
  if(timer.type==='project')pl.project_id=timer.id;
  if(timer.type==='area')pl.category_id=timer.id;
  const{data}=await sb.from('time_entries').insert([pl]).select().single();
  if(data)db.entries.unshift(data);
  timer=null;
  document.getElementById('tBanner').classList.remove('on');
  document.getElementById('hTimer').classList.remove('on');
  renderAll();
}
function switchAct(){
  stopTimer();
  document.querySelector('.qt-wrap').scrollIntoView({behavior:'smooth',block:'center'});
}

// ‚îÄ‚îÄ QUICK TRACK ‚îÄ‚îÄ
function renderQT(){
  const g=document.getElementById('qtGrid');
  const items=[
    ...db.areas.map(a=>({id:a.id,type:'area',name:a.name,icon:a.icon||'üìÅ',color:a.color,sub:'√Årea de vida'})),
    ...db.projects.map(p=>{
      const ar=db.areas.find(a=>a.id===p.category_id);
      return{id:p.id,type:'project',name:p.name,icon:ar?.icon||'üìå',color:p.color,sub:ar?.name||'Proyecto'};
    })
  ].slice(0,8);
  if(!items.length){
    g.innerHTML=`<div style="grid-column:1/-1;padding:1.5rem;text-align:center;color:var(--t3);font-size:.88rem">
      Crea √°reas o proyectos ‚ö°<br><br>
      <button class="btn btn-sm" onclick="openM('areaModal')">‚ûï Crear √Årea</button></div>`;
    return;
  }
  g.innerHTML=items.map(it=>{
    const on=timer&&timer.id===it.id;
    const m=db.entries.filter(e=>e.date===today()&&(e.category_id===it.id||e.project_id===it.id)).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const bc=it.color?`border-color:${it.color}35`:'';
    return`<div class="qt-item${on?' on':''}" style="${bc}"
      onclick="${on?'stopTimer()':'startTimer(\''+it.id+'\',\''+it.type+'\',\''+esc(it.name)+'\',\''+esc(it.sub)+'\')'}" >
      <div><div class="qt-name">${it.icon} ${it.name}</div><div class="qt-sub">${fmtM(m)} hoy</div></div>
      <div class="qt-play" style="${!on&&it.color?'background:linear-gradient(135deg,'+it.color+','+it.color+'aa)':''}">${on?'‚èπ':'‚ñ∂'}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ
function renderTimeline(){
  const ds=document.getElementById('tlDate').value||today();
  document.getElementById('tlTitle').textContent=ds===today()?'Hoy ‚Äî '+fmtDL(ds):fmtDL(ds);
  const dayE=db.entries.filter(e=>e.date===ds);
  const r=user?.sleep_routine;
  let html='';
  for(let h=0;h<24;h++){
    const lbl=String(h).padStart(2,'0')+':00';
    let isSleep=false;
    if(r?.enabled){
      const sh=parseInt(r.sleep_time?.split(':')[0]||22);
      const wh=parseInt(r.wake_time?.split(':')[0]||7);
      isSleep=sh>wh?(h>=sh||h<wh):(h>=sh&&h<wh);
    }
    const inH=dayE.filter(e=>{
      const s=new Date(e.start_time).getHours();
      const en=new Date(e.end_time).getHours();
      return h>=s&&h<=en;
    });
    let inner='';
    if(inH.length){
      inner=inH.map(e=>{
        const cls=e.type==='sleep'?'tl-sleep':'tl-tracked';
        const pj=db.projects.find(p=>p.id===e.project_id);
        const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
        const lbl2=e.description+(pj?' ¬∑ '+pj.name:'')+(ar?' ¬∑ '+ar.name:'');
        return`<div class="tl-e ${cls}" onclick="openEditReg('${e.id}')">
          ${e.type==='sleep'?'üò¥ ':(ar?.icon?ar.icon+' ':'')}${lbl2}
          <span class="tl-dur">${fmtS(e.duration)}</span>
        </div>`;
      }).join('');
    }else if(isSleep&&ds===today()){
      inner=`<div class="tl-e tl-sleep">üò¥ Sue√±o ‚Äî rutina ${r.sleep_time} ‚Äì ${r.wake_time}</div>`;
    }else{
      inner=`<div class="tl-e tl-gap">Vac√≠o</div>`;
    }
    html+=`<div class="tl-row">
      <div class="tl-lbl">${lbl}</div>
      <div class="tl-col">${inner}<button class="tl-add" onclick="openRetro('${ds}',${h})">+ Agregar</button></div>
    </div>`;
  }
  document.getElementById('tlWrap').innerHTML=html;
  if(ds===today()){
    const ch=new Date().getHours();
    const rows=document.querySelectorAll('.tl-row');
    if(rows[Math.max(0,ch-1)])setTimeout(()=>rows[Math.max(0,ch-1)].scrollIntoView({behavior:'smooth',block:'center'}),120);
  }
}

function openRetro(date,hour){
  document.getElementById('mDate').value=date;
  document.getElementById('mStart').value=String(hour).padStart(2,'0')+':00';
  document.getElementById('mEnd').value=String(hour+1<24?hour+1:hour).padStart(2,'0')+':00';
  document.getElementById('mDesc').value='';
  updSelects();openM('manualModal');
}

// ‚îÄ‚îÄ AREAS ‚îÄ‚îÄ
function renderAreas(){
  const c=document.getElementById('areasC');
  if(!db.areas.length){
    c.innerHTML=`<div style="grid-column:1/-1"><div class="empty"><div class="empty-ic">üìÅ</div>
      <h3>No hay √°reas a√∫n</h3><p>Crea tu primera √°rea de vida</p><br><br>
      <button class="btn btn-sm" onclick="openM('areaModal')">‚ûï Crear √Årea</button></div></div>`;
    return;
  }
  c.innerHTML=db.areas.map((a,i)=>{
    const pjs=db.projects.filter(p=>p.category_id===a.id);
    const tm=db.entries.filter(e=>e.category_id===a.id||db.projects.find(p=>p.id===e.project_id)?.category_id===a.id).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const col=a.color||'#00ffff';
    return`<div class="area-card" style="border-color:${col}30">
      <div class="area-card-top" onclick="toggleArea('ab-${i}','ac-${i}')">
        <div class="area-left">
          <div class="area-stripe" style="background:${col};box-shadow:0 0 8px ${col}60"></div>
          <span class="area-icon">${a.icon||'üìÅ'}</span>
          <div class="area-info">
            <div class="area-name">${a.name}</div>
            <div class="area-cnt">${pjs.length} proyectos</div>
          </div>
        </div>
        <div class="area-right">
          <span class="area-total" style="color:${col}">${fmtM(tm)}</span>
          <button class="ibtn edit" onclick="event.stopPropagation();openEditArea('${a.id}')">‚úèÔ∏è</button>
          <button class="ibtn" onclick="event.stopPropagation();delArea('${a.id}')">üóëÔ∏è</button>
          <span class="area-chev" id="ac-${i}">‚ñ∂</span>
        </div>
      </div>
      <div class="area-body" id="ab-${i}">
        <div class="proj-stack">
          ${pjs.map(p=>projRow(p)).join('')}
        </div>
        <div class="area-footer">
          <button class="btn btn-ghost btn-sm" onclick="openNewProjFor('${a.id}')">‚ûï Proyecto</button>
        </div>
      </div>
    </div>`;
  }).join('');
  // Uncategorized
  const uncat=db.projects.filter(p=>!p.category_id);
  if(uncat.length){
    c.innerHTML+=`<div class="area-card">
      <div class="area-card-top" onclick="toggleArea('ab-uncat','ac-uncat')">
        <div class="area-left">
          <div class="area-stripe" style="background:#5580b3"></div>
          <span class="area-icon">üìå</span>
          <div class="area-info"><div class="area-name">Sin √Årea</div><div class="area-cnt">${uncat.length}</div></div>
        </div>
        <div class="area-right"><span class="area-chev" id="ac-uncat">‚ñ∂</span></div>
      </div>
      <div class="area-body" id="ab-uncat">
        <div class="proj-stack">${uncat.map(p=>projRow(p)).join('')}</div>
      </div>
    </div>`;
  }
}

function projRow(p){
  const m=db.entries.filter(e=>e.project_id===p.id).reduce((s,e)=>s+Math.floor(e.duration/60),0);
  return`<div class="proj-row">
    <div class="proj-dot" style="background:${p.color};box-shadow:0 0 5px ${p.color}"></div>
    <div class="proj-info">
      <div class="proj-name">${p.name}</div>
      <div class="proj-stat">${fmtM(m)} totales</div>
    </div>
    <div class="proj-actions">
      <button class="ibtn" style="background:linear-gradient(135deg,${p.color}33,${p.color}22)"
        onclick="startTimer('${p.id}','project','${esc(p.name)}','Proyecto')">‚ñ∂</button>
      <button class="ibtn edit" onclick="openEditProj('${p.id}')">‚úèÔ∏è</button>
      <button class="ibtn" onclick="delProj('${p.id}')">üóëÔ∏è</button>
    </div>
  </div>`;
}

function toggleArea(bodyId,chevId){
  const b=document.getElementById(bodyId),c=document.getElementById(chevId);
  const open=b.classList.contains('open');
  b.classList.toggle('open',!open);if(c)c.classList.toggle('open',!open);
}

// ‚îÄ‚îÄ REGISTROS ‚îÄ‚îÄ
function renderRegs(){
  const c=document.getElementById('regList');
  let f=[...db.entries];
  const af=document.getElementById('fArea').value;
  if(af){const ps=db.projects.filter(p=>p.category_id===af).map(p=>p.id);f=f.filter(e=>e.category_id===af||ps.includes(e.project_id))}
  const per=document.getElementById('fPer').value;
  const n=new Date(),t=new Date(n.getFullYear(),n.getMonth(),n.getDate());
  if(per==='today')f=f.filter(e=>new Date(e.date)>=t);
  else if(per==='week'){const w=new Date(t);w.setDate(w.getDate()-7);f=f.filter(e=>new Date(e.date)>=w)}
  else if(per==='month'){const m=new Date(t);m.setMonth(m.getMonth()-1);f=f.filter(e=>new Date(e.date)>=m)}
  if(!f.length){c.innerHTML=`<div class="empty"><div class="empty-ic">‚è±Ô∏è</div><h3>Sin registros</h3><p>Usa Quick Track o Registro Manual</p></div>`;return}
  c.innerHTML=f.map(e=>{
    const pj=db.projects.find(p=>p.id===e.project_id);
    const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
    return`<div class="reg-card">
      <div class="reg-dur">${fmtS(e.duration)}</div>
      <div>
        <div class="reg-desc">${e.description}</div>
        <div class="reg-meta">
          <span>${fmtDL(e.date)} ¬∑ ${fmtT(e.start_time)}‚Äì${fmtT(e.end_time)}</span>
          ${ar?`<span class="badge" style="border-color:${ar.color}50">${ar.icon||''} ${ar.name}</span>`:''}
          ${pj?`<span class="badge" style="border-color:${pj.color}">${pj.name}</span>`:''}
          ${e.type==='sleep'?`<span class="badge badge-sleep">üò¥ Sue√±o</span>`:''}
        </div>
      </div>
      <div class="reg-acts">
        ${e.type!=='sleep'?`<button class="ibtn edit" onclick="openEditReg('${e.id}')">‚úèÔ∏è</button>`:''}
        <button class="ibtn" onclick="delEntry('${e.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDash(){renderPie();calcStats()}
function renderPie(){
  const te=db.entries.filter(e=>e.date===today());
  const bk={};let tot=0;
  te.forEach(e=>{
    const m=Math.floor(e.duration/60);tot+=m;
    if(e.type==='sleep'){bk['üò¥ Sue√±o']=(bk['üò¥ Sue√±o']||0)+m;return}
    const pj=db.projects.find(p=>p.id===e.project_id);
    const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
    const lbl=ar?(ar.icon||'')+' '+ar.name:'üìå Sin √°rea';
    bk[lbl]=(bk[lbl]||0)+m;
  });
  const empty=1440-tot;if(empty>0)bk['‚¨õ Vac√≠o']=empty;
  const C=['#00ffff','#0066ff','#8b5cf6','#00ff88','#ff3366','#ffaa00','#6366f1','#374151'];
  let ang=0,paths='',leg='';
  Object.entries(bk).forEach(([lbl,m],i)=>{
    const pc=m/1440,sa=ang;ang+=pc*360;
    const r=40,cx=50,cy=50,ir=22;
    const x1=cx+r*Math.cos((sa-90)*Math.PI/180),y1=cy+r*Math.sin((sa-90)*Math.PI/180);
    const x2=cx+r*Math.cos((ang-90)*Math.PI/180),y2=cy+r*Math.sin((ang-90)*Math.PI/180);
    const xi1=cx+ir*Math.cos((sa-90)*Math.PI/180),yi1=cy+ir*Math.sin((sa-90)*Math.PI/180);
    const xi2=cx+ir*Math.cos((ang-90)*Math.PI/180),yi2=cy+ir*Math.sin((ang-90)*Math.PI/180);
    const lg=pc>.5?1:0,col=C[i%C.length];
    paths+=`<path d="M${xi1} ${yi1} L${x1} ${y1} A${r} ${r} 0 ${lg} 1 ${x2} ${y2} L${xi2} ${yi2} A${ir} ${ir} 0 ${lg} 0 ${xi1} ${yi1} Z" fill="${col}" opacity=".85"/>`;
    leg+=`<div class="legend-item"><div class="legend-dot" style="background:${col}"></div><span>${lbl}</span><span class="legend-val">${fmtM(m)}</span></div>`;
  });
  document.getElementById('pieSvg').innerHTML=paths;
  document.getElementById('pieLeg').innerHTML=leg;
  document.getElementById('piePct').textContent=Math.floor((tot/1440)*100)+'%';
}
function calcStats(){
  const w=new Date();w.setDate(w.getDate()-7);
  const sE=db.entries.filter(e=>e.type==='sleep'&&new Date(e.date)>=w);
  const avgM=sE.length?sE.reduce((s,e)=>s+e.duration,0)/sE.length/60:0;
  document.getElementById('dSleep').textContent=fmtM(Math.round(avgM));
  const tr=db.entries.filter(e=>e.date===today()).reduce((s,e)=>s+Math.floor(e.duration/60),0);
  document.getElementById('dEmpty').textContent=fmtM(1440-tr);
  const trNS=db.entries.filter(e=>e.date===today()&&e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  document.getElementById('dTrack').textContent=fmtM(trNS);
  if(db.areas.length>=2){
    const a1=db.areas[0],ps=db.projects.filter(p=>p.category_id===a1.id).map(p=>p.id);
    const a1m=db.entries.filter(e=>e.date===today()&&(e.category_id===a1.id||ps.includes(e.project_id))).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const tot=db.entries.filter(e=>e.date===today()&&e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const pct=tot?Math.round((a1m/tot)*100):0;
    document.getElementById('dBal').textContent=`${a1.icon||''} ${pct}%`;
    document.getElementById('dBalSub').textContent=`${a1.name} vs resto`;
  }
}

// ‚îÄ‚îÄ SELECTS ‚îÄ‚îÄ
function updSelects(){
  const opts='<option value="">Sin √°rea</option>'+db.areas.map(a=>`<option value="${a.id}">${a.icon||''} ${a.name}</option>`).join('');
  ['pArea','mArea','eArea','fArea'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const v=el.value;el.innerHTML=opts;el.value=v;
  });
  updMProj();updEProj();
}
function updMProj(){
  const aid=document.getElementById('mArea')?.value;
  const ps=aid?db.projects.filter(p=>p.category_id===aid):db.projects;
  document.getElementById('mProj').innerHTML='<option value="">Sin proyecto</option>'+ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}
function updEProj(){
  const aid=document.getElementById('eArea')?.value;
  const ps=aid?db.projects.filter(p=>p.category_id===aid):db.projects;
  document.getElementById('eProj').innerHTML='<option value="">Sin proyecto</option>'+ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}

// ‚îÄ‚îÄ AREA CRUD ‚îÄ‚îÄ
function openEditArea(id){
  const a=db.areas.find(x=>x.id===id);if(!a)return;
  document.getElementById('aEditId').value=id;
  document.getElementById('areaMTitle').textContent='Editar √Årea';
  document.getElementById('aName').value=a.name;
  document.getElementById('aIcon').value=a.icon||'';
  document.getElementById('aColor').value=a.color||'#00ffff';
  openM('areaModal');
}
async function saveArea(){
  const name=document.getElementById('aName').value.trim();
  if(!name)return alert('Ingresa un nombre');
  const editId=document.getElementById('aEditId').value;
  const payload={name,icon:document.getElementById('aIcon').value||'üìÅ',color:document.getElementById('aColor').value};
  if(editId){
    await sb.from('categories').update(payload).eq('id',editId);
    const i=db.areas.findIndex(a=>a.id===editId);
    if(i>-1)db.areas[i]={...db.areas[i],...payload};
  }else{
    const{data,error}=await sb.from('categories').insert([{user_id:user.id,...payload}]).select().single();
    if(error)return alert('Error: '+error.message);
    db.areas.push(data);
  }
  closeM('areaModal');
  document.getElementById('aName').value='';document.getElementById('aIcon').value='';
  document.getElementById('aEditId').value='';document.getElementById('areaMTitle').textContent='Nueva √Årea';
  renderAll();
}
async function delArea(id){
  if(!confirm('¬øEliminar √°rea y sus proyectos?'))return;
  await sb.from('categories').delete().eq('id',id);
  db.areas=db.areas.filter(a=>a.id!==id);db.projects=db.projects.filter(p=>p.category_id!==id);
  renderAll();
}

// ‚îÄ‚îÄ PROJECT CRUD ‚îÄ‚îÄ
function openNewProjFor(areaId){
  document.getElementById('pEditId').value='';
  document.getElementById('projMTitle').textContent='Nuevo Proyecto';
  document.getElementById('pName').value='';
  updSelects();
  setTimeout(()=>document.getElementById('pArea').value=areaId,50);
  openM('projectModal');
}
function openEditProj(id){
  const p=db.projects.find(x=>x.id===id);if(!p)return;
  document.getElementById('pEditId').value=id;
  document.getElementById('projMTitle').textContent='Editar Proyecto';
  document.getElementById('pName').value=p.name;
  document.getElementById('pColor').value=p.color||'#0066ff';
  updSelects();
  setTimeout(()=>document.getElementById('pArea').value=p.category_id||'',50);
  openM('projectModal');
}
async function saveProject(){
  const name=document.getElementById('pName').value.trim();
  if(!name)return alert('Ingresa un nombre');
  const editId=document.getElementById('pEditId').value;
  const payload={name,category_id:document.getElementById('pArea').value||null,color:document.getElementById('pColor').value};
  if(editId){
    await sb.from('projects').update(payload).eq('id',editId);
    const i=db.projects.findIndex(p=>p.id===editId);
    if(i>-1)db.projects[i]={...db.projects[i],...payload};
  }else{
    const{data,error}=await sb.from('projects').insert([{user_id:user.id,...payload}]).select().single();
    if(error)return alert('Error: '+error.message);
    db.projects.push(data);
  }
  closeM('projectModal');
  document.getElementById('pName').value='';document.getElementById('pEditId').value='';
  document.getElementById('projMTitle').textContent='Nuevo Proyecto';
  renderAll();
}
async function delProj(id){
  if(!confirm('¬øEliminar proyecto?'))return;
  await sb.from('projects').delete().eq('id',id);
  db.projects=db.projects.filter(p=>p.id!==id);renderAll();
}

// ‚îÄ‚îÄ MANUAL ENTRY ‚îÄ‚îÄ
async function saveManual(){
  const desc=document.getElementById('mDesc').value.trim();
  const date=document.getElementById('mDate').value;
  const st=document.getElementById('mStart').value;
  const et=document.getElementById('mEnd').value;
  if(!desc||!date||!st||!et)return alert('Completa todos los campos');
  const start=new Date(date+'T'+st),end=new Date(date+'T'+et);
  const dur=Math.floor((end-start)/1000);
  if(dur<=0)return alert('El fin debe ser posterior al inicio');
  const{data,error}=await sb.from('time_entries').insert([{
    user_id:user.id,type:'tracked',description:desc,
    project_id:document.getElementById('mProj').value||null,
    category_id:document.getElementById('mArea').value||null,
    start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,date
  }]).select().single();
  if(error)return alert('Error: '+error.message);
  db.entries.unshift(data);closeM('manualModal');
  document.getElementById('mDesc').value='';renderAll();
}

// ‚îÄ‚îÄ EDIT / DELETE ENTRY ‚îÄ‚îÄ
function openEditReg(id){
  const e=db.entries.find(x=>x.id===id);
  if(!e||e.type==='sleep')return;
  document.getElementById('eId').value=id;
  document.getElementById('eDesc').value=e.description;
  document.getElementById('eDate').value=e.date;
  document.getElementById('eStart').value=fmtT(e.start_time);
  document.getElementById('eEnd').value=fmtT(e.end_time);
  updSelects();
  setTimeout(()=>{
    document.getElementById('eArea').value=e.category_id||'';
    updEProj();
    setTimeout(()=>document.getElementById('eProj').value=e.project_id||'',60);
  },60);
  openM('editRegModal');
}
async function updateReg(){
  const id=document.getElementById('eId').value;
  const desc=document.getElementById('eDesc').value.trim();
  const date=document.getElementById('eDate').value;
  const st=document.getElementById('eStart').value;
  const et=document.getElementById('eEnd').value;
  if(!desc||!date||!st||!et)return alert('Completa todos los campos');
  const start=new Date(date+'T'+st),end=new Date(date+'T'+et);
  const dur=Math.floor((end-start)/1000);
  if(dur<=0)return alert('El fin debe ser posterior');
  const upd={description:desc,date,start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,
    project_id:document.getElementById('eProj').value||null,
    category_id:document.getElementById('eArea').value||null};
  const{error}=await sb.from('time_entries').update(upd).eq('id',id);
  if(error)return alert('Error: '+error.message);
  const i=db.entries.findIndex(e=>e.id===id);
  if(i>-1)db.entries[i]={...db.entries[i],...upd};
  closeM('editRegModal');renderAll();
}
async function delEntry(id){
  if(!confirm('¬øEliminar este registro?'))return;
  await sb.from('time_entries').delete().eq('id',id);
  db.entries=db.entries.filter(e=>e.id!==id);renderAll();
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportCSV(){
  const rows=db.entries.map(e=>{
    const p=db.projects.find(x=>x.id===e.project_id);
    const a=db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);
    return[e.date,`"${e.description}"`,a?.name||'',p?.name||'',fmtT(e.start_time),fmtT(e.end_time),(e.duration/3600).toFixed(2),e.type].join(',');
  });
  dlFile('Fecha,Descripci√≥n,√Årea,Proyecto,Inicio,Fin,Horas,Tipo\n'+rows.join('\n'),'1440-'+today()+'.csv','text/csv');
}
function exportPDF(){
  const{jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(20);doc.text('1440 ‚Äî Reporte de Tiempo',20,20);
  doc.setFontSize(10);doc.text('Generado: '+new Date().toLocaleDateString('es'),20,30);
  let y=45;
  db.entries.forEach(e=>{
    if(y>270){doc.addPage();y=20}
    const p=db.projects.find(x=>x.id===e.project_id);
    const a=db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);
    doc.setFontSize(9);doc.text(`${e.date}  ${e.description}  [${fmtS(e.duration)}]`,20,y);y+=5;
    doc.setFontSize(7.5);doc.text(`${a?.name||'Sin √°rea'} ‚Üí ${p?.name||'Sin proyecto'}  ¬∑  ${fmtT(e.start_time)}‚Äì${fmtT(e.end_time)}`,24,y);y+=6;
  });
  doc.save('1440-report-'+today()+'.pdf');
}
function dlFile(c,n,m){const b=new Blob([c],{type:m});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click();URL.revokeObjectURL(a.href)}

// ‚îÄ‚îÄ TABS / MODALS ‚îÄ‚îÄ
function goTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');document.getElementById('tab-'+name).classList.add('active');
  if(name==='dashboard')renderDash();
  if(name==='timeline')renderTimeline();
}
function openDash(){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab')[3].classList.add('active');
  document.getElementById('tab-dashboard').classList.add('active');
  renderDash();
}
function openM(id){
  if(id==='manualModal'){document.getElementById('mDate').value=today();updSelects()}
  if(id==='sleepEditModal'){document.getElementById('esSleep').value=user.sleep_routine?.sleep_time||'22:30';document.getElementById('esWake').value=user.sleep_routine?.wake_time||'07:00'}
  if(id==='projectModal')updSelects();
  document.getElementById(id).classList.add('open');
}
function closeM(id){document.getElementById(id).classList.remove('open')}
function closeEl(id){document.getElementById(id).classList.remove('open')}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function today(){return new Date().toISOString().split('T')[0]}
function fmtS(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60;return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sc).padStart(2,'0')}`}
function fmtM(m){if(m<0)m=0;return`${Math.floor(m/60)}h ${String(Math.floor(m%60)).padStart(2,'0')}m`}
function fmtT(iso){return new Date(iso).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'})}
function fmtDL(d){return new Date(d+'T12:00:00').toLocaleDateString('es',{weekday:'short',day:'numeric',month:'short'})}
function esc(s){return(s||'').replace(/'/g,"\\'")}
function showMsg(id,txt,ok=false){const el=document.getElementById(id);if(!el)return;el.textContent=txt;el.className='msg '+(ok?'ok':'err');el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),3500)}
function setBL(tid,sid,l){document.getElementById(tid).classList.toggle('hidden',l);document.getElementById(sid).classList.toggle('hidden',!l)}
function clearPins(p){['1','2','3','4'].forEach(i=>{const el=document.getElementById(p+i);if(el)el.value=''})}

document.getElementById('l-user').focus();
</script>
</body>
</html>
