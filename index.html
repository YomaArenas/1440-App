<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>1440</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='431' height='607' viewBox='0 0 431 607' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M144.83 302.403C144.83 283.572 151.765 267.234 165.639 253.388C179.512 239.541 195.88 232.618 214.747 232.618C233.615 232.618 249.983 239.541 263.857 253.388C277.73 267.234 284.664 283.572 284.664 302.403C284.664 321.234 277.73 337.573 263.857 351.419C249.983 365.266 233.615 372.189 214.747 372.189C195.88 372.189 179.512 365.266 165.639 351.419C151.765 337.573 144.83 321.234 144.83 302.403ZM0 237.603C0 162.278 18.8674 103.847 56.6001 62.3084C94.8886 20.7695 147.604 0 214.747 0C281.891 0 334.33 20.7695 372.062 62.3084C410.351 103.847 429.494 162.278 429.494 237.603V367.204C429.494 444.744 410.351 503.729 372.062 544.16C334.33 584.591 281.891 604.807 214.747 604.807C147.604 584.591 94.8886 584.591 56.6001 544.16C18.8674 503.729 0 444.744 0 367.204V237.603ZM214.747 505.113C234.724 505.113 251.371 502.067 264.689 495.975C278.006 489.329 288.826 480.19 297.149 468.559C305.475 456.928 311.3 443.082 314.63 427.02C317.96 410.959 319.623 393.235 319.623 373.85V230.956C319.623 212.679 317.683 195.509 313.799 179.448C309.911 163.387 303.81 149.54 295.487 137.909C287.164 126.278 276.342 117.14 263.024 110.494C249.706 103.293 233.615 99.6934 214.747 99.6934C195.88 99.6934 179.789 103.293 166.471 110.494C153.153 117.14 142.333 126.278 134.009 137.909C125.685 149.54 119.582 163.387 115.697 179.448C111.812 195.509 109.871 212.679 109.871 230.956V373.85C109.871 393.235 111.536 410.959 114.865 427.02C118.194 443.082 124.021 456.928 132.344 468.559C140.668 480.19 151.488 489.329 164.806 495.975C178.124 502.067 194.771 505.113 214.747 505.113Z' fill='url(%23g1)'/%3E%3Cg filter='url(%23f1)'%3E%3Ccircle cx='214' cy='302' r='83' fill='%2300FFFF'/%3E%3C/g%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='0' y1='0' x2='430' y2='607' gradientUnits='userSpaceOnUse'%3E%3Cstop stop-color='%2300FFFF'/%3E%3Cstop offset='1' stop-color='%230066FF'/%3E%3C/linearGradient%3E%3Cfilter id='f1'%3E%3CfeGaussianBlur stdDeviation='4'/%3E%3C/filter%3E%3C/defs%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#050b1f;--bg2:#0a1532;--bg3:#0f1f45;
  --cyan:#00ffff;--blue:#0066ff;--ok:#00ff88;
  --del:#ff3366;--warn:#ffaa00;--sleep:#6366f1;
  --t:#fff;--t2:#99b3d9;--t3:#4a6a99;
  --bdr:#1a3366;--hh:58px;--drawer:280px;
}
html{height:100%}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t);
  min-height:100%;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse at 10% 20%,rgba(0,255,255,.05) 0%,transparent 50%),
             radial-gradient(ellipse at 90% 80%,rgba(0,102,255,.05) 0%,transparent 50%);
  pointer-events:none;z-index:0}

/* ‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê */
.hdr{position:fixed;top:0;left:0;right:0;height:var(--hh);
  background:rgba(5,11,31,.97);backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(26,51,102,.5);
  display:flex;align-items:center;padding:0 .9rem;gap:.6rem;z-index:500}

/* Logo SVG inline */
.logo-wrap{flex-shrink:0;display:flex;align-items:center;height:28px}
.logo-wrap svg{height:100%;width:auto}

/* Header stats pills */
.hstats{display:flex;gap:.4rem;align-items:center;flex:1;overflow:hidden}
.hstat{display:flex;align-items:center;gap:.3rem;
  background:rgba(255,255,255,.04);border:1px solid rgba(26,51,102,.7);
  border-radius:20px;padding:.28rem .65rem;white-space:nowrap}
.hstat-ic{font-size:.8rem}
.hstat-val{font-family:'Space Mono',monospace;font-size:.72rem;font-weight:700;color:var(--cyan)}
.hstat-lbl{font-size:.65rem;color:var(--t3)}

/* Active timer pill in header */
.ht{display:none;align-items:center;gap:.4rem;
  background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.3);
  border-radius:20px;padding:.28rem .7rem;flex-shrink:0}
.ht.on{display:flex}
.ht-dot{width:6px;height:6px;background:var(--ok);border-radius:50%;
  box-shadow:0 0 5px var(--ok);animation:bl 1.4s ease-in-out infinite;flex-shrink:0}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.2}}
.ht-nm{font-size:.72rem;font-weight:600;max-width:90px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ht-t{font-family:'Space Mono',monospace;font-size:.72rem;color:var(--cyan);flex-shrink:0}
.ht-stop{width:20px;height:20px;background:var(--del);border:none;border-radius:4px;
  cursor:pointer;font-size:.6rem;color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Hamburger ‚Üí opens drawer */
.menu-btn{width:36px;height:36px;background:rgba(255,255,255,.04);
  border:1px solid var(--bdr);border-radius:9px;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:4px;flex-shrink:0;transition:all .2s}
.menu-btn:hover{border-color:var(--cyan)}
.menu-btn span{width:16px;height:1.5px;background:var(--t2);
  border-radius:1px;transition:all .25s}
.menu-btn.open span:nth-child(1){transform:translateY(5.5px) rotate(45deg)}
.menu-btn.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.menu-btn.open span:nth-child(3){transform:translateY(-5.5px) rotate(-45deg)}

/* ‚ïê‚ïê‚ïê‚ïê DRAWER ‚ïê‚ïê‚ïê‚ïê */
.drawer-overlay{position:fixed;inset:0;background:rgba(5,11,31,.75);
  z-index:700;opacity:0;pointer-events:none;transition:opacity .3s;
  backdrop-filter:blur(4px)}
.drawer-overlay.open{opacity:1;pointer-events:all}

.drawer{position:fixed;top:0;left:0;bottom:0;width:var(--drawer);
  background:var(--bg2);border-right:1px solid var(--bdr);
  z-index:800;transform:translateX(-100%);
  transition:transform .3s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;overflow:hidden}
.drawer.open{transform:translateX(0)}

.drawer-top{padding:1.2rem 1.1rem .8rem;border-bottom:1px solid var(--bdr)}
.drawer-logo{height:22px;margin-bottom:.5rem}
.drawer-user{font-size:.78rem;color:var(--t2)}
.drawer-user strong{color:var(--cyan);display:block;font-size:.88rem}

.drawer-nav{flex:1;padding:.6rem .5rem;overflow-y:auto}
.drawer-section{font-size:.6rem;text-transform:uppercase;letter-spacing:.12em;
  color:var(--t3);padding:.5rem .6rem .25rem;font-weight:700}
.dnav-item{display:flex;align-items:center;gap:.75rem;
  padding:.72rem .8rem;border-radius:9px;cursor:pointer;
  transition:all .2s;margin-bottom:.1rem;color:var(--t2);font-size:.88rem;font-weight:500}
.dnav-item:hover{background:rgba(0,255,255,.06);color:var(--cyan)}
.dnav-item.active{background:rgba(0,255,255,.1);color:var(--cyan)}
.dnav-item .dico{font-size:1rem;width:20px;text-align:center;flex-shrink:0}
.dnav-badge{margin-left:auto;background:rgba(0,255,255,.15);color:var(--cyan);
  border-radius:10px;padding:.1rem .45rem;font-size:.65rem;font-weight:700}

.drawer-bottom{padding:.8rem .9rem 1rem;border-top:1px solid var(--bdr);
  display:flex;flex-direction:column;gap:.4rem}
.drawer-mantra{background:rgba(0,255,255,.04);border:1px solid rgba(0,255,255,.15);
  border-radius:9px;padding:.6rem .75rem;cursor:pointer;transition:all .2s}
.drawer-mantra:hover{border-color:var(--cyan)}
.drawer-mantra .dq{font-size:.6rem;text-transform:uppercase;letter-spacing:.1em;
  color:var(--t3);font-weight:700;margin-bottom:.2rem}
.drawer-mantra .da{font-size:.78rem;color:var(--cyan);font-weight:600;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.drawer-mantra .dph{font-size:.75rem;color:var(--t3);font-style:italic}

/* ‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê */
.main{max-width:680px;margin:0 auto;
  padding:calc(var(--hh) + 1rem) .9rem 5rem;
  position:relative;z-index:1}

/* ‚ïê‚ïê‚ïê‚ïê PROGRESS DUAL BAR ‚ïê‚ïê‚ïê‚ïê */
.prog-card{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:13px;padding:.85rem 1rem;margin-bottom:.9rem}
.prog-top{display:flex;justify-content:space-between;align-items:center;
  margin-bottom:.55rem;gap:.5rem}
.prog-nums{display:flex;align-items:baseline;gap:.3rem}
.prog-main{font-family:'Space Mono',monospace;font-size:1.05rem;font-weight:700;color:var(--cyan)}
.prog-of{font-size:.72rem;color:var(--t3)}
.prog-pct{font-size:.72rem;color:var(--t2);font-family:'Space Mono',monospace}
.prog-legend{display:flex;gap:.65rem}
.pleg{display:flex;align-items:center;gap:.3rem;font-size:.68rem;color:var(--t3)}
.pleg-dot{width:7px;height:7px;border-radius:2px;flex-shrink:0}
.prog-bar{height:10px;background:var(--bg3);border-radius:5px;
  overflow:hidden;display:flex}
.ps-track{height:100%;background:linear-gradient(90deg,var(--cyan),var(--blue));
  transition:width .5s;position:relative;border-radius:5px 0 0 5px;min-width:0}
.ps-track::after{content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
  animation:shim 2.5s linear infinite}
@keyframes shim{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.ps-sleep{height:100%;background:linear-gradient(90deg,var(--sleep),#4f46e5);
  transition:width .5s;min-width:0}

/* ‚ïê‚ïê‚ïê‚ïê ACTIVE TIMER ‚ïê‚ïê‚ïê‚ïê */
.tban{background:rgba(0,255,136,.04);border:1.5px solid rgba(0,255,136,.3);
  border-radius:13px;padding:.9rem 1rem;margin-bottom:.9rem;display:none}
.tban.on{display:block}
.tban-row{display:flex;align-items:center;justify-content:space-between;gap:.6rem}
.tban-left{display:flex;align-items:center;gap:.6rem;min-width:0}
.tban-dot{width:8px;height:8px;background:var(--ok);border-radius:50%;
  box-shadow:0 0 7px var(--ok);animation:bl 1.4s ease-in-out infinite;flex-shrink:0}
.tban-name{font-size:.95rem;font-weight:700;white-space:nowrap;
  overflow:hidden;text-overflow:ellipsis}
.tban-meta{font-size:.72rem;color:var(--t2);margin-top:.08rem}
.tban-time{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700;
  color:var(--cyan);flex-shrink:0;white-space:nowrap}
.tban-acts{display:flex;gap:.5rem;margin-top:.65rem}
.tban-acts .btn{flex:1}

/* ‚ïê‚ïê‚ïê‚ïê QUICK TRACK + REG MANUAL SPLIT ‚ïê‚ïê‚ïê‚ïê */
.split{display:grid;grid-template-columns:3fr 2fr;gap:.75rem;margin-bottom:.9rem}

.qt-card{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:13px;padding:.85rem .9rem}
.qt-label{font-size:.64rem;font-weight:700;text-transform:uppercase;
  letter-spacing:.1em;color:var(--t3);margin-bottom:.6rem;
  display:flex;align-items:center;gap:.35rem}
.qt-grid{display:grid;grid-template-columns:1fr 1fr;gap:.45rem}
.qt-item{background:var(--bg3);border:1.5px solid var(--bdr);
  border-radius:8px;padding:.55rem .65rem;cursor:pointer;
  transition:all .2s;display:flex;align-items:center;
  justify-content:space-between;gap:.3rem;min-width:0}
.qt-item:hover,.qt-item:active{transform:scale(.98);filter:brightness(1.1)}
.qt-item.on{border-color:var(--ok);background:rgba(0,255,136,.07)}
.qt-nm{font-weight:600;font-size:.78rem;line-height:1.2;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70px}
.qt-st{font-size:.62rem;color:var(--t2);font-family:'Space Mono',monospace;white-space:nowrap}
.qt-play{width:24px;height:24px;background:linear-gradient(135deg,var(--cyan),var(--blue));
  border-radius:5px;display:flex;align-items:center;justify-content:center;
  font-size:.7rem;color:var(--bg);font-weight:700;flex-shrink:0}

.rm-card{background:linear-gradient(135deg,rgba(0,255,255,.05),rgba(0,102,255,.06));
  border:1.5px solid rgba(0,255,255,.2);border-radius:13px;
  padding:.85rem .9rem;cursor:pointer;transition:all .2s;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;text-align:center;gap:.5rem}
.rm-card:hover{border-color:var(--cyan);box-shadow:0 4px 20px rgba(0,255,255,.1)}
.rm-ic{font-size:1.75rem}
.rm-lbl{font-size:.8rem;font-weight:700;color:var(--cyan);
  text-transform:uppercase;letter-spacing:.05em;line-height:1.2}
.rm-sub{font-size:.65rem;color:var(--t2);line-height:1.3}

/* ‚ïê‚ïê‚ïê‚ïê SECTION PAGES (drawer pages) ‚ïê‚ïê‚ïê‚ïê */
.page{display:none;padding-top:.3rem}
.page.active{display:block}
.page-title{font-size:1rem;font-weight:700;margin-bottom:.9rem;
  display:flex;align-items:center;gap:.5rem}

/* ‚ïê‚ïê‚ïê‚ïê TIMELINE ‚ïê‚ïê‚ïê‚ïê */
.tl-reflect{background:linear-gradient(135deg,rgba(99,102,241,.07),rgba(0,102,255,.07));
  border:1px solid rgba(99,102,241,.25);border-radius:10px;
  padding:.65rem .85rem;margin-bottom:.8rem;
  font-size:.78rem;color:#a5b4fc;font-style:italic;
  text-align:center;line-height:1.5}
.tl-reflect strong{display:block;font-size:.62rem;text-transform:uppercase;
  letter-spacing:.09em;color:var(--sleep);margin-bottom:.25rem;font-style:normal}
.tl-head{display:flex;justify-content:space-between;align-items:center;
  margin-bottom:.75rem;flex-wrap:wrap;gap:.5rem}
.tl-wrap{overflow-y:auto;-webkit-overflow-scrolling:touch;max-height:calc(100vh - 280px)}
.tl-row{display:grid;grid-template-columns:44px 1fr;
  min-height:60px;border-bottom:1px solid rgba(26,51,102,.25)}
.tl-lbl{padding:.4rem .35rem 0 0;font-size:.65rem;color:var(--t3);
  font-family:'Space Mono',monospace;text-align:right;flex-shrink:0}
.tl-col{position:relative;padding:3px 4px 3px 6px;min-height:60px}
.tl-e{border-radius:6px;padding:.32rem .6rem;font-size:.76rem;font-weight:600;
  margin-bottom:2px;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;gap:.4rem;min-height:28px}
.tl-e:hover{filter:brightness(1.15)}
.tl-tracked{background:rgba(0,255,255,.09);border-left:2.5px solid var(--cyan);color:var(--cyan)}
.tl-sleep{background:rgba(99,102,241,.12);border-left:2.5px solid var(--sleep);color:#a5b4fc}
.tl-gap{background:rgba(255,255,255,.02);border-left:2px dashed rgba(26,51,102,.5);
  color:var(--t3);font-weight:400;cursor:default;font-size:.7rem}
.tl-dur{font-size:.64rem;opacity:.6;margin-left:auto;
  font-family:'Space Mono',monospace;white-space:nowrap;flex-shrink:0}
.tl-add{position:absolute;right:4px;top:4px;background:transparent;
  border:1px dashed var(--bdr);color:var(--t3);border-radius:4px;
  padding:.12rem .38rem;font-size:.62rem;cursor:pointer;
  transition:all .15s;font-family:inherit;opacity:0}
.tl-row:hover .tl-add,.tl-row:focus-within .tl-add{opacity:1}
.tl-add:hover{border-color:var(--cyan);color:var(--cyan)}
.sl-edit{background:transparent;border:none;color:#a5b4fc;
  cursor:pointer;font-size:.65rem;padding:.1rem .3rem;
  text-decoration:underline;flex-shrink:0}

/* ‚ïê‚ïê‚ïê‚ïê HISTORIAL AGRUPADO POR D√çA ‚ïê‚ïê‚ïê‚ïê */
.hist-filters{display:flex;gap:.45rem;margin-bottom:.75rem;flex-wrap:wrap}
.hf-in{flex:1;min-width:140px;background:var(--bg2);border:1.5px solid var(--bdr);
  border-radius:8px;padding:.48rem .75rem;color:var(--t);
  font-family:inherit;font-size:.8rem}
.hf-in:focus{outline:none;border-color:var(--cyan)}
.hf-sel{background:var(--bg2);border:1.5px solid var(--bdr);border-radius:8px;
  padding:.48rem .6rem;color:var(--t);font-family:inherit;font-size:.78rem;cursor:pointer}
.hf-sel:focus{outline:none;border-color:var(--cyan)}

/* Day group */
.day-group{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:12px;margin-bottom:.65rem;overflow:hidden}
.day-head{display:flex;align-items:center;justify-content:space-between;
  padding:.75rem 1rem;cursor:pointer;transition:background .15s}
.day-head:hover{background:rgba(255,255,255,.03)}
.day-date{font-weight:700;font-size:.88rem;display:flex;align-items:center;gap:.5rem}
.day-stats{display:flex;gap:.5rem;align-items:center}
.day-dur{font-family:'Space Mono',monospace;font-size:.78rem;color:var(--cyan)}
.day-cnt{font-size:.7rem;color:var(--t3);padding:.12rem .45rem;
  background:var(--bg3);border-radius:10px}
.day-chev{font-size:.72rem;color:var(--t3);transition:transform .25s;margin-left:.3rem}
.day-chev.open{transform:rotate(90deg)}
.day-entries{display:none;padding:0 .75rem .75rem}
.day-entries.open{display:block}
.reg-item{display:flex;align-items:center;gap:.65rem;
  padding:.55rem .5rem;border-radius:8px;transition:background .15s}
.reg-item:hover{background:rgba(255,255,255,.03)}
.reg-color{width:3px;height:32px;border-radius:2px;flex-shrink:0}
.reg-body{flex:1;min-width:0}
.reg-desc{font-size:.82rem;font-weight:600;white-space:nowrap;
  overflow:hidden;text-overflow:ellipsis}
.reg-meta{font-size:.68rem;color:var(--t2);display:flex;gap:.35rem;
  flex-wrap:wrap;align-items:center;margin-top:.1rem}
.reg-dur-s{font-family:'Space Mono',monospace;font-size:.78rem;
  color:var(--cyan);white-space:nowrap;flex-shrink:0}
.reg-acts{display:flex;gap:.25rem;flex-shrink:0}
.badge{padding:.1rem .4rem;background:var(--bg3);
  border:1px solid var(--bdr);border-radius:4px;font-size:.65rem}
.badge-sl{border-color:var(--sleep);color:#a5b4fc}

/* ‚ïê‚ïê‚ïê‚ïê √ÅREAS ‚ïê‚ïê‚ïê‚ïê */
.areas-list{display:flex;flex-direction:column;gap:.65rem}
.area-card{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:12px;overflow:hidden}
.area-head{display:flex;align-items:center;justify-content:space-between;
  padding:.8rem .95rem;cursor:pointer}
.area-head:hover{background:rgba(255,255,255,.02)}
.area-left{display:flex;align-items:center;gap:.6rem}
.area-stripe{width:4px;height:30px;border-radius:2px;flex-shrink:0}
.area-ic{font-size:1.2rem}
.area-nm{font-size:.9rem;font-weight:700}
.area-cnt{font-size:.68rem;color:var(--t3)}
.area-right{display:flex;align-items:center;gap:.4rem}
.area-tot{font-family:'Space Mono',monospace;font-size:.76rem;font-weight:700}
.area-chev{font-size:.7rem;color:var(--t3);transition:transform .25s}
.area-chev.open{transform:rotate(90deg)}
.area-body{display:none;padding:0 .85rem .85rem}
.area-body.open{display:block}
.proj-stack{display:flex;flex-direction:column;gap:.35rem;margin-top:.5rem}
.proj-row{background:var(--bg3);border:1px solid var(--bdr);
  border-radius:8px;padding:.55rem .7rem;
  display:flex;align-items:center;gap:.55rem}
.proj-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.proj-inf{flex:1;min-width:0}
.proj-nm{font-weight:600;font-size:.82rem;white-space:nowrap;
  overflow:hidden;text-overflow:ellipsis}
.proj-st{font-size:.66rem;color:var(--t2);font-family:'Space Mono',monospace}
.proj-acts{display:flex;gap:.25rem}

/* ‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê */
.dash-stats{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom:.8rem}
.dstat{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:11px;padding:.85rem .95rem}
.dstat h4{font-size:.62rem;text-transform:uppercase;
  letter-spacing:.09em;color:var(--t3);margin-bottom:.45rem}
.dstat-v{font-family:'Space Mono',monospace;font-size:1.7rem;font-weight:800;
  background:linear-gradient(135deg,var(--cyan),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.dstat-s{font-size:.68rem;color:var(--t3);margin-top:.15rem}
.dash-pie{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:12px;padding:1rem;margin-bottom:.7rem}
.dash-pie h4{font-size:.62rem;text-transform:uppercase;
  letter-spacing:.09em;color:var(--t3);margin-bottom:.7rem}
.pie-layout{display:flex;align-items:center;gap:1.2rem;flex-wrap:wrap}
.pie-wrap{position:relative;width:130px;height:130px;flex-shrink:0}
.pie-svg{width:100%;height:100%}
.pie-ctr{position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);text-align:center}
.pie-pct{font-family:'Space Mono',monospace;font-size:1.1rem;
  font-weight:700;color:var(--cyan)}
.pie-sub{font-size:.6rem;color:var(--t3)}
.pie-leg{flex:1;min-width:120px}
.leg-item{display:flex;align-items:center;gap:.4rem;
  margin-bottom:.32rem;font-size:.74rem}
.leg-dot{width:9px;height:9px;border-radius:2px;flex-shrink:0}
.leg-val{margin-left:auto;font-family:'Space Mono',monospace;
  font-size:.68rem;color:var(--cyan)}

/* ‚ïê‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê‚ïê */
.btn{background:linear-gradient(135deg,var(--cyan),var(--blue));color:var(--bg);
  border:none;border-radius:9px;padding:.62rem 1.1rem;
  font-family:inherit;font-size:.84rem;font-weight:700;cursor:pointer;
  transition:all .2s;display:inline-flex;align-items:center;
  justify-content:center;gap:.4rem;white-space:nowrap;letter-spacing:.02em}
.btn:hover{filter:brightness(1.1)}
.btn:active{transform:scale(.97)}
.btn-sm{padding:.38rem .72rem;font-size:.75rem}
.btn-xs{padding:.26rem .5rem;font-size:.68rem}
.btn-full{width:100%}
.btn-ok{background:linear-gradient(135deg,var(--ok),#00cc70);color:#000}
.btn-del{background:linear-gradient(135deg,var(--del),#cc0044);color:#fff}
.btn-ghost{background:transparent;color:var(--cyan);border:1.5px solid var(--bdr)}
.btn-ghost:hover{border-color:var(--cyan)}
.btn-sl{background:linear-gradient(135deg,var(--sleep),#4f46e5);color:#fff}
.ibtn{width:27px;height:27px;background:rgba(255,255,255,.04);
  border:1px solid var(--bdr);border-radius:6px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:.75rem;color:var(--t2);transition:all .15s}
.ibtn:hover{border-color:var(--cyan);color:var(--cyan)}
.ibtn.del:hover{border-color:var(--del);color:var(--del)}

/* ‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê */
.overlay{display:none;position:fixed;inset:0;
  background:rgba(5,11,31,.9);backdrop-filter:blur(8px);
  z-index:900;align-items:flex-end;justify-content:center;padding:.5rem}
.overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:18px 18px 16px 16px;padding:1.4rem;
  width:100%;max-width:480px;max-height:90vh;overflow-y:auto}
@media(min-width:520px){
  .overlay{align-items:center;padding:1rem}
  .modal{border-radius:18px}
}
.mhd{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.1rem}
.mhd h2{font-size:1.1rem;font-weight:700}
.mclose{width:27px;height:27px;background:var(--bg3);border:1px solid var(--bdr);
  border-radius:6px;cursor:pointer;display:flex;align-items:center;
  justify-content:center;color:var(--t2);font-size:.95rem;transition:all .15s}
.mclose:hover{border-color:var(--cyan);color:var(--cyan)}
.fg{margin-bottom:.85rem}
.fg label{display:block;font-size:.75rem;font-weight:600;
  color:var(--t2);margin-bottom:.32rem}
.fg input,.fg select,.fg textarea{width:100%;background:var(--bg3);
  border:1.5px solid var(--bdr);border-radius:8px;
  padding:.65rem .85rem;color:var(--t);font-family:inherit;font-size:.86rem;transition:all .2s}
.fg input:focus,.fg select:focus{outline:none;border-color:var(--cyan);
  box-shadow:0 0 0 3px rgba(0,255,255,.07)}
input[type=color]{height:40px;cursor:pointer;padding:.18rem}
input[type=time]{font-family:'Space Mono',monospace}
input[type=range]{width:100%;accent-color:var(--cyan);cursor:pointer}
.r2{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
.mbtns{display:flex;gap:.55rem;margin-top:1rem}
.mbtns .btn{flex:1}

/* Duration tabs */
.dur-tabs{display:flex;gap:.35rem;flex-wrap:wrap;margin-bottom:.75rem}
.dtab{background:var(--bg3);border:1.5px solid var(--bdr);
  border-radius:7px;padding:.4rem .7rem;cursor:pointer;
  font-size:.79rem;font-weight:600;color:var(--t2);transition:all .15s}
.dtab:hover{border-color:var(--cyan);color:var(--cyan)}
.dtab.sel{background:rgba(0,255,255,.1);border-color:var(--cyan);color:var(--cyan)}
.slider-lbl{font-family:'Space Mono',monospace;font-size:1.3rem;font-weight:700;
  color:var(--cyan);text-align:center;margin-bottom:.3rem}
.slider-hints{display:flex;justify-content:space-between;
  font-size:.62rem;color:var(--t3);margin-top:.18rem}

/* Emoji grid */
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:.3rem;
  background:var(--bg3);border-radius:8px;padding:.45rem;
  max-height:140px;overflow-y:auto;margin-top:.4rem}
.ep{font-size:1.25rem;width:30px;height:30px;display:flex;
  align-items:center;justify-content:center;border-radius:5px;
  cursor:pointer;transition:background .15s;border:1.5px solid transparent}
.ep:hover{background:rgba(0,255,255,.1)}
.ep.sel{background:rgba(0,255,255,.15);border-color:var(--cyan)}

/* ‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê */
.lscr{position:fixed;inset:0;background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding:1rem;z-index:1000}
.lbox{background:var(--bg2);border:1px solid var(--bdr);
  border-radius:18px;padding:1.6rem;max-width:340px;width:100%}
.llogo{text-align:center;margin-bottom:1.2rem}
.llogo svg{height:36px;width:auto}
.lsub{color:var(--t2);font-size:.74rem;margin-top:.35rem;text-align:center}
.ltabs{display:flex;gap:.28rem;background:var(--bg3);
  padding:.22rem;border-radius:8px;margin-bottom:1.1rem}
.ltab{flex:1;background:transparent;border:none;border-radius:6px;
  padding:.52rem;cursor:pointer;font-family:inherit;font-weight:600;
  font-size:.82rem;color:var(--t2);transition:all .2s}
.ltab.active{background:linear-gradient(135deg,var(--cyan),var(--blue));color:var(--bg)}
.lform{display:none}
.lform.active{display:block}
.pin-row{display:flex;gap:.45rem;justify-content:center;margin:.8rem 0}
.pin-d{width:46px;height:54px;background:var(--bg3);border:2px solid var(--bdr);
  border-radius:9px;color:var(--cyan);font-size:1.45rem;font-weight:700;
  text-align:center;font-family:'Space Mono',monospace;transition:all .2s}
.pin-d:focus{outline:none;border-color:var(--cyan);transform:scale(1.05)}
.ibox{background:rgba(0,255,255,.04);border-left:3px solid var(--cyan);
  padding:.65rem .8rem;border-radius:7px;margin:.65rem 0;font-size:.75rem;color:var(--t2)}
.ibox.warn{border-left-color:var(--warn)}
.ibox strong{display:block;margin-bottom:.18rem;color:var(--cyan)}
.ibox.warn strong{color:var(--warn)}
.fmsg{padding:.6rem;border-radius:7px;margin:.5rem 0;
  text-align:center;font-weight:600;font-size:.78rem}
.fmsg.err{background:rgba(255,51,102,.08);border:1.5px solid var(--del);color:var(--del)}
.fmsg.ok{background:rgba(0,255,136,.08);border:1.5px solid var(--ok);color:var(--ok)}
.hidden{display:none!important}
.spin{display:inline-block;width:12px;height:12px;
  border:2px solid rgba(255,255,255,.2);border-top-color:currentColor;
  border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}

/* Sleep overlay + popup */
.sl-ov{display:none;position:fixed;inset:0;
  background:rgba(5,11,31,.97);backdrop-filter:blur(10px);
  z-index:1100;align-items:center;justify-content:center;padding:1rem}
.sl-ov.open{display:flex}
.sl-pop{display:none;position:fixed;bottom:1rem;right:.75rem;left:.75rem;
  background:var(--bg2);border:1.5px solid var(--sleep);border-radius:14px;
  padding:1rem;z-index:650;max-width:320px;margin:0 auto;
  box-shadow:0 8px 32px rgba(99,102,241,.25)}
.sl-pop.open{display:block;animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* Empty state */
.empty{text-align:center;padding:1.75rem 1rem;color:var(--t3)}
.empty-ic{font-size:2rem;opacity:.2;margin-bottom:.4rem}
.empty h3{font-size:.9rem;color:var(--t);margin-bottom:.22rem}
.empty p{font-size:.75rem}

/* Scrollbar */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px}

/* Responsive */
@media(max-width:480px){
  :root{--hh:52px}
  .main{padding:calc(var(--hh)+.8rem) .7rem 5rem}
  .split{grid-template-columns:3fr 2fr;gap:.55rem}
  .qt-grid{grid-template-columns:1fr 1fr}
  .dash-stats{grid-template-columns:1fr 1fr}
  .r2{grid-template-columns:1fr}
  .prog-card{padding:.7rem .8rem}
  .tban-time{font-size:1.2rem}
  .hstats{gap:.25rem}
  .hstat{padding:.22rem .45rem}
  .hstat-lbl{display:none}
}
@media(max-width:360px){
  .split{grid-template-columns:1fr;grid-template-rows:auto auto}
  .rm-card{flex-direction:row;text-align:left;gap:.65rem;padding:.7rem}
  .rm-ic{font-size:1.4rem}
  .hstats .hstat:nth-child(n+3){display:none}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div class="lscr" id="lscr">
  <div class="lbox">
    <div class="llogo">
      <svg viewBox="0 0 803 297" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M78.5156 213.543V62.6669H73.1622L53.5333 133.947H16.06V130.383L41.0422 43.0649H117.773V213.543H169.522V250.965H19.6289V213.543H78.5156ZM257.765 43.0649H332.116V174.339H362.452V211.761H332.116V250.965H292.859V211.761H200.067V157.707L257.765 43.0649ZM233.972 168.993V174.339H292.859V62.6669H287.505L233.972 168.993ZM446.53 43.0649H520.882V174.339H551.218V211.761H520.882V250.965H481.625V211.761H388.833V157.707L446.53 43.0649ZM422.738 168.993V174.339H481.625V62.6669H476.271L422.738 168.993Z" fill="url(#lg1)"/>
        <path d="M631.098 147.015C631.098 140.283 633.577 134.442 638.534 129.492C643.491 124.542 649.339 122.067 656.081 122.067C662.822 122.067 668.671 124.542 673.628 129.492C678.585 134.442 681.063 140.283 681.063 147.015C681.063 153.747 678.585 159.588 673.628 164.538C668.671 169.488 662.822 171.963 656.081 171.963C649.339 171.963 643.491 169.488 638.534 164.538C633.577 159.588 631.098 153.747 631.098 147.015ZM579.35 123.849C579.35 96.9207 586.091 76.032 599.573 61.182C613.254 46.332 632.09 38.907 656.081 38.907C680.072 38.907 698.809 46.332 712.291 61.182C725.971 76.032 732.812 96.9207 732.812 123.849V170.181C732.812 197.901 725.971 218.988 712.291 233.442C698.809 247.896 680.072 255.123 656.081 255.123C632.09 255.123 613.254 247.896 599.573 233.442C586.091 218.988 579.35 197.901 579.35 170.181V123.849ZM656.081 219.483C663.218 219.483 669.167 218.394 673.925 216.216C678.684 213.84 682.55 210.573 685.524 206.415C688.498 202.257 690.58 197.307 691.77 191.565C692.959 185.823 693.554 179.487 693.554 172.557V121.473C693.554 114.939 692.86 108.801 691.472 103.059C690.084 97.3172 687.903 92.367 684.929 88.209C681.955 84.051 678.089 80.784 673.33 78.408C668.572 75.8337 662.822 74.547 656.081 74.547C649.339 74.547 643.59 75.8337 638.831 78.408C634.073 80.784 630.206 84.051 627.232 88.209C624.258 92.367 622.077 97.3172 620.689 103.059C619.301 108.801 618.607 114.939 618.607 121.473V172.557C618.607 179.487 619.202 185.823 620.392 191.565C621.581 197.307 623.663 202.257 626.637 206.415C629.611 210.573 633.478 213.84 638.236 216.216C642.995 218.394 648.943 219.483 656.081 219.483Z" fill="url(#lg2)"/>
        <g filter="url(#flt)">
          <circle cx="656" cy="147" r="29.5" fill="#00FFFF"/>
        </g>
        <defs>
          <linearGradient id="lg1" x1="87" y1="-61" x2="489" y2="329" gradientUnits="userSpaceOnUse">
            <stop stop-color="#00FFFF"/><stop offset="1" stop-color="#0066FF"/>
          </linearGradient>
          <linearGradient id="lg2" x1="579" y1="39" x2="733" y2="255" gradientUnits="userSpaceOnUse">
            <stop stop-color="#00FFFF"/><stop offset="1" stop-color="#00A0A0"/>
          </linearGradient>
          <filter id="flt"><feGaussianBlur stdDeviation="3"/></filter>
        </defs>
      </svg>
      <div class="lsub">Cada minuto cuenta</div>
    </div>
    <div class="ltabs">
      <button class="ltab active" onclick="swLT('login')">Ingresar</button>
      <button class="ltab" onclick="swLT('register')">Crear Cuenta</button>
    </div>
    <div class="lform active" id="lf-login">
      <div class="fg"><label>Usuario</label>
        <input type="text" id="l-u" placeholder="tu_usuario" autocomplete="off" autocapitalize="none" inputmode="text"></div>
      <div class="fg"><label>PIN</label>
        <div class="pin-row">
          <input type="password" maxlength="1" class="pin-d" id="lp1" oninput="pf(this,'lp2')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="lp2" oninput="pf(this,'lp3')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="lp3" oninput="pf(this,'lp4')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="lp4" oninput="autoLg()" inputmode="numeric">
        </div>
      </div>
      <div id="lErr" class="fmsg err hidden"></div>
      <button class="btn btn-full" onclick="doLogin()">
        <span id="lT">Ingresar</span><span id="lS" class="spin hidden"></span>
      </button>
    </div>
    <div class="lform" id="lf-register">
      <div class="fg"><label>Elige un usuario √∫nico</label>
        <input type="text" id="r-u" placeholder="tu_usuario" autocomplete="off" autocapitalize="none" inputmode="text"></div>
      <div class="fg"><label>PIN de 4 d√≠gitos</label>
        <div class="pin-row">
          <input type="password" maxlength="1" class="pin-d" id="rp1" oninput="pf(this,'rp2')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="rp2" oninput="pf(this,'rp3')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="rp3" oninput="pf(this,'rp4')" inputmode="numeric">
          <input type="password" maxlength="1" class="pin-d" id="rp4" inputmode="numeric">
        </div>
      </div>
      <div class="ibox warn"><strong>‚ö†Ô∏è Recuerda</strong>Usuario √∫nico ¬∑ PIN personal ¬∑ Sin recuperaci√≥n</div>
      <div id="rErr" class="fmsg err hidden"></div>
      <div id="rOk" class="fmsg ok hidden"></div>
      <button class="btn btn-ok btn-full" onclick="doReg()">
        <span id="rT">Crear Cuenta</span><span id="rS" class="spin hidden"></span>
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SLEEP SETUP ‚ïê‚ïê -->
<div class="sl-ov" id="slOv">
  <div class="modal" style="max-width:380px">
    <div style="text-align:center;margin-bottom:1rem">
      <div style="font-size:2rem;margin-bottom:.3rem">üò¥</div>
      <h2 style="font-size:1.15rem;background:linear-gradient(135deg,var(--cyan),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Configura tu Sue√±o</h2>
      <p style="color:var(--t2);font-size:.76rem;margin-top:.25rem">1440 lo registra autom√°ticamente cada d√≠a</p>
    </div>
    <div class="r2">
      <div class="fg"><label>üåô Duermo a:</label><input type="time" id="ss-sl" value="22:30"></div>
      <div class="fg"><label>‚òÄÔ∏è Despierto a:</label><input type="time" id="ss-wk" value="07:00"></div>
    </div>
    <button class="btn btn-ok btn-full" onclick="saveSleepSetup()">Guardar Rutina</button>
  </div>
</div>

<!-- ‚ïê‚ïê SLEEP POPUP ‚ïê‚ïê -->
<div class="sl-pop" id="slPop">
  <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.7rem">
    <span style="font-size:1.2rem">üò¥</span>
    <div><div style="font-weight:700;font-size:.85rem">¬øC√≥mo dormiste?</div>
    <div style="font-size:.68rem;color:var(--t2)">Actividad fuera de rutina detectada</div></div>
  </div>
  <div class="r2" style="margin-bottom:.7rem">
    <div class="fg"><label>Dorm√≠ a:</label><input type="time" id="pop-sl"></div>
    <div class="fg"><label>Despert√© a:</label><input type="time" id="pop-wk"></div>
  </div>
  <div style="display:flex;gap:.4rem">
    <button class="btn btn-ok btn-full btn-sm" onclick="saveSleepPop()">Guardar</button>
    <button class="btn btn-ghost btn-sm" onclick="closeEl('slPop')">Ignorar</button>
  </div>
</div>

<!-- ‚ïê‚ïê DRAWER OVERLAY ‚ïê‚ïê -->
<div class="drawer-overlay" id="drOv" onclick="closeDrawer()"></div>

<!-- ‚ïê‚ïê DRAWER ‚ïê‚ïê -->
<nav class="drawer" id="drawer">
  <div class="drawer-top">
    <svg class="drawer-logo" viewBox="0 0 803 297" fill="none">
      <path d="M78.5156 213.543V62.6669H73.1622L53.5333 133.947H16.06V130.383L41.0422 43.0649H117.773V213.543H169.522V250.965H19.6289V213.543H78.5156ZM257.765 43.0649H332.116V174.339H362.452V211.761H332.116V250.965H292.859V211.761H200.067V157.707L257.765 43.0649ZM233.972 168.993V174.339H292.859V62.6669H287.505L233.972 168.993ZM446.53 43.0649H520.882V174.339H551.218V211.761H520.882V250.965H481.625V211.761H388.833V157.707L446.53 43.0649ZM422.738 168.993V174.339H481.625V62.6669H476.271L422.738 168.993Z" fill="url(#dlg1)"/>
      <path d="M631.098 147.015C631.098 140.283 633.577 134.442 638.534 129.492C643.491 124.542 649.339 122.067 656.081 122.067C662.822 122.067 668.671 124.542 673.628 129.492C678.585 134.442 681.063 140.283 681.063 147.015C681.063 153.747 678.585 159.588 673.628 164.538C668.671 169.488 662.822 171.963 656.081 171.963C649.339 171.963 643.491 169.488 638.534 164.538C633.577 159.588 631.098 153.747 631.098 147.015ZM579.35 123.849V170.181C579.35 197.901 586.091 218.988 599.573 233.442C613.254 247.896 632.09 255.123 656.081 255.123C680.072 255.123 698.809 247.896 712.291 233.442C725.971 218.988 732.812 197.901 732.812 170.181V123.849C732.812 96.9207 725.971 76.032 712.291 61.182C698.809 46.332 680.072 38.907 656.081 38.907C632.09 38.907 613.254 46.332 599.573 61.182C586.091 76.032 579.35 96.9207 579.35 123.849Z" fill="url(#dlg2)"/>
      <circle cx="656" cy="147" r="29.5" fill="#00FFFF" opacity=".9"/>
      <defs>
        <linearGradient id="dlg1" x1="87" y1="-61" x2="489" y2="329" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFFF"/><stop offset="1" stop-color="#0066FF"/></linearGradient>
        <linearGradient id="dlg2" x1="579" y1="39" x2="733" y2="255" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFFF"/><stop offset="1" stop-color="#00A0A0"/></linearGradient>
      </defs>
    </svg>
    <div class="drawer-user">Bienvenido, <strong id="drUser">‚Äî</strong></div>
  </div>

  <div class="drawer-nav">
    <div class="drawer-section">Secciones</div>
    <div class="dnav-item active" id="dn-home" onclick="goPage('home','dn-home')">
      <span class="dico">üè†</span>Inicio
    </div>
    <div class="dnav-item" id="dn-tl" onclick="goPage('tl','dn-tl')">
      <span class="dico">üìÖ</span>Timeline
    </div>
    <div class="dnav-item" id="dn-areas" onclick="goPage('areas','dn-areas')">
      <span class="dico">üìÅ</span>√Åreas & Proyectos
    </div>
    <div class="dnav-item" id="dn-hist" onclick="goPage('hist','dn-hist')">
      <span class="dico">üìã</span>Historial
    </div>
    <div class="dnav-item" id="dn-dash" onclick="goPage('dash','dn-dash')">
      <span class="dico">üìä</span>Dashboard
    </div>

    <div class="drawer-section" style="margin-top:.5rem">Acciones</div>
    <div class="dnav-item" onclick="openM('areaM');closeDrawer()">
      <span class="dico">‚ûï</span>Nueva √Årea
    </div>
    <div class="dnav-item" onclick="openM('projM');closeDrawer()">
      <span class="dico">‚ûï</span>Nuevo Proyecto
    </div>
    <div class="dnav-item" onclick="openSleepEdit();closeDrawer()">
      <span class="dico">üò¥</span>Editar Rutina Sue√±o
    </div>
    <div class="dnav-item" onclick="exportCSV();closeDrawer()">
      <span class="dico">üì•</span>Exportar CSV
    </div>
    <div class="dnav-item" onclick="exportPDF();closeDrawer()">
      <span class="dico">üìÑ</span>Exportar PDF
    </div>
    <div class="dnav-item" style="color:#ff6b6b;margin-top:.3rem" onclick="doLogout()">
      <span class="dico">üö™</span>Cerrar Sesi√≥n
    </div>
  </div>

  <div class="drawer-bottom">
    <div class="drawer-mantra" onclick="openM('mantraM');closeDrawer()">
      <div class="dq">¬øQui√©n quieres ser?</div>
      <div id="drMantra" class="dph">Toca para escribir tu mantra...</div>
    </div>
  </div>
</nav>

<!-- ‚ïê‚ïê MANTRA MODAL ‚ïê‚ïê -->
<div class="overlay" id="mantraM">
  <div class="modal" style="max-width:380px">
    <div class="mhd"><h2>üåü Tu Mantra</h2><button class="mclose" onclick="closeM('mantraM')">√ó</button></div>
    <p style="color:var(--t2);font-size:.8rem;margin-bottom:.9rem">Quedar√° fijo como recordatorio diario.</p>
    <div class="fg"><label>¬øQui√©n quieres ser?</label>
      <input type="text" id="manIn" placeholder="Tu mantra..." maxlength="60"></div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('mantraM')">Cancelar</button>
      <button class="btn" onclick="saveMantra()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê APP HEADER ‚ïê‚ïê -->
<header class="hdr" id="appHdr" style="display:none">
  <div class="logo-wrap">
    <svg viewBox="0 0 803 297" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M78.5156 213.543V62.6669H73.1622L53.5333 133.947H16.06V130.383L41.0422 43.0649H117.773V213.543H169.522V250.965H19.6289V213.543H78.5156ZM257.765 43.0649H332.116V174.339H362.452V211.761H332.116V250.965H292.859V211.761H200.067V157.707L257.765 43.0649ZM233.972 168.993V174.339H292.859V62.6669H287.505L233.972 168.993ZM446.53 43.0649H520.882V174.339H551.218V211.761H520.882V250.965H481.625V211.761H388.833V157.707L446.53 43.0649ZM422.738 168.993V174.339H481.625V62.6669H476.271L422.738 168.993Z" fill="url(#hlg1)"/>
      <path d="M631.098 147.015C631.098 140.283 633.577 134.442 638.534 129.492C643.491 124.542 649.339 122.067 656.081 122.067C662.822 122.067 668.671 124.542 673.628 129.492C678.585 134.442 681.063 140.283 681.063 147.015C681.063 153.747 678.585 159.588 673.628 164.538C668.671 169.488 662.822 171.963 656.081 171.963C649.339 171.963 643.491 169.488 638.534 164.538C633.577 159.588 631.098 153.747 631.098 147.015ZM579.35 123.849V170.181C579.35 197.901 586.091 218.988 599.573 233.442C613.254 247.896 632.09 255.123 656.081 255.123C680.072 255.123 698.809 247.896 712.291 233.442C725.971 218.988 732.812 197.901 732.812 170.181V123.849C732.812 96.9207 725.971 76.032 712.291 61.182C698.809 46.332 680.072 38.907 656.081 38.907C632.09 38.907 613.254 46.332 599.573 61.182C586.091 76.032 579.35 96.9207 579.35 123.849Z" fill="url(#hlg2)"/>
      <circle cx="656" cy="147" r="29.5" fill="#00FFFF" opacity=".9"/>
      <defs>
        <linearGradient id="hlg1" x1="87" y1="-61" x2="489" y2="329" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFFF"/><stop offset="1" stop-color="#0066FF"/></linearGradient>
        <linearGradient id="hlg2" x1="579" y1="39" x2="733" y2="255" gradientUnits="userSpaceOnUse"><stop stop-color="#00FFFF"/><stop offset="1" stop-color="#00A0A0"/></linearGradient>
      </defs>
    </svg>
  </div>

  <!-- Stats pills -->
  <div class="hstats">
    <div class="hstat">
      <span class="hstat-ic">‚ö°</span>
      <span class="hstat-val" id="hs-track">0m</span>
      <span class="hstat-lbl">activo</span>
    </div>
    <div class="hstat">
      <span class="hstat-ic">üò¥</span>
      <span class="hstat-val" id="hs-sleep">0m</span>
      <span class="hstat-lbl">sue√±o</span>
    </div>
    <div class="hstat" id="hs-timer-pill" style="display:none">
      <span class="hstat-ic">üî¥</span>
      <span class="hstat-val" id="hs-tname" style="max-width:70px;overflow:hidden;text-overflow:ellipsis"></span>
    </div>
  </div>

  <!-- Compact timer -->
  <div class="ht" id="ht">
    <div class="ht-dot"></div>
    <div class="ht-nm" id="htN">‚Äî</div>
    <div class="ht-t" id="htT">00:00</div>
    <button class="ht-stop" onclick="stopTimer()">‚èπ</button>
  </div>

  <button class="menu-btn" id="menuBtn" onclick="toggleDrawer()">
    <span></span><span></span><span></span>
  </button>
</header>

<!-- ‚ïê‚ïê MAIN APP ‚ïê‚ïê -->
<main class="main" id="mainApp" style="display:none">

  <!-- HOME PAGE -->
  <div class="page active" id="page-home">

    <!-- Progress bar -->
    <div class="prog-card">
      <div class="prog-top">
        <div class="prog-nums">
          <span class="prog-main" id="progMin">0</span>
          <span class="prog-of">/ 1440 min</span>
          <span class="prog-pct" id="progPct">0%</span>
        </div>
        <div class="prog-legend">
          <div class="pleg"><div class="pleg-dot" style="background:var(--cyan)"></div><span id="legT">0m</span></div>
          <div class="pleg"><div class="pleg-dot" style="background:var(--sleep)"></div><span id="legS">0m</span></div>
        </div>
      </div>
      <div class="prog-bar">
        <div class="ps-track" id="psT" style="width:0%"></div>
        <div class="ps-sleep" id="psS" style="width:0%"></div>
      </div>
    </div>

    <!-- Active timer banner -->
    <div class="tban" id="tBan">
      <div class="tban-row">
        <div class="tban-left">
          <div class="tban-dot"></div>
          <div>
            <div class="tban-name" id="tbN">‚Äî</div>
            <div class="tban-meta" id="tbM">‚Äî</div>
          </div>
        </div>
        <div class="tban-time" id="tbT">00:00:00</div>
      </div>
      <div class="tban-acts">
        <button class="btn btn-del btn-sm" onclick="stopTimer()">‚èπ Detener</button>
        <button class="btn btn-ghost btn-sm" onclick="switchAct()">üîÑ Cambiar</button>
      </div>
    </div>

    <!-- 60/40 split -->
    <div class="split">
      <div class="qt-card">
        <div class="qt-label">‚ö° Quick Track ‚Äî 1 click</div>
        <div class="qt-grid" id="qtG"></div>
      </div>
      <div class="rm-card" onclick="openM('manM')">
        <div class="rm-ic">üìù</div>
        <div class="rm-lbl">Registro<br>Manual</div>
        <div class="rm-sub">Tiempo pasado</div>
      </div>
    </div>

  </div><!-- /page-home -->

  <!-- TIMELINE PAGE -->
  <div class="page" id="page-tl">
    <div class="page-title">üìÖ Timeline</div>
    <div class="tl-reflect">
      <strong>üí≠ Reflexi√≥n</strong>
      "Si hoy fuera el √∫ltimo d√≠a de mi vida, ¬øestar√≠a orgulloso de lo que voy a hacer hoy?"
    </div>
    <div class="tl-head">
      <span id="tlTit" style="font-size:.88rem;font-weight:600">Hoy</span>
      <input type="date" id="tlDate" onchange="renderTL()"
        style="background:var(--bg2);border:1.5px solid var(--bdr);border-radius:7px;padding:.32rem .55rem;color:var(--t);font-family:inherit;font-size:.76rem">
    </div>
    <div class="tl-wrap" id="tlW"></div>
  </div>

  <!-- AREAS PAGE -->
  <div class="page" id="page-areas">
    <div class="page-title">
      üìÅ √Åreas & Proyectos
      <div style="margin-left:auto;display:flex;gap:.4rem">
        <button class="btn btn-ghost btn-sm" onclick="openNewArea()">+ √Årea</button>
        <button class="btn btn-sm" onclick="openNewProj()">+ Proyecto</button>
      </div>
    </div>
    <div class="areas-list" id="areasC"></div>
  </div>

  <!-- HISTORIAL PAGE -->
  <div class="page" id="page-hist">
    <div class="page-title">
      üìã Historial
      <div style="margin-left:auto;display:flex;gap:.4rem">
        <button class="btn btn-ghost btn-xs" onclick="exportCSV()">CSV</button>
        <button class="btn btn-ghost btn-xs" onclick="exportPDF()">PDF</button>
      </div>
    </div>
    <div class="hist-filters">
      <input class="hf-in" type="text" id="hSrch" placeholder="üîç Buscar..." oninput="renderHist()">
      <select class="hf-sel" id="hArea" onchange="renderHist()"><option value="">Todas las √°reas</option></select>
      <select class="hf-sel" id="hPer" onchange="renderHist()">
        <option value="today">Hoy</option>
        <option value="week">Esta semana</option>
        <option value="month">Este mes</option>
        <option value="all">Todo</option>
      </select>
    </div>
    <div id="histC"></div>
  </div>

  <!-- DASHBOARD PAGE -->
  <div class="page" id="page-dash">
    <div class="page-title">üìä Dashboard</div>
    <div class="dash-pie">
      <h4>Distribuci√≥n del d√≠a</h4>
      <div class="pie-layout">
        <div class="pie-wrap">
          <svg class="pie-svg" id="pieSvg" viewBox="0 0 100 100"></svg>
          <div class="pie-ctr"><div class="pie-pct" id="piePct">0%</div><div class="pie-sub">registrado</div></div>
        </div>
        <div class="pie-leg" id="pieLeg"></div>
      </div>
    </div>
    <div class="dash-stats">
      <div class="dstat"><h4>üò¥ Sue√±o promedio</h4><div class="dstat-v" id="dSleep">‚Äî</div><div class="dstat-s">√öltimos 7 d√≠as</div></div>
      <div class="dstat"><h4>üï≥ Vac√≠o hoy</h4><div class="dstat-v" id="dEmpty">‚Äî</div><div class="dstat-s">Sin registrar</div></div>
      <div class="dstat"><h4>‚ö° Activo hoy</h4><div class="dstat-v" id="dTrack">‚Äî</div><div class="dstat-s">Excluyendo sue√±o</div></div>
      <div class="dstat">
        <h4>‚öñÔ∏è Balance</h4>
        <div class="dstat-v" id="dBal">‚Äî</div>
        <div class="dstat-s" id="dBalS">% tiempo activo</div>
        <div style="font-size:.62rem;color:var(--t3);margin-top:.3rem;line-height:1.4">
          % que tu 1¬™ √°rea representa del tiempo activo total (sin sue√±o)</div>
      </div>
      <div class="dstat"><h4>üìÖ D√≠as trackeados</h4><div class="dstat-v" id="dDays">0</div><div class="dstat-s">Con registros</div></div>
      <div class="dstat"><h4>üî• Racha</h4><div class="dstat-v" id="dStreak">0</div><div class="dstat-s">D√≠as consecutivos</div></div>
    </div>
  </div>

</main>

<!-- ‚ïê‚ïê AREA MODAL ‚ïê‚ïê -->
<div class="overlay" id="areaM">
  <div class="modal">
    <div class="mhd"><h2 id="aMTit">Nueva √Årea</h2><button class="mclose" onclick="closeM('areaM')">√ó</button></div>
    <input type="hidden" id="aEId">
    <div class="fg"><label>Nombre</label><input type="text" id="aNm" placeholder="Trabajo, Salud..."></div>
    <div class="fg">
      <label>Emoji</label>
      <input type="text" id="aIc" placeholder="üíº" maxlength="2">
      <div class="emoji-grid" id="emojiG"></div>
    </div>
    <div class="fg"><label>Color</label><input type="color" id="aCl" value="#00ffff"></div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('areaM')">Cancelar</button>
      <button class="btn" onclick="saveArea()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PROJECT MODAL ‚ïê‚ïê -->
<div class="overlay" id="projM">
  <div class="modal">
    <div class="mhd"><h2 id="pMTit">Nuevo Proyecto</h2><button class="mclose" onclick="closeM('projM')">√ó</button></div>
    <input type="hidden" id="pEId">
    <div class="fg"><label>√Årea</label><select id="pAr"><option value="">Sin √°rea</option></select></div>
    <div class="fg"><label>Nombre</label><input type="text" id="pNm" placeholder="Cliente ABC..."></div>
    <div class="fg"><label>Color</label><input type="color" id="pCl" value="#0066ff"></div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('projM')">Cancelar</button>
      <button class="btn" onclick="saveProj()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MANUAL REGISTRO ‚ïê‚ïê -->
<div class="overlay" id="manM">
  <div class="modal">
    <div class="mhd"><h2>üìù Registro Manual</h2><button class="mclose" onclick="closeM('manM')">√ó</button></div>
    <div class="fg"><label>¬øQu√© hiciste?</label>
      <input type="text" id="mDes" placeholder="Describe la actividad..."></div>
    <div class="r2">
      <div class="fg"><label>√Årea</label><select id="mAr" onchange="updMPr()"><option value="">Sin √°rea</option></select></div>
      <div class="fg"><label>Proyecto</label><select id="mPr"><option value="">Sin proyecto</option></select></div>
    </div>
    <div class="fg">
      <label>Duraci√≥n ‚Äî <span id="durDisp" style="color:var(--cyan);font-family:'Space Mono',monospace">30 minutos</span></label>
      <div class="dur-tabs" id="durTabs">
        <div class="dtab" onclick="setDur(15)">15m</div>
        <div class="dtab sel" onclick="setDur(30)">30m</div>
        <div class="dtab" onclick="setDur(45)">45m</div>
        <div class="dtab" onclick="setDur(60)">1h</div>
        <div class="dtab" onclick="setDur(90)">1h30</div>
        <div class="dtab" onclick="setDur(120)">2h</div>
      </div>
      <input type="range" id="durSldr" min="5" max="240" step="5" value="30"
        oninput="onSldr(this.value)" style="margin:.3rem 0">
      <div class="slider-hints"><span>5m</span><span>1h</span><span>2h</span><span>4h</span></div>
    </div>
    <button class="btn btn-full" onclick="saveManual()" style="margin-top:.2rem">+ Registrar ahora</button>
  </div>
</div>

<!-- ‚ïê‚ïê EDIT ENTRY ‚ïê‚ïê -->
<div class="overlay" id="editM">
  <div class="modal">
    <div class="mhd"><h2>‚úèÔ∏è Editar</h2><button class="mclose" onclick="closeM('editM')">√ó</button></div>
    <input type="hidden" id="eId">
    <div class="fg"><label>Descripci√≥n</label><input type="text" id="eDes"></div>
    <div class="r2">
      <div class="fg"><label>√Årea</label><select id="eAr" onchange="updEPr()"><option value="">Sin √°rea</option></select></div>
      <div class="fg"><label>Proyecto</label><select id="ePr"><option value="">Sin proyecto</option></select></div>
    </div>
    <div class="fg"><label>Fecha</label><input type="date" id="eDt"></div>
    <div class="r2">
      <div class="fg"><label>Inicio</label><input type="time" id="eSt"></div>
      <div class="fg"><label>Fin</label><input type="time" id="eEn"></div>
    </div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('editM')">Cancelar</button>
      <button class="btn" onclick="updateReg()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SLEEP EDIT ‚ïê‚ïê -->
<div class="overlay" id="sleepEM">
  <div class="modal" style="max-width:360px">
    <div class="mhd"><h2>üò¥ Rutina de Sue√±o</h2><button class="mclose" onclick="closeM('sleepEM')">√ó</button></div>
    <div class="r2">
      <div class="fg"><label>üåô Duermo a:</label><input type="time" id="eSl"></div>
      <div class="fg"><label>‚òÄÔ∏è Despierto a:</label><input type="time" id="eWk"></div>
    </div>
    <div class="mbtns">
      <button class="btn btn-ghost" onclick="closeM('sleepEM')">Cancelar</button>
      <button class="btn btn-ok" onclick="updSleepR()">Guardar</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SB='https://ilzxgnqylmycktwsrfcr.supabase.co';
const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsenhnbnF5bG15Y2t0d3NyZmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTg0OTAsImV4cCI6MjA4NjMzNDQ5MH0.MkXUo8CjpH2QTUuLpoqA0LRHwTzC9p4WiFn1lFmk0d4';
const{createClient}=supabase;const sb=createClient(SB,SK);

let user=null,db={areas:[],projects:[],entries:[]};
let timerIv=null,timerStart=null;
let selDur=30;

// ‚îÄ‚îÄ TIMEZONE: always use browser locale ‚îÄ‚îÄ
function localDate(d){
  // Returns YYYY-MM-DD in local timezone
  if(!d)d=new Date();
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');
  return`${y}-${m}-${dd}`;
}
function today(){return localDate(new Date())}
function localISO(d){return d.toISOString()} // timestamps stored as UTC, displayed in local

// ‚îÄ‚îÄ EMOJIS ‚îÄ‚îÄ
const EMOJIS=['üíº','üíª','üì±','üéØ','üèãÔ∏è','‚ù§Ô∏è','üè†','üìö','üé®','üéµ','üå±','‚úàÔ∏è','üçé','üí°','üî¨','üéÆ','üí∞','ü§ù','üåç','‚ö°','üî•','üí™','üßò','üë®‚Äçüë©‚Äçüëß','üéì','üõ†Ô∏è','üìä','üåô','‚òÄÔ∏è','‚≠ê','üöÄ','üé≠','üçï','üé¨','üèÜ','ü¶Å'];
function buildEmoji(){
  document.getElementById('emojiG').innerHTML=EMOJIS.map(e=>
    `<div class="ep" onclick="pickE('${e}')" data-e="${e}">${e}</div>`).join('');
}
function pickE(e){
  document.getElementById('aIc').value=e;
  document.querySelectorAll('.ep').forEach(el=>el.classList.toggle('sel',el.dataset.e===e));
}

// ‚îÄ‚îÄ SOUNDS ‚îÄ‚îÄ
function beep(f=880,d=80,v=.25){
  try{
    const c=new(window.AudioContext||window.webkitAudioContext)();
    const o=c.createOscillator(),g=c.createGain();
    o.connect(g);g.connect(c.destination);
    o.frequency.value=f;o.type='sine';
    g.gain.setValueAtTime(v,c.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,c.currentTime+d/1000);
    o.start();o.stop(c.currentTime+d/1000);
    setTimeout(()=>c.close(),d+100);
  }catch(e){}
}

// ‚îÄ‚îÄ DRAWER ‚îÄ‚îÄ
function toggleDrawer(){
  const d=document.getElementById('drawer');
  const ov=document.getElementById('drOv');
  const btn=document.getElementById('menuBtn');
  const open=d.classList.contains('open');
  d.classList.toggle('open',!open);
  ov.classList.toggle('open',!open);
  btn.classList.toggle('open',!open);
}
function closeDrawer(){
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drOv').classList.remove('open');
  document.getElementById('menuBtn').classList.remove('open');
}

// ‚îÄ‚îÄ PAGE NAVIGATION ‚îÄ‚îÄ
function goPage(name,navId){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.dnav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if(navId)document.getElementById(navId)?.classList.add('active');
  if(name==='tl')renderTL();
  if(name==='dash')renderDash();
  if(name==='hist')renderHist();
  if(name==='areas')renderAreas();
  closeDrawer();
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function swLT(t){
  document.querySelectorAll('.ltab').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.lform').forEach(e=>e.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('lf-'+t).classList.add('active');
  document.getElementById(t==='login'?'l-u':'r-u').focus();
}
function pf(el,nid){if(el.value.length===1)document.getElementById(nid)?.focus()}
function getPin(p){return['1','2','3','4'].map(i=>document.getElementById(p+i).value).join('')}
function autoLg(){setTimeout(()=>{if(getPin('lp').length===4)doLogin()},80)}

async function doReg(){
  const u=document.getElementById('r-u').value.trim().toLowerCase();
  const pin=getPin('rp');
  if(!u)return smsg('rErr','Ingresa un usuario');
  if(pin.length!==4)return smsg('rErr','PIN de 4 d√≠gitos');
  if(!/^[a-z0-9_]{3,20}$/.test(u))return smsg('rErr','3-20 chars: letras, n√∫meros, _');
  setBL('rT','rS',true);
  try{
    const{data:ex}=await sb.from('users').select('id').eq('username',u).maybeSingle();
    if(ex)return smsg('rErr','Usuario ya en uso');
    const{data:nd,error}=await sb.from('users').insert([{username:u,pin}]).select().single();
    if(error)throw error;
    user=nd;smsg('rOk','¬°Cuenta creada!',true);
    setTimeout(()=>{clearPins('rp');document.getElementById('slOv').classList.add('open')},1200);
  }catch(e){smsg('rErr','Error: '+e.message)}
  finally{setBL('rT','rS',false)}
}

async function doLogin(){
  const u=document.getElementById('l-u').value.trim().toLowerCase();
  const pin=getPin('lp');
  if(!u)return smsg('lErr','Ingresa tu usuario');
  if(pin.length!==4)return smsg('lErr','PIN incompleto');
  setBL('lT','lS',true);
  try{
    const{data:ud}=await sb.from('users').select('*').eq('username',u).eq('pin',pin).maybeSingle();
    if(!ud){clearPins('lp');document.getElementById('lp1').focus();return smsg('lErr','Usuario o PIN incorrecto')}
    user=ud;await loadAll();launchApp();
    if(!ud.sleep_routine?.enabled)document.getElementById('slOv').classList.add('open');
    else await procSleep();
    if(ud.active_timer?.start){
      const t=ud.active_timer;
      timerStart=new Date(t.start);
      resumeTimerUI(t.name,t.meta,t);
    }
  }catch(e){smsg('lErr','Conexi√≥n fallida')}
  finally{setBL('lT','lS',false)}
}

function launchApp(){
  document.getElementById('lscr').style.display='none';
  document.getElementById('appHdr').style.display='flex';
  document.getElementById('mainApp').style.display='block';
  document.getElementById('tlDate').value=today();
  document.getElementById('drUser').textContent=user.username||'‚Äî';
  buildEmoji();loadMantra();renderAll();
}

function doLogout(){
  if(!confirm('¬øCerrar sesi√≥n?'))return;
  if(timerIv)clearInterval(timerIv);
  user=null;timerStart=null;db={areas:[],projects:[],entries:[]};
  document.getElementById('lscr').style.display='flex';
  document.getElementById('appHdr').style.display='none';
  document.getElementById('mainApp').style.display='none';
  closeDrawer();clearPins('lp');
  document.getElementById('l-u').focus();
}

// ‚îÄ‚îÄ SLEEP ‚îÄ‚îÄ
async function saveSleepSetup(){
  const st=document.getElementById('ss-sl').value,wt=document.getElementById('ss-wk').value;
  if(!st||!wt)return;
  await sb.from('users').update({sleep_routine:{enabled:true,sleep_time:st,wake_time:wt}}).eq('id',user.id);
  user.sleep_routine={enabled:true,sleep_time:st,wake_time:wt};
  document.getElementById('slOv').classList.remove('open');
  if(document.getElementById('mainApp').style.display==='none')launchApp();
  await procSleep();
}

async function procSleep(){
  if(!user?.sleep_routine?.enabled)return;
  const r=user.sleep_routine;
  const yest=new Date();yest.setDate(yest.getDate()-1);
  const yStr=localDate(yest);
  const{data:ex}=await sb.from('time_entries').select('id')
    .eq('user_id',user.id).eq('type','sleep').eq('date',yStr).maybeSingle();
  if(ex)return;
  // Build sleep times in local TZ
  const sleepStart=new Date(yStr+'T'+r.sleep_time+':00');
  const wakeEnd=new Date(today()+'T'+r.wake_time+':00');
  const{data:late}=await sb.from('time_entries').select('end_time')
    .eq('user_id',user.id).eq('type','tracked')
    .gte('end_time',sleepStart.toISOString())
    .order('end_time',{ascending:false}).limit(1);
  if(late&&late.length){
    const approx=new Date(new Date(late[0].end_time).getTime()+30*60000);
    document.getElementById('pop-sl').value=fmtTime(approx);
    document.getElementById('pop-wk').value=r.wake_time;
    document.getElementById('slPop').classList.add('open');
  }else{
    const dur=Math.floor((wakeEnd-sleepStart)/1000);
    if(dur>0&&dur<86400){
      const{data}=await sb.from('time_entries').insert([{
        user_id:user.id,type:'sleep',description:'Sue√±o',
        start_time:sleepStart.toISOString(),end_time:wakeEnd.toISOString(),
        duration:dur,date:yStr,auto_detected:true
      }]).select().single();
      if(data){db.entries.unshift(data);renderAll()}
    }
  }
}

async function saveSleepPop(){
  const yest=new Date();yest.setDate(yest.getDate()-1);
  const yStr=localDate(yest);
  const st=document.getElementById('pop-sl').value,wt=document.getElementById('pop-wk').value;
  if(!st||!wt)return;
  const start=new Date(yStr+'T'+st+':00'),end=new Date(today()+'T'+wt+':00');
  const dur=Math.floor((end-start)/1000);if(dur<=0)return;
  const{data}=await sb.from('time_entries').insert([{
    user_id:user.id,type:'sleep',description:'Sue√±o',
    start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,date:yStr
  }]).select().single();
  if(data)db.entries.unshift(data);
  closeEl('slPop');renderAll();
}

function openSleepEdit(){
  document.getElementById('eSl').value=user.sleep_routine?.sleep_time||'22:30';
  document.getElementById('eWk').value=user.sleep_routine?.wake_time||'07:00';
  openM('sleepEM');
}
async function updSleepR(){
  const st=document.getElementById('eSl').value,wt=document.getElementById('eWk').value;
  if(!st||!wt)return;
  await sb.from('users').update({sleep_routine:{enabled:true,sleep_time:st,wake_time:wt}}).eq('id',user.id);
  user.sleep_routine={enabled:true,sleep_time:st,wake_time:wt};
  closeM('sleepEM');renderAll();
}

async function editSleepEntry(id){
  const e=db.entries.find(x=>x.id===id);if(!e)return;
  const ns=prompt('Nueva hora de inicio (HH:MM):',fmtLocalTime(e.start_time));if(!ns)return;
  const ne=prompt('Nueva hora de fin (HH:MM):',fmtLocalTime(e.end_time));if(!ne)return;
  const start=new Date(e.date+'T'+ns+':00'),end=new Date(e.date+'T'+ne+':00');
  let dur=Math.floor((end-start)/1000);
  if(dur<=0)dur=Math.floor((end.getTime()+86400000-start.getTime())/1000);
  await sb.from('time_entries').update({
    start_time:start.toISOString(),end_time:end.toISOString(),duration:dur}).eq('id',id);
  const i=db.entries.findIndex(x=>x.id===id);
  if(i>-1)db.entries[i]={...db.entries[i],start_time:start.toISOString(),end_time:end.toISOString(),duration:dur};
  renderAll();
}

// ‚îÄ‚îÄ MANTRA ‚îÄ‚îÄ
function loadMantra(){
  const v=localStorage.getItem('1440_m_'+(user?.id||'x'))||'';
  const el=document.getElementById('drMantra');
  el.textContent=v||'Toca para escribir tu mantra...';
  el.className=v?'da':'dph';
}
function saveMantra(){
  const v=document.getElementById('manIn').value.trim();
  if(v)localStorage.setItem('1440_m_'+(user?.id||'x'),v);
  loadMantra();closeM('mantraM');
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
async function loadAll(){
  const[a,p,e]=await Promise.all([
    sb.from('categories').select('*').eq('user_id',user.id).order('created_at'),
    sb.from('projects').select('*').eq('user_id',user.id).order('created_at'),
    sb.from('time_entries').select('*').eq('user_id',user.id).order('start_time',{ascending:false}).limit(600)
  ]);
  db.areas=a.data||[];db.projects=p.data||[];db.entries=e.data||[];
}
function renderAll(){updProg();renderQT();updHStats();updSelects()}

// ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ
function updProg(){
  const dayE=db.entries.filter(e=>e.date===today());
  const tM=dayE.filter(e=>e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  const sM=dayE.filter(e=>e.type==='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  const tot=tM+sM;
  document.getElementById('progMin').textContent=tot;
  document.getElementById('progPct').textContent=Math.floor((tot/1440)*100)+'%';
  document.getElementById('psT').style.width=Math.min((tM/1440)*100,100)+'%';
  document.getElementById('psS').style.width=Math.min((sM/1440)*100,Math.max(0,100-(tM/1440)*100))+'%';
  document.getElementById('legT').textContent=fmtM(tM);
  document.getElementById('legS').textContent=fmtM(sM);
  document.getElementById('hs-track').textContent=fmtM(tM);
  document.getElementById('hs-sleep').textContent=fmtM(sM);
}
function updHStats(){
  const tM=db.entries.filter(e=>e.date===today()&&e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  const sM=db.entries.filter(e=>e.date===today()&&e.type==='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  document.getElementById('hs-track').textContent=fmtM(tM);
  document.getElementById('hs-sleep').textContent=fmtM(sM);
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function resumeTimerUI(name,meta,t){
  document.getElementById('tBan').classList.add('on');
  document.getElementById('tbN').textContent=name;
  document.getElementById('tbM').textContent=meta||'';
  document.getElementById('ht').classList.add('on');
  document.getElementById('htN').textContent=name;
  document.getElementById('hs-tname').textContent=name;
  document.getElementById('hs-timer-pill').style.display='flex';
  if(timerIv)clearInterval(timerIv);
  timerIv=setInterval(()=>{
    const el=Math.floor((Date.now()-timerStart.getTime())/1000);
    document.getElementById('tbT').textContent=fmtS(el);
    const hm=`${String(Math.floor(el/3600)).padStart(2,'0')}:${String(Math.floor((el%3600)/60)).padStart(2,'0')}`;
    document.getElementById('htT').textContent=hm;
  },1000);
  renderQT();
}

async function startTimer(id,type,name,meta){
  if(timerIv)clearInterval(timerIv);
  timerStart=new Date();
  beep(880,70,.2);setTimeout(()=>beep(1100,70,.15),90);
  const t={id,type,name,meta,start:timerStart.toISOString()};
  user.active_timer=t;
  await sb.from('users').update({active_timer:t}).eq('id',user.id);
  resumeTimerUI(name,meta,t);
}

async function stopTimer(){
  if(!timerStart)return;
  if(timerIv){clearInterval(timerIv);timerIv=null}
  beep(440,120,.18);
  const end=new Date(),dur=Math.floor((end-timerStart)/1000);
  const t=user.active_timer||{};
  if(dur>5){
    const pl={user_id:user.id,type:'tracked',description:t.name||'Actividad',
      start_time:timerStart.toISOString(),end_time:end.toISOString(),
      duration:dur,date:localDate(timerStart)}; // use START date for cross-midnight
    if(t.type==='project')pl.project_id=t.id;
    if(t.type==='area')pl.category_id=t.id;
    const{data}=await sb.from('time_entries').insert([pl]).select().single();
    if(data)db.entries.unshift(data);
  }
  user.active_timer=null;
  await sb.from('users').update({active_timer:null}).eq('id',user.id);
  timerStart=null;
  document.getElementById('tBan').classList.remove('on');
  document.getElementById('ht').classList.remove('on');
  document.getElementById('hs-timer-pill').style.display='none';
  renderAll();updProg();
}

function switchAct(){stopTimer();document.getElementById('qtG').scrollIntoView({behavior:'smooth',block:'center'})}

// ‚îÄ‚îÄ QUICK TRACK ‚îÄ‚îÄ
function renderQT(){
  const g=document.getElementById('qtG');
  const items=[
    ...db.areas.map(a=>({id:a.id,type:'area',name:a.name,icon:a.icon||'üìÅ',color:a.color,sub:'√Årea'})),
    ...db.projects.map(p=>{
      const ar=db.areas.find(a=>a.id===p.category_id);
      return{id:p.id,type:'project',name:p.name,icon:ar?.icon||'üìå',color:p.color,sub:ar?.name||'Proyecto'};
    })
  ].slice(0,8);
  if(!items.length){
    g.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:.9rem;color:var(--t3);font-size:.76rem">
      <button class="btn btn-sm" style="margin-top:.3rem" onclick="openNewArea()">‚ûï Crear √Årea</button></div>`;
    return;
  }
  const active=user?.active_timer;
  g.innerHTML=items.map(it=>{
    const on=active&&active.id===it.id;
    const m=db.entries.filter(e=>e.date===today()&&(e.category_id===it.id||e.project_id===it.id)).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    return`<div class="qt-item${on?' on':''}" style="${it.color?'border-color:'+it.color+'35':''}"
      onclick="${on?'stopTimer()':'startTimer(\''+it.id+'\',\''+it.type+'\',\''+esc(it.name)+'\',\''+esc(it.sub)+'\')'}" >
      <div><div class="qt-nm">${it.icon} ${it.name}</div><div class="qt-st">${fmtM(m)}</div></div>
      <div class="qt-play" style="${!on&&it.color?'background:linear-gradient(135deg,'+it.color+','+it.color+'99)':''}">${on?'‚èπ':'‚ñ∂'}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ TIMELINE ‚îÄ‚îÄ
function renderTL(){
  const ds=document.getElementById('tlDate').value||today();
  document.getElementById('tlTit').textContent=ds===today()?'Hoy ‚Äî '+fmtDay(ds):fmtDay(ds);
  const dayE=db.entries.filter(e=>e.date===ds);
  const r=user?.sleep_routine;
  let html='';
  for(let h=0;h<24;h++){
    const lbl=String(h).padStart(2,'0')+':00';
    let isSl=false;
    if(r?.enabled){
      const sh=parseInt(r.sleep_time?.split(':')[0]||22);
      const wh=parseInt(r.wake_time?.split(':')[0]||7);
      isSl=sh>wh?(h>=sh||h<wh):(h>=sh&&h<wh);
    }
    const inH=dayE.filter(e=>{
      if(!e.start_time||!e.end_time)return false;
      const s=new Date(e.start_time).getHours(),en=new Date(e.end_time).getHours();
      return h>=s&&h<=en;
    });
    let inner='';
    if(inH.length){
      inner=inH.map(e=>{
        const cls=e.type==='sleep'?'tl-sleep':'tl-tracked';
        const pj=db.projects.find(p=>p.id===e.project_id);
        const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
        const lbl2=e.description+(pj?' ¬∑ '+pj.name:'');
        const sleepBtn=e.type==='sleep'?`<button class="sl-edit" onclick="event.stopPropagation();editSleepEntry('${e.id}')">‚úèÔ∏è</button>`:'';
        return`<div class="tl-e ${cls}" onclick="${e.type!=='sleep'?'openEditE(\''+e.id+'\')':''}">
          ${e.type==='sleep'?'üò¥ ':(ar?.icon?ar.icon+' ':'')}${lbl2}${sleepBtn}
          <span class="tl-dur">${fmtS(e.duration)}</span>
        </div>`;
      }).join('');
    }else if(isSl&&ds===today()){
      inner=`<div class="tl-e tl-sleep">üò¥ ${r.sleep_time}‚Äì${r.wake_time}</div>`;
    }else{
      inner=`<div class="tl-e tl-gap">‚Äî</div>`;
    }
    html+=`<div class="tl-row">
      <div class="tl-lbl">${lbl}</div>
      <div class="tl-col">${inner}<button class="tl-add" onclick="openManualAt(${h})">+</button></div>
    </div>`;
  }
  const w=document.getElementById('tlW');
  w.innerHTML=html;
  if(ds===today()){
    const ch=new Date().getHours();
    const rows=w.querySelectorAll('.tl-row');
    if(rows[Math.max(0,ch-1)])requestAnimationFrame(()=>rows[Math.max(0,ch-1)].scrollIntoView({block:'center'}));
  }
}

function openManualAt(h){
  // Pre-fill time: use the selected date + given hour
  const ds=document.getElementById('tlDate').value||today();
  openM('manM');
  // Note: in simplified modal we don't have time picker but we note the context
}

// ‚îÄ‚îÄ AREAS ‚îÄ‚îÄ
function renderAreas(){
  const c=document.getElementById('areasC');
  if(!db.areas.length){
    c.innerHTML=`<div class="empty"><div class="empty-ic">üìÅ</div>
      <h3>Sin √°reas</h3><p>Crea tu primera √°rea de vida</p><br>
      <button class="btn btn-sm" onclick="openNewArea()">‚ûï Nueva √Årea</button></div>`;
    return;
  }
  c.innerHTML=db.areas.map((a,i)=>{
    const pjs=db.projects.filter(p=>p.category_id===a.id);
    const tm=db.entries.filter(e=>e.category_id===a.id||db.projects.find(p=>p.id===e.project_id)?.category_id===a.id).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const col=a.color||'#00ffff';
    return`<div class="area-card" style="border-color:${col}20">
      <div class="area-head" onclick="togA('ab${i}','ac${i}')">
        <div class="area-left">
          <div class="area-stripe" style="background:${col}"></div>
          <span class="area-ic">${a.icon||'üìÅ'}</span>
          <div><div class="area-nm">${a.name}</div><div class="area-cnt">${pjs.length} proyectos</div></div>
        </div>
        <div class="area-right">
          <span class="area-tot" style="color:${col}">${fmtM(tm)}</span>
          <div class="ibtn" onclick="event.stopPropagation();openEditArea('${a.id}')">‚úèÔ∏è</div>
          <div class="ibtn del" onclick="event.stopPropagation();delArea('${a.id}')">üóëÔ∏è</div>
          <span class="area-chev" id="ac${i}">‚ñ∂</span>
        </div>
      </div>
      <div class="area-body" id="ab${i}">
        <div class="proj-stack">${pjs.map(p=>projRow(p)).join('')}</div>
        <div style="margin-top:.5rem">
          <button class="btn btn-ghost btn-sm" onclick="openNewProjFor('${a.id}')">+ Proyecto</button>
        </div>
      </div>
    </div>`;
  }).join('');
  const uncat=db.projects.filter(p=>!p.category_id);
  if(uncat.length){
    c.innerHTML+=`<div class="area-card">
      <div class="area-head" onclick="togA('ab-u','ac-u')">
        <div class="area-left">
          <div class="area-stripe" style="background:#5580b3"></div>
          <span class="area-ic">üìå</span>
          <div><div class="area-nm">Sin √Årea</div><div class="area-cnt">${uncat.length}</div></div>
        </div>
        <div class="area-right"><span class="area-chev" id="ac-u">‚ñ∂</span></div>
      </div>
      <div class="area-body" id="ab-u"><div class="proj-stack">${uncat.map(p=>projRow(p)).join('')}</div></div>
    </div>`;
  }
}

function projRow(p){
  const m=db.entries.filter(e=>e.project_id===p.id).reduce((s,e)=>s+Math.floor(e.duration/60),0);
  return`<div class="proj-row">
    <div class="proj-dot" style="background:${p.color}"></div>
    <div class="proj-inf">
      <div class="proj-nm">${p.name}</div>
      <div class="proj-st">${fmtM(m)}</div>
    </div>
    <div class="proj-acts">
      <div class="ibtn" onclick="startTimer('${p.id}','project','${esc(p.name)}','Proyecto')">‚ñ∂</div>
      <div class="ibtn" onclick="openEditProj('${p.id}')">‚úèÔ∏è</div>
      <div class="ibtn del" onclick="delProj('${p.id}')">üóëÔ∏è</div>
    </div>
  </div>`;
}

function togA(bid,cid){
  const b=document.getElementById(bid),c=document.getElementById(cid);
  if(!b)return;const op=b.classList.contains('open');
  b.classList.toggle('open',!op);if(c)c.classList.toggle('open',!op);
}

// ‚îÄ‚îÄ HISTORIAL agrupado por d√≠a ‚îÄ‚îÄ
function renderHist(){
  const c=document.getElementById('histC');
  let f=[...db.entries];
  const q=document.getElementById('hSrch').value.toLowerCase();
  if(q)f=f.filter(e=>e.description?.toLowerCase().includes(q));
  const af=document.getElementById('hArea').value;
  if(af){const ps=db.projects.filter(p=>p.category_id===af).map(p=>p.id);f=f.filter(e=>e.category_id===af||ps.includes(e.project_id))}
  const per=document.getElementById('hPer').value;
  const n=new Date(),t=new Date(n.getFullYear(),n.getMonth(),n.getDate());
  if(per==='today')f=f.filter(e=>e.date===today());
  else if(per==='week'){const w=new Date(t);w.setDate(w.getDate()-7);f=f.filter(e=>new Date(e.date+'T12:00:00')>=w)}
  else if(per==='month'){const m=new Date(t);m.setMonth(m.getMonth()-1);f=f.filter(e=>new Date(e.date+'T12:00:00')>=m)}
  if(!f.length){c.innerHTML=`<div class="empty"><div class="empty-ic">üìã</div><h3>Sin registros</h3><p>Usa Quick Track o Registro Manual</p></div>`;return}

  // Group by date
  const grouped={};
  f.forEach(e=>{
    if(!grouped[e.date])grouped[e.date]=[];
    grouped[e.date].push(e);
  });
  const dates=Object.keys(grouped).sort((a,b)=>b.localeCompare(a));

  c.innerHTML=dates.map((date,di)=>{
    const entries=grouped[date];
    const totalM=entries.reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const cnt=entries.length;
    const isToday=date===today();
    const dayLbl=isToday?'Hoy':fmtDay(date);
    const rows=entries.map(e=>{
      const pj=db.projects.find(p=>p.id===e.project_id);
      const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
      const col=ar?.color||e.type==='sleep'?'#6366f1':'#00ffff';
      return`<div class="reg-item">
        <div class="reg-color" style="background:${col}"></div>
        <div class="reg-body">
          <div class="reg-desc">${e.description}</div>
          <div class="reg-meta">
            <span>${fmtLocalTime(e.start_time)}‚Äì${fmtLocalTime(e.end_time)}</span>
            ${ar?`<span class="badge" style="border-color:${ar.color}40">${ar.icon||''} ${ar.name}</span>`:''}
            ${e.type==='sleep'?`<span class="badge badge-sl">üò¥</span>`:''}
          </div>
        </div>
        <div class="reg-dur-s">${fmtS(e.duration)}</div>
        <div class="reg-acts">
          ${e.type!=='sleep'?`<div class="ibtn" onclick="openEditE('${e.id}')">‚úèÔ∏è</div>`:''}
          <div class="ibtn del" onclick="delEntry('${e.id}')">üóëÔ∏è</div>
        </div>
      </div>`;
    }).join('');

    return`<div class="day-group">
      <div class="day-head" onclick="togDay('dy${di}','dc${di}')">
        <div class="day-date">
          ${isToday?'üìÖ':'üìÜ'} ${dayLbl}
        </div>
        <div class="day-stats">
          <span class="day-dur">${fmtM(totalM)}</span>
          <span class="day-cnt">${cnt}</span>
          <span class="day-chev${isToday?' open':''}" id="dc${di}">‚ñ∂</span>
        </div>
      </div>
      <div class="day-entries${isToday?' open':''}" id="dy${di}">${rows}</div>
    </div>`;
  }).join('');
}

function togDay(bid,cid){
  const b=document.getElementById(bid),c=document.getElementById(cid);
  if(!b)return;const op=b.classList.contains('open');
  b.classList.toggle('open',!op);if(c)c.classList.toggle('open',!op);
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDash(){
  const dayE=db.entries.filter(e=>e.date===today());
  const bk={};let tot=0;
  dayE.forEach(e=>{
    const m=Math.floor(e.duration/60);tot+=m;
    if(e.type==='sleep'){bk['üò¥ Sue√±o']=(bk['üò¥ Sue√±o']||0)+m;return}
    const pj=db.projects.find(p=>p.id===e.project_id);
    const ar=db.areas.find(a=>a.id===e.category_id||a.id===pj?.category_id);
    const lbl=ar?(ar.icon||'')+' '+ar.name:'Sin √°rea';
    bk[lbl]=(bk[lbl]||0)+m;
  });
  const empty=1440-tot;if(empty>0)bk['‚¨õ Vac√≠o']=empty;
  const C=['#00ffff','#6366f1','#0066ff','#00ff88','#ff3366','#ffaa00','#8b5cf6','#374151'];
  let ang=0,paths='',leg='';
  Object.entries(bk).forEach(([lbl,m],i)=>{
    const pc=m/1440,sa=ang;ang+=pc*360;
    const r=40,cx=50,cy=50,ir=22;
    const a1=sa*Math.PI/180-Math.PI/2,a2=ang*Math.PI/180-Math.PI/2;
    const x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
    const x2=cx+r*Math.cos(a2),y2=cy+r*Math.sin(a2);
    const xi1=cx+ir*Math.cos(a1),yi1=cy+ir*Math.sin(a1);
    const xi2=cx+ir*Math.cos(a2),yi2=cy+ir*Math.sin(a2);
    const lg=pc>.5?1:0,col=C[i%C.length];
    paths+=`<path d="M${xi1} ${yi1} L${x1} ${y1} A${r} ${r} 0 ${lg} 1 ${x2} ${y2} L${xi2} ${yi2} A${ir} ${ir} 0 ${lg} 0 ${xi1} ${yi1} Z" fill="${col}" opacity=".88"/>`;
    leg+=`<div class="leg-item"><div class="leg-dot" style="background:${col}"></div><span>${lbl}</span><span class="leg-val">${fmtM(m)}</span></div>`;
  });
  document.getElementById('pieSvg').innerHTML=paths;
  document.getElementById('pieLeg').innerHTML=leg;
  document.getElementById('piePct').textContent=Math.floor((tot/1440)*100)+'%';
  const w=new Date();w.setDate(w.getDate()-7);
  const sE=db.entries.filter(e=>e.type==='sleep'&&new Date(e.date+'T12:00:00')>=w);
  document.getElementById('dSleep').textContent=fmtM(Math.round(sE.length?sE.reduce((s,e)=>s+e.duration,0)/sE.length/60:0));
  document.getElementById('dEmpty').textContent=fmtM(1440-tot);
  const trNS=dayE.filter(e=>e.type!=='sleep').reduce((s,e)=>s+Math.floor(e.duration/60),0);
  document.getElementById('dTrack').textContent=fmtM(trNS);
  if(db.areas.length){
    const a1=db.areas[0],ps=db.projects.filter(p=>p.category_id===a1.id).map(p=>p.id);
    const a1m=dayE.filter(e=>e.type!=='sleep'&&(e.category_id===a1.id||ps.includes(e.project_id))).reduce((s,e)=>s+Math.floor(e.duration/60),0);
    const pct=trNS?Math.round((a1m/trNS)*100):0;
    document.getElementById('dBal').textContent=`${a1.icon||''} ${pct}%`;
    document.getElementById('dBalS').textContent=`${a1.name} del tiempo activo`;
  }
  const uDays=new Set(db.entries.filter(e=>e.type!=='sleep').map(e=>e.date)).size;
  document.getElementById('dDays').textContent=uDays;
  let streak=0,d=new Date();
  for(let i=0;i<365;i++){
    const ds=localDate(d);
    if(db.entries.some(e=>e.date===ds&&e.type!=='sleep')){streak++;d.setDate(d.getDate()-1)}else break;
  }
  document.getElementById('dStreak').textContent=streak;
}

// ‚îÄ‚îÄ SELECTS ‚îÄ‚îÄ
function updSelects(){
  const opts='<option value="">Sin √°rea</option>'+db.areas.map(a=>`<option value="${a.id}">${a.icon||''} ${a.name}</option>`).join('');
  ['pAr','mAr','eAr','hArea'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const v=el.value;el.innerHTML=opts;el.value=v;
  });
  updMPr();updEPr();
}
function updMPr(){const aid=document.getElementById('mAr')?.value;const ps=aid?db.projects.filter(p=>p.category_id===aid):db.projects;document.getElementById('mPr').innerHTML='<option value="">Sin proyecto</option>'+ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}
function updEPr(){const aid=document.getElementById('eAr')?.value;const ps=aid?db.projects.filter(p=>p.category_id===aid):db.projects;document.getElementById('ePr').innerHTML='<option value="">Sin proyecto</option>'+ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}

// ‚îÄ‚îÄ AREA CRUD ‚îÄ‚îÄ
function openNewArea(){document.getElementById('aEId').value='';document.getElementById('aMTit').textContent='Nueva √Årea';document.getElementById('aNm').value='';document.getElementById('aIc').value='';buildEmoji();openM('areaM')}
function openEditArea(id){
  const a=db.areas.find(x=>x.id===id);if(!a)return;
  document.getElementById('aEId').value=id;document.getElementById('aMTit').textContent='Editar √Årea';
  document.getElementById('aNm').value=a.name;document.getElementById('aIc').value=a.icon||'';
  document.getElementById('aCl').value=a.color||'#00ffff';buildEmoji();
  setTimeout(()=>document.querySelectorAll('.ep').forEach(el=>el.classList.toggle('sel',el.dataset.e===a.icon)),50);
  openM('areaM');
}
async function saveArea(){
  const nm=document.getElementById('aNm').value.trim();if(!nm)return alert('Nombre requerido');
  const eid=document.getElementById('aEId').value;
  const pl={name:nm,icon:document.getElementById('aIc').value||'üìÅ',color:document.getElementById('aCl').value};
  if(eid){await sb.from('categories').update(pl).eq('id',eid);const i=db.areas.findIndex(a=>a.id===eid);if(i>-1)db.areas[i]={...db.areas[i],...pl}}
  else{const{data,e}=await sb.from('categories').insert([{user_id:user.id,...pl}]).select().single();if(e)return alert(e.message);db.areas.push(data)}
  closeM('areaM');renderAll();renderAreas();
}
async function delArea(id){
  if(!confirm('¬øEliminar √°rea?'))return;
  await sb.from('categories').delete().eq('id',id);
  db.areas=db.areas.filter(a=>a.id!==id);db.projects=db.projects.filter(p=>p.category_id!==id);renderAll();renderAreas();
}

// ‚îÄ‚îÄ PROJECT CRUD ‚îÄ‚îÄ
function openNewProj(){document.getElementById('pEId').value='';document.getElementById('pMTit').textContent='Nuevo Proyecto';document.getElementById('pNm').value='';updSelects();openM('projM')}
function openNewProjFor(aid){openNewProj();setTimeout(()=>document.getElementById('pAr').value=aid,60)}
function openEditProj(id){
  const p=db.projects.find(x=>x.id===id);if(!p)return;
  document.getElementById('pEId').value=id;document.getElementById('pMTit').textContent='Editar Proyecto';
  document.getElementById('pNm').value=p.name;document.getElementById('pCl').value=p.color||'#0066ff';
  updSelects();setTimeout(()=>document.getElementById('pAr').value=p.category_id||'',60);openM('projM');
}
async function saveProj(){
  const nm=document.getElementById('pNm').value.trim();if(!nm)return alert('Nombre requerido');
  const eid=document.getElementById('pEId').value;
  const pl={name:nm,category_id:document.getElementById('pAr').value||null,color:document.getElementById('pCl').value};
  if(eid){await sb.from('projects').update(pl).eq('id',eid);const i=db.projects.findIndex(p=>p.id===eid);if(i>-1)db.projects[i]={...db.projects[i],...pl}}
  else{const{data,e}=await sb.from('projects').insert([{user_id:user.id,...pl}]).select().single();if(e)return alert(e.message);db.projects.push(data)}
  closeM('projM');renderAll();renderAreas();
}
async function delProj(id){
  if(!confirm('¬øEliminar?'))return;
  await sb.from('projects').delete().eq('id',id);
  db.projects=db.projects.filter(p=>p.id!==id);renderAll();renderAreas();
}

// ‚îÄ‚îÄ MANUAL ‚îÄ‚îÄ
function setDur(v){
  selDur=v;document.getElementById('durSldr').value=v;updDurUI(v);
  document.querySelectorAll('.dtab').forEach(el=>el.classList.remove('sel'));
  const map={15:0,30:1,45:2,60:3,90:4,120:5};
  if(map[v]!==undefined)document.querySelectorAll('.dtab')[map[v]].classList.add('sel');
}
function onSldr(v){selDur=parseInt(v);updDurUI(v);document.querySelectorAll('.dtab').forEach(el=>el.classList.remove('sel'));const map={15:0,30:1,45:2,60:3,90:4,120:5};if(map[v]!==undefined)document.querySelectorAll('.dtab')[map[v]].classList.add('sel')}
function updDurUI(v){
  v=parseInt(v);const h=Math.floor(v/60),m=v%60;
  document.getElementById('durDisp').textContent=h>0?(m>0?`${h}h ${m}min`:`${h}h`):v+' min';
}

async function saveManual(){
  const desc=document.getElementById('mDes').value.trim();
  if(!desc)return alert('Describe la actividad');
  const now=new Date();
  const end=now;
  const start=new Date(end.getTime()-selDur*60000);
  // Use start time for date (handles cross-midnight correctly)
  const date=localDate(start);
  const{data,error}=await sb.from('time_entries').insert([{
    user_id:user.id,type:'tracked',description:desc,
    project_id:document.getElementById('mPr').value||null,
    category_id:document.getElementById('mAr').value||null,
    start_time:start.toISOString(),end_time:end.toISOString(),
    duration:selDur*60,date
  }]).select().single();
  if(error)return alert('Error: '+error.message);
  db.entries.unshift(data);closeM('manM');
  document.getElementById('mDes').value='';renderAll();
}

// ‚îÄ‚îÄ EDIT/DELETE ENTRY ‚îÄ‚îÄ
function openEditE(id){
  const e=db.entries.find(x=>x.id===id);if(!e||e.type==='sleep')return;
  document.getElementById('eId').value=id;
  document.getElementById('eDes').value=e.description;
  document.getElementById('eDt').value=e.date;
  document.getElementById('eSt').value=fmtLocalTime(e.start_time);
  document.getElementById('eEn').value=fmtLocalTime(e.end_time);
  updSelects();
  setTimeout(()=>{document.getElementById('eAr').value=e.category_id||'';updEPr();setTimeout(()=>document.getElementById('ePr').value=e.project_id||'',60)},60);
  openM('editM');
}
async function updateReg(){
  const id=document.getElementById('eId').value;
  const desc=document.getElementById('eDes').value.trim();
  const date=document.getElementById('eDt').value;
  const st=document.getElementById('eSt').value,et=document.getElementById('eEn').value;
  if(!desc||!date||!st||!et)return alert('Completa todos los campos');
  const start=new Date(date+'T'+st+':00'),end=new Date(date+'T'+et+':00');
  const dur=Math.floor((end-start)/1000);if(dur<=0)return alert('El fin debe ser posterior');
  const upd={description:desc,date,start_time:start.toISOString(),end_time:end.toISOString(),duration:dur,
    project_id:document.getElementById('ePr').value||null,category_id:document.getElementById('eAr').value||null};
  await sb.from('time_entries').update(upd).eq('id',id);
  const i=db.entries.findIndex(e=>e.id===id);if(i>-1)db.entries[i]={...db.entries[i],...upd};
  closeM('editM');renderAll();
}
async function delEntry(id){
  if(!confirm('¬øEliminar?'))return;
  await sb.from('time_entries').delete().eq('id',id);
  db.entries=db.entries.filter(e=>e.id!==id);renderAll();renderHist();
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportCSV(){
  const rows=db.entries.map(e=>{
    const p=db.projects.find(x=>x.id===e.project_id);
    const a=db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);
    return[e.date,`"${e.description}"`,a?.name||'',p?.name||'',fmtLocalTime(e.start_time),fmtLocalTime(e.end_time),(e.duration/3600).toFixed(2),e.type].join(',');
  });
  dlF('Fecha,Descripci√≥n,√Årea,Proyecto,Inicio,Fin,Horas,Tipo\n'+rows.join('\n'),'1440-'+today()+'.csv','text/csv');
}
function exportPDF(){
  try{
    const{jsPDF}=window.jspdf;const doc=new jsPDF();
    doc.setFontSize(16);doc.text('1440 ‚Äî Reporte',20,18);
    doc.setFontSize(8);doc.text(new Date().toLocaleDateString('es'),20,25);
    let y=34;
    db.entries.forEach(e=>{
      if(y>275){doc.addPage();y=18}
      const p=db.projects.find(x=>x.id===e.project_id);
      const a=db.areas.find(x=>x.id===e.category_id||x.id===p?.category_id);
      doc.setFontSize(8.5);doc.text(`${e.date}  ${e.description}  [${fmtS(e.duration)}]`,20,y);y+=4;
      doc.setFontSize(7);doc.text(`${a?.name||'‚Äî'} ‚Ä∫ ${p?.name||'‚Äî'}  ${fmtLocalTime(e.start_time)}‚Äì${fmtLocalTime(e.end_time)}`,24,y);y+=5;
    });
    doc.save('1440-'+today()+'.pdf');
  }catch(e){alert('Error PDF')}
}
function dlF(c,n,m){const b=new Blob([c],{type:m});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click()}

// ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ
function openM(id){
  if(id==='manM'){updSelects();setDur(30)}
  if(id==='projM')updSelects();
  if(id==='mantraM')document.getElementById('manIn').value=localStorage.getItem('1440_m_'+(user?.id||'x'))||'';
  document.getElementById(id).classList.add('open');
}
function closeM(id){document.getElementById(id).classList.remove('open')}
function closeEl(id){document.getElementById(id).classList.remove('open')}
document.addEventListener('click',e=>{
  const ov=e.target.closest('.overlay');
  if(ov&&e.target===ov)closeM(ov.id);
});

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function fmtS(s){s=s||0;const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60;return`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sc).padStart(2,'0')}`}
function fmtM(m){m=Math.max(0,Math.floor(m||0));return`${Math.floor(m/60)}h ${String(m%60).padStart(2,'0')}m`}
function fmtLocalTime(iso){try{return new Date(iso).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}catch{return'--:--'}}
function fmtTime(d){return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}
function fmtDay(d){try{return new Date(d+'T12:00:00').toLocaleDateString([],{weekday:'short',day:'numeric',month:'short'})}catch{return d}}
function esc(s){return(s||'').replace(/'/g,"\\'")}
function smsg(id,txt,ok=false){const el=document.getElementById(id);if(!el)return;el.textContent=txt;el.className='fmsg '+(ok?'ok':'err');el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),3500)}
function setBL(t,s,l){document.getElementById(t).classList.toggle('hidden',l);document.getElementById(s).classList.toggle('hidden',!l)}
function clearPins(p){['1','2','3','4'].forEach(i=>{const el=document.getElementById(p+i);if(el)el.value=''})}

document.getElementById('l-u').focus();
</script>
</body>
</html>
